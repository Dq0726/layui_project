<div class="layui-form" lay-filter="zkmes-productionmgmt-pmr-form" style="padding: 10px 30px 0 0">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">领料订单</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="outboundorderId"
            name="outboundorderId"
            placeholder="请输入"
            value="{{ d.params.outboundorderId || '' }}"
            lay-verify="required"
            autocomplete="off"
            readonly
            class="layui-input"
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">预计领料时间</label>
      <div class="layui-input-inline">
        <input
          type="text"
          id="ID-laydate-begintime"
          placeholder="请输入"
          name="begintime"
          autocomplete="off"
          class="layui-input"
          lay-verify="required"
        />
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">领料仓库</label>
      <div class="layui-input-inline">
        <div id="pmrWarehouseXmselect" class="xm-select-demo"></div>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label">备注</label>
    <div class="layui-input-block">
      <script type="text/html" template>
        <input
          type="text"
          name="remark"
          placeholder="请输入"
          value="{{ d.params.remark || '' }}"
          autocomplete="off"
          class="layui-input"
        />
      </script>
    </div>
  </div>

  <div class="layui-form-item">
    <table id="zkmes-productionmgmt-pmr-form-table" lay-filter="zkmes-productionmgmt-pmr-form-table"></table>
    <script type="text/html" id="zkmes-productionmgmt-pmr-form-toolbar-head">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
    </script>
  </div>

  <div class="layui-hide">
    <input type="text" name="status" class="layui-input" />
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-block">
      <input type="button" id="pass" lay-active="pass" value="通过" class="layui-btn layui-bg-blue" />
      <input type="button" id="nopass" lay-active="nopass" value="拒绝" class="layui-btn layui-bg-red" />

      <input
        type="button"
        id="zkmes-productionmgmt-pmr-form-submit"
        lay-submit
        lay-filter="zkmes-productionmgmt-pmr-form-submit"
        value="关闭"
        class="layui-btn"
      />
    </div>
  </div>
</div>

<script type="text/html" template lay-done="layui.data.sendZkmesInvmgmtPmrEditFormParams(d.params)"></script>

<script>
  layui.data.sendZkmesInvmgmtPmrEditFormParams = function (params) {
    layui.use(["admin", "form", "xmSelect"], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        table = layui.table,
        form = layui.form,
        laydate = layui.laydate,
        xmSelect = layui.xmSelect;

      var warehouseIds = params.warehouseId + "";
      if (warehouseIds) {
        warehouseIds = warehouseIds.split(",");
      }

      admin.req({
        url: "/zkmes/warehousemgmt/warehouse/list1",
        type: "get",
        async: false,
        contentType: "application/json;charset=UTF-8",
        done: function (res) {
          pmrWarehouseXmselect = xmSelect.render({
            el: "#pmrWarehouseXmselect",
            name: "warehouseId",
            data: res.data,
            radio: true,
            clickClose: true,
            layVerify: "required",
            layVerType: "tips",
            initValue: warehouseIds,
            prop: {
              name: "warehouseName",
              value: "warehouseId",
            },
            on: function (data) {
              //arr:  当前多选已选中的数据
              var arr = data.arr;
              //change, 此次选择变化的数据,数组
              var change = data.change;
              //isAdd, 此次操作是新增还是删除
              var isAdd = data.isAdd;

              console.log(arr);

              layui.table.reloadData("zkmes-productionmgmt-pmr-form-table", {
                where: {
                  warehouseId: arr[0].warehouseId,
                  outboundorderId: params.outboundorderId,
                },
              }); //重载表格

              //可以return一个数组, 代表想选中的数据
              //return []
            },
          });
        },
      });

      var prefix = "zkmes/productionmgmt/pmr/product";

      table.render({
        elem: "#zkmes-productionmgmt-pmr-form-table",
        url: prefix + "/list",
        toolbar: "#zkmes-productionmgmt-pmr-form-toolbar-head",
        where: {
          outboundorderId: params.outboundorderId,
        },
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-450",
        cols: [
          [
            { field: "productId", title: "物料编号" },
            { field: "productName", title: "名称" },
            { field: "modelName", title: "型号" },
            { field: "specName", title: "规格" },
            { field: "uomName", title: "单位" },
            { field: "outboundQty", title: "领料数量" },
            {
              field: "invQty",
              title: "库存数量",
              templet: function (res) {
                var warehouseId = $('[name="warehouseId"]').val();

                if (warehouseId == null || warehouseId == "") {
                  return "请选择仓库";
                } else {
                  if (res.invQty == null) {
                    return "暂无库存";
                  } else {
                    return res.invQty;
                  }
                }
              },
            },
            {
              field: "unitPrice",
              title: "单价",
              edit: function (d) {
                if (params.status == 1) {
                  return "text"; // 编辑模式
                }
              },
            },
            { field: "amount", title: "金额" },
            { field: "createTime", title: "创建时间" },
          ],
        ],
      });

      //工具条
      table.on("tool(zkmes-productionmgmt-pmr-form-table)", function (obj) {
        var data = obj.data;
        if (obj.event === "del") {
          layer.confirm("确定删除？", function (index) {
            admin.req({
              url: prefix + "/" + data.productionmgmtId,
              type: "delete",
              contentType: "application/json;charset=UTF-8",
              done: function (res) {
                layer.msg("删除成功");
                layui.table.reload("zkmes-productionmgmt-pmr-form-table"); //重载表格
                layer.close(index); //执行关闭
              },
            });
          });
        }
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-productionmgmt-pmr-form-table)", function (obj) {
        switch (obj.event) {
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-productionmgmt-pmr-form-table"); //重载表格
            break;
        }
      });

      laydate.render({
        elem: "#ID-laydate-begintime",
        value: params.begintime,
        isInitValue: true,
        type: "datetime",
        fullPanel: true,
      });

      form.render(null);
    });
  };

  layui.use(["admin", "form", "common"], function () {
    var $ = layui.$,
      util = layui.util,
      admin = layui.admin,
      common = layui.common,
      view = layui.view,
      table = layui.table,
      form = layui.form;

    //处理属性 为 lay-active 的所有元素事件
    util.event("lay-active", {
      pass: function (othis) {
        var warehouseId = $('input[name="warehouseId"]').val();

        if (warehouseId == null || warehouseId == "") {
          layer.alert("请选择仓库");
        } else {
          form.val("zkmes-productionmgmt-pmr-form", { status: 4 });

          var submit = $("#zkmes-productionmgmt-pmr-form-submit");
          submit.trigger("click");
        }
      },
      nopass: function (othis) {
        form.val("zkmes-productionmgmt-pmr-form", { status: 5 });

        var submit = $("#zkmes-productionmgmt-pmr-form-submit");
        submit.trigger("click");
      },
    });
  });
</script>
