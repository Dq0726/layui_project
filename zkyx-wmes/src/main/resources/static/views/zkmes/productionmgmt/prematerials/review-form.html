<div class="layui-form" lay-filter="zkmes-productionmgmt-prematerials-review-form" style="padding: 20px 30px 0 0">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">任务编号</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="text"
            id="productiontaskId"
            name="productiontaskId"
            placeholder="请输入"
            value="{{ d.params.productiontaskId || '' }}"
            lay-verify="required"
            autocomplete="off"
			disabled
            class="layui-input"
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">任务名称</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="text"
            name="productiontaskName"
            placeholder="请输入"
            value="{{ d.params.productiontaskName || '' }}"
            lay-verify="required"
            autocomplete="off"
			disabled
            class="layui-input"
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">生产单号</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="text"
            name="productionplanId"
            placeholder="请输入"
            value="{{ d.params.productionplanId || '' }}"
            autocomplete="off"
			disabled
            class="layui-input"
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">生产单名称</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="text"
            name="productionplanName"
            placeholder="请输入"
            value="{{ d.params.productionplanName || '' }}"
            autocomplete="off"
			disabled
            class="layui-input"
          />
        </script>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">产品编号</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="text"
            name="productId"
            placeholder="请输入"
            value="{{ d.params.productId || '' }}"
			disabled
            autocomplete="off"
            class="layui-input"
          />
        </script>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">产品名称</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="text"
            name="productName"
            placeholder="请输入"
            value="{{ d.params.productName || '' }}"
            autocomplete="off"
			disabled
            class="layui-input"
          />
        </script>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">备料数量</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="number" 
 			      id="schedulingQty"
            name="schedulingQty"
            placeholder="请输入"
            value="{{ d.params.schedulingQty || '' }}"
            autocomplete="off"
			      disabled
            class="layui-input"
          />
        </script>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">预计领料日期</label>
      <div class="layui-input-block">
        <input
          type="text"
          id="ID-laydate-begintime"
          name="begintime"
          placeholder="yyyy-MM-dd HH:mm:ss"
          lay-verify="required"
          autocomplete="off"
          class="layui-input" 
        />
      </div>
    </div> 
  </div>

  <div class="layui-form-item"> 
    
    <div class="layui-inline">
      <label class="layui-form-label">备注</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="text"
            name="remark"
            placeholder="请输入"
            value="{{ d.params.remark || '' }}"
            autocomplete="off"
            class="layui-input"
          />
        </script>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <table
      id="zkmes-productionmgmt-prematerials-review-form-table"
      lay-filter="zkmes-productionmgmt-prematerials-review-form-table"
    ></table>
    <script type="text/html" id="zkmes-productionmgmt-prematerials-review-form-toolbar-head">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
    </script>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
     <div class="layui-input-block">
    <input
        type="button" 
        id="generate"
        lay-active="generate"
        value="生成"
        class="layui-btn layui-bg-blue"
      />
      <input
        type="button"
        id="zkmes-productionmgmt-prematerials-review-form-submit"
        lay-submit
        lay-filter="zkmes-productionmgmt-prematerials-review-form-submit"
        value="关闭"
        class="layui-btn"
      />
    </div>
  </div>
</div>

<script type="text/html" template lay-done="layui.data.sendProductionmgmtProductionmatpreReviewFormParams(d.params)"></script>

<script>
  layui.data.sendProductionmgmtProductionmatpreReviewFormParams = function (params) {
    layui.use(["admin", "form"], function () {
      var $ = layui.$,
        table = layui.table,
        laydate = layui.laydate,
        form = layui.form;
   
      laydate.render({
        elem: "#ID-laydate-begintime",
        value: params.begintime,
        isInitValue: true,
        type: "datetime",
        fullPanel: true,
      });
 
      table.render({
        elem: "#zkmes-productionmgmt-prematerials-review-form-table",
        url: "zkmes/productmgmt/bom/list", 
        where: {
          superId: params.productId,
        },
        parseData: function (res) {
            // res 即为原始返回的数据

            var rows = res.rows;

            for (var i = 0; i < rows.length; i++) {
              rows[i].outboundQty = (rows[i].ratio * params.schedulingQty).toFixed(2);
            }

            return {
              code: res.code, // 解析接口状态
              msg: res.msg, // 解析提示文本
              count: res.total, // 解析数据长度
              data: res.rows, // 解析数据列表
            };
          },
        toolbar: "#zkmes-productionmgmt-prematerials-review-form-toolbar-head", 
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-550",
        cols: [
          [
            { field: "productId", title: "物料编号" },
            { field: "productName", title: "名称" },
            { field: "modelName", title: "型号" },
            { field: "specName", title: "规格" },
            { field: "uomName", title: "单位" },
            { field: "ratio", title: "使用比例" },
            {
              field: "qty",
              title: "数量",
              templet: function (res) {
                var qty = res.ratio * $("#schedulingQty").val();
                return qty.toFixed(2);
              } 
            },
            { field: "createTime", title: "创建时间" },
          ],
        ],
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-productionmgmt-prematerials-review-form-table)", function (obj) {
        switch (obj.event) {
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
        }
      });
     
    });
  };

  layui.use(["admin", "form"], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      util = layui.util,
      table = layui.table,
      form = layui.form;
    
    
  //处理属性 为 lay-active 的所有元素事件
    util.event('lay-active', {
      generate: function(othis){
    	
    	  var prefix = "zkmes/productionmgmt/prematerials/pmr";
    	  
    	  var data = form.val('zkmes-productionmgmt-prematerials-review-form');
    	  var tableData = table.getData("zkmes-productionmgmt-prematerials-review-form-table");
    	  
    	//  alert(JSON.stringify(tableData));
    	  
    	/*    var mprProductList = Array();
           
           for(var i = 0; i < tableData.length; i++){
         	 
         	  var pmrProduct = new Object(); 
         		pmrProduct.productId = tableData[i].productId;
         		pmrProduct.pmrQty = tableData[i].number;
         		pmrProduct.unitPrice = tableData[i].unitPrice;
         		pmrProduct.amount = tableData[i].amount;
         		pmrProduct.push(mprProduct);
         	   
           } 
            */

    	  data.productList = tableData;
          
    	  //提交 Ajax 成功后，关闭当前弹层并重载表格
          admin.req({
            url: prefix,
            type: "post",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(data),
            done: function (res) {
              layer.msg("生成成功");

              var submit  = $("#zkmes-productionmgmt-prematerials-review-form-submit")   
        	  submit.trigger('click');
              
              
            },
          });
    	  
    	  
    	//  var j = new Object();
    	//  j.productionplanId = $("#productionplanId").val();
    	//  j.status = 1;
    	    
    	  
    	  
    	  /* var field = data.field; //获取提交的字段

          var listData = table.getData("zkmes-productionmgmt-prematerials-form-table");

          field.listData = listData;

          //提交 Ajax 成功后，关闭当前弹层并重载表格
          admin.req({
            url: prefix,
            type: "put",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(field),
            done: function (res) {
              layer.msg("修改成功");
              layui.table.reload("zkmes-productionmgmt-prematerials-table"); //重载表格
              layer.close(index); //执行关闭
            },
          }); */
          
          
          
          
          
 
        	/* admin.req({
            url: "zkmes/productionmgmt/productionplan/review",
            type: "put",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(j),
            done: function (res) {
                  layer.msg("提交成功");
            	 
            	  var submit  = $("#zkmes-productionmgmt-productionplan-review-form-submit")   
            	  submit.trigger('click');
            },
          });  */
      } 
    });
  
  

   
  });
</script>
