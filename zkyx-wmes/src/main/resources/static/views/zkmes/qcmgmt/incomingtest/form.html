<div class="layui-form" lay-filter="zkmes-qcmgmt-incomingtest-form" style="padding: 10px 30px 0 0">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">采购单</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="incomingtestId"
            name="incomingtestId"
            placeholder="请输入"
            value="{{ d.params.incomingtestId || '' }}"
            lay-verify="required"
            autocomplete="off"
            class="layui-input"
			disabled
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">交货日期</label>
      <div class="layui-input-inline">
        <input
          type="text"
          id="ID-laydate-deliverydate"
          placeholder="请输入"
          name="deliverydate"
          autocomplete="off"
          class="layui-input"
		  disabled
        />
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">供应商</label>
      <div class="layui-input-inline">
         <script type="text/html" template>
          <input
            type="text"
            lay-verify="required"
            readonly
            placeholder="请选择"
            value="{{ d.params.supplierName || '' }}"
            name="supplierName"
            lay-options="{split: true}"
            class="layui-input"
			disabled
          />
          </script>
      </div>
    </div>
    
  </div>
   <div class="layui-form-item">
    <label class="layui-form-label">备注</label>
    <div class="layui-input-block">
      <script type="text/html" template>
        <textarea type="text" name="remark" autocomplete="off" class="layui-textarea">
{{ d.params.remark || '' }}</textarea>
      </script>
    </div>
  </div>

  <div class="layui-form-item">
    <table
      id="zkmes-qcmgmt-incomingtest-form-table"
      lay-filter="zkmes-qcmgmt-incomingtest-form-table"
    ></table>
    <script type="text/html" id="zkmes-qcmgmt-incomingtest-form-toolbar-head">
      <div class="layui-btn-container"> 
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
    </script>

    <script type="text/html" id="zkmes-qcmgmt-incomingtest-form-toolbar-row">
      <a class="layui-btn layui-btn-xs" lay-event="tests"
        ></i>检验单</a
      >
    </script>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-inline">
      <input
        type="button"
        id="zkmes-qcmgmt-incomingtest-form-submit"
        lay-submit
        lay-filter="zkmes-qcmgmt-incomingtest-form-submit"
        value="确认"
        class="layui-btn"
      />
    </div>
  </div>
</div>

<script
  type="text/html"
  template
  lay-done="layui.data.sendZkmesQcmgmtIncomingtestFormParams(d.params)"
></script>

<script>
  layui.data.sendZkmesQcmgmtIncomingtestFormParams = function (params) {
	  console.log(params);
    layui.use(["admin", "form", "xmSelect",'common'], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        table = layui.table,
        form = layui.form,
        laydate = layui.laydate,
        util = layui.util,
        common = layui.common,
        xmSelect = layui.xmSelect;

      var prefix = "zkmes/qcmgmt/incomingtest/tests";
      // 调用 common.js 模块 getPopupSize 函数，用 ES6 解构赋值获取返回的两个参数
      const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();
      
      table.render({
        elem: "#zkmes-qcmgmt-incomingtest-form-table",
        url: prefix + "/list1",
        toolbar: "#zkmes-qcmgmt-incomingtest-form-toolbar-head",
        where: {
        	purchaseorderId: params.incomingtestId,
        },
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-450",
        cols: [
          [
       	  	{
              field: "purchaseorderproductId",
              title: "采购产品编号",
              totalRow: "合计：",
            },
            {
              field: "productId",
              title: "物料编号",
              totalRow: "合计：",
            },
            {
              field: "productName",
              title: "名称",
            },
            {
              field: "modelName",
              title: "型号",
            },
            {
              field: "specName",
              title: "规格",
            },
            {
              field: "uomName",
              title: "单位",
            }, 
            {
                field: "purchaseQty",
                title: "数量" 
            }, 
            {
              field: "sampleQty",
              title: "样本数量",
            }, 
            {
              title: "操作",
              width: 120,
              align: "center",
              fixed: "right",
              toolbar: "#zkmes-qcmgmt-incomingtest-form-toolbar-row",
            },
          ],
        ],
      });

     
      //工具条
      table.on("tool(zkmes-qcmgmt-incomingtest-form-table)", function (obj) {
        var data = obj.data;
        if (obj.event === "tests") {
          
        	 
        	
          admin.popup({
            title: "检验单",
            area: popupWidthHeight,
            offset: popupOffsetWidthHeight,
            id: "popup-zkmes-qcmgmt-incomingtest-from-tests",
            success: function (layero, index) {
              view(this.id)
                .render("zkmes/qcmgmt/incomingtest/tests-form", data)
                .done(function () {
                  form.render(null, "zkmes-qcmgmt-incomingtest-tests-form");

                  //提交
                  form.on("submit(zkmes-qcmgmt-incomingtest-tests-form-submit)", function (data) {
                    var field = data.field; //获取提交的字段  
                    //提交 Ajax 成功后，关闭当前弹层并重载表格
                     console.log(field);
	                    admin.req({
	                    url: prefix,
	                    type: "post",
	                    contentType: "application/json;charset=UTF-8",
	                    data: JSON.stringify(field),
	                    done: function (res) {
	                      layer.msg("修改成功");
	                      layui.table.reload("zkmes-qcmgmt-incomingtest-form-table"); //重载表格
	                      layer.close(index); //执行关闭
	                    },
	                  });   
                  });
                });
            },
          });       
        }
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-qcmgmt-incomingtest-form-table)", function (obj) {
        switch (obj.event) { 
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-qcmgmt-incomingtest-form-table"); //重载表格
            break;
        }
      });
      laydate.render({
          elem: "#ID-laydate-deliverydate",
          value: params.deliverydate,
          isInitValue: true,
          type: "date",
          fullPanel: true,
        });
     




      $("input[name=tax][value=0]").attr("checked", params.tax == 0 ? true : false);
      $("input[name=tax][value=1]").attr("checked", params.tax == 1 ? true : false);

      form.render(null);
    });
  };

  layui.use(["admin", "form", "common"], function () {
    var $ = layui.$,
      util = layui.util,
      admin = layui.admin,
      common = layui.common,
      view = layui.view,
      table = layui.table,
      form = layui.form;
  });
</script>
