<div class="layui-form" lay-filter="zkmes-energymgmt-gateway-edit-form" style="padding: 10px 30px 0 0">
 
  <div class="layui-form-item">
    <!-- 网关编码 gatewayId-->
    <div class="layui-inline">
      <label class="layui-form-label">网关编码<span class="required">*</span></label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="gatewayId"
            name="gatewayId"
            value="{{ d.params.gatewayId || '' }}"
            placeholder="请输入"
            autocomplete="off"
            lay-verify="required"
            class="layui-input"
			disabled
          />
        </script>
      </div>
    </div>
    <!-- 网关名称 equipmentName-->
    <div class="layui-inline">
      <label class="layui-form-label">网关名称<span class="required">*</span></label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            name="gatewayName"
            value="{{ d.params.gatewayName || '' }}"
            placeholder="请输入"
            autocomplete="off"
            lay-verify="required"
            class="layui-input"
          />
        </script>
      </div>
    </div>
    <!-- 网关类型 equipmenttype-->
    <div class="layui-inline">
      <label class="layui-form-label">网关类型</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            name="gatewayType"
            value="{{ d.params.gatewayType || '' }}"
            placeholder="请输入"
            autocomplete="off"
            class="layui-input"
          />
        </script>
      </div>
    </div>
  </div>
  <div class="layui-form-item">
    <!-- 型号 modelId-->
    <div class="layui-inline">
      <label class="layui-form-label">型号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            name="model"
            value="{{ d.params.model || '' }}"
            placeholder="请输入"
            autocomplete="off"
            class="layui-input"
          />
        </script>
      </div>
    </div>

    <!-- 使用车间 workshop-->
    <div class="layui-inline">
      <label class="layui-form-label">使用车间</label>
      <div class="layui-input-inline">
        <div id="workshopXmselect" class="xm-select-demo"></div>
      </div>
    </div>

    <!-- 安装日期 installTime-->
    <div class="layui-inline">
      <label class="layui-form-label">安装日期</label>
      <div class="layui-input-inline">
        <input
          type="text"
          id="ID-laydate-installtime"
          placeholder="请输入"
          name="installTime"
          autocomplete="off"
          class="layui-input"
        />
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-tab layui-tab-brief">
      <ul class="layui-tab-title">
        <li class="layui-this">通道信息</li>
      </ul>
      <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
          <table id="zkmes-energymgmt-gateway-edit-table" lay-filter="zkmes-energymgmt-gateway-edit-table"></table>

          <script type="text/html" id="zkmes-energymgmt-gateway-edit-toolbar-head">
            <div class="layui-btn-container">
              <button class="layui-btn layui-btn-sm" lay-event="add">增加</button>
              <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
            </div>
          </script>
          <script type="text/html" id="zkmes-energymgmt-gateway-edit-toolbar-row">
            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"
              ><i class="layui-icon layui-icon-edit"></i>编辑</a
            >
 			<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
          </script>
        </div>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-inline">
      <input
        type="button"
        id="zkmes-energymgmt-gateway-form-edit-submit"
        lay-submit
        lay-filter="zkmes-energymgmt-gateway-form-edit-submit"
        value="确认"
        class="layui-btn"
      />
    </div>
  </div>
</div>

<script type="text/html" template lay-done="layui.data.sendZkmesEnergymgmtGatewayEditFormParams(d.params)"></script>

<script>
  layui.data.sendZkmesEnergymgmtGatewayEditFormParams = function (params) {
    layui.use(["admin", "form", "xmSelect"], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        table = layui.table,
        form = layui.form,
        laydate = layui.laydate,
        util = layui.util,
        xmSelect = layui.xmSelect;

      /* 安装日期 */
      laydate.render({
        elem: "#ID-laydate-installtime",
        type: "datetime",
        value: params.installTime,
        isInitValue: true,
        fullPanel: true,
      });

      /* 使用车间 */
      var workshopIds = params.workshopId;
      if (workshopIds) {
        workshopIds = workshopIds.split(",");
      }

      admin.req({
        url: "zkmes/workshopmgmt/workshop/list1",
        type: "get",
        contentType: "application/json;charset=UTF-8",
        done: function (res) {
          workshopXmselect = xmSelect.render({
            el: "#workshopXmselect",
            name: "workshopId",
            data: res.data,
            clickClose: true,
            radio: true,
            initValue: workshopIds,
            prop: {
              name: "workshopName",
              value: "workshopId",
            },
          });
        },
      });

      var prefix = "zkmes/energymgmt/channel";

      table.render({
        elem: "#zkmes-energymgmt-gateway-edit-table",
        url: prefix + "/list",
        toolbar: "#zkmes-energymgmt-gateway-edit-toolbar-head",
        page: true,
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-500",
        cols: [
          [
            { field: "channelId", title: "通道编号" }, 
            { field: "channelName", title: "通道名称" },   
            { field: "commcode", title: "通讯编码" },
            { field: "equipmentarchivesName", title: "绑定设备" }, 
            {
              title: "操作",
              width: 160,
              align: "center",
              fixed: "right",
              toolbar: "#zkmes-energymgmt-gateway-edit-toolbar-row",
            },
          ],
        ],
      });

      
    //工具条
      table.on('tool(zkmes-energymgmt-gateway-edit-table)', function (obj) {
        var data = obj.data;
        if (obj.event === 'del') {
          layer.confirm('重要数据，请确定后删除？', function (index) {
            admin.req({
          	  url: prefix + "/" + data.channelId 
              , type: 'delete'
              , contentType: 'application/json;charset=UTF-8'
              , done: function (res) {
                layer.msg("删除成功");
                layui.table.reload('zkmes-energymgmt-gateway-edit-table'); //重载表格
                layer.close(index); //执行关闭 
              }
            });
          });
        } else if (obj.event === 'edit') {
          admin.popup({
            title: '编辑通道信息'
           , area: '450px'
            , offset: '100px'
            , id: "popup-zkmes-energymgmt-gateway-edit-channel-edit"
            , success: function (layero, index) {
              view(this.id).render('zkmes/energymgmt/gateway/channel-form', data).done(function () {
                form.render(null, 'zkmes-energymgmt-gateway-channel-form'); 
                //提交
                form.on('submit(zkmes-energymgmt-gateway-channel-form-submit)', function (data) {
                  var field = data.field; //获取提交的字段   
                  //提交 Ajax 成功后，关闭当前弹层并重载表格
                  admin.req({
                  	url: prefix
                    , type: 'put'
                    , contentType: 'application/json;charset=UTF-8'
                    , data: JSON.stringify(field)
                    , done: function (res) {
                      layer.msg("修改成功");
                      layui.table.reload('zkmes-energymgmt-gateway-edit-table'); //重载表格
                      layer.close(index); //执行关闭 
                    }
                  });
                });
              });
            }
          });
        }
      });
      
      
      
      // 头部工具栏点击事件
      table.on("toolbar(zkmes-energymgmt-gateway-edit-table)", function (obj) {  
        switch (obj.event) {
          case "add":
            admin.popup({
              title: "添加通道信息",
              area: "450px",
              offset: "100px",
              id: "popup-zkmes-energymgmt-gateway-edit-channel-add",
              success: function (layero, index) {
                view(this.id)
                  .render("zkmes/energymgmt/gateway/channel-form")
                  .done(function () {
                    form.render(null, "zkmes-energymgmt-gateway-channel-form");
                    //提交
                    form.on("submit(zkmes-energymgmt-gateway-channel-form-submit)", function (data) {
                      var field = data.field; //获取提交的字段
                      //提交 Ajax 成功后，关闭当前弹层并重载表格
                      field.gatewayId = $("#gatewayId").val();
                      admin.req({
                        url: prefix ,
                        type: "post",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(field),
                        done: function (res) {
                          layer.msg("新增成功");
                          layui.table.reload("zkmes-energymgmt-gateway-edit-table"); //重载表格
                          layer.close(index); //执行关闭
                        },
                      });
                    });
                  });
              },
            });
            break; 
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
         	  layui.table.reloadData("zkmes-energymgmt-gateway-table"); //重载表格
              layer.msg('刷新成功');
         	  break;
        }
      });
      
      
      
      
      
      
      
      
      
      
      form.render(null);
    });
  };

  layui.use(["admin", "form"], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      laydate = layui.laydate,
      form = layui.form;
  });
</script>
