<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>能耗管理</cite></a>
    <a><cite>实时数据</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body">
      <table id="zkmes-energymgmt-runtime-table" lay-filter="zkmes-energymgmt-runtime-table"></table>

      <script type="text/html" id="zkmes-energymgmt-runtime-toolbar-head">
        <div class="layui-btn-container">  
          <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
        </div>
      </script>
      <script type="text/html" id="zkmes-energymgmt-runtime-toolbar-row">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"
          ><i class="layui-icon layui-icon-edit"></i>详情</a
        > 
      </script>
    </div>
  </div>
</div>

<script>
  layui.use(["admin", "table",'common'], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      common = layui.common,
      form = layui.form;

    var prefix = "/zkmes/energymgmt/channel";
    // 调用 common.js 模块 getPopupSize 函数，用 ES6 解构赋值获取返回的两个参数
    const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();

    table.render({
      elem: "#zkmes-energymgmt-runtime-table",
      url: prefix + "/list",
      toolbar: "#zkmes-energymgmt-runtime-toolbar-head",
      page: true,
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-200",
      cols: [
        [
          { field: "equipmentarchivesId", title: "设备编码" },
          { field: "equipmentarchivesName", title: "设备名称" }, 
          { field: "workshopName", title: "安装车间" }, 
          { field: "workstationName", title: "安装工作站" }, 
          { field: "commcode", title: "通讯编码" },
          { field: "gatewayonline", title: "在线状态", templet: function (res) {  

        	  // 模拟设备数据，包括设备ID和最后记录时间（以分钟为单位的时间戳）
              var deviceData = [
                  { deviceId: 'device1', lastRecordTime: Math.floor((new Date().getTime() / 1000 / 60)) - 3 }];  // 3分钟前记录
        	/* 检查设备是否离线函数 */
              function checkDeviceOffline(deviceId, timeoutMinutes) {
                  var currentTime = Math.floor((new Date().getTime() / 1000 / 60));
                  var device = deviceData.find(function(d) { return d.deviceId === deviceId; });

                  if (device) {
                      var lastRecordTime = device.lastRecordTime;
                      var timeDiff = currentTime - lastRecordTime;

                      if (timeDiff > timeoutMinutes) {
                          return true;  // 设备离线
                      } else {
                          return false; // 设备在线
                      }
                  } else {
                      // 如果没有找到设备数据，也可以认为是离线（根据实际需求调整）
                      return true;
                  }
              }
      		/* var html = res.gatewaystatusId == 0 ? 
      				'<span class="layui-badge layui-bg-blue">在线</span>' : '<span class="layui-badge layui-bg-orange">离线</span>';  */
      				var html = '<span class="layui-badge layui-bg-blue">在线</span>';
      				return html;
        } }, 
          {
            title: "操作",
            width: 160,
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-energymgmt-runtime-toolbar-row",
          },
        ],
      ],
    });

    //工具条
    table.on("tool(zkmes-energymgmt-runtime-table)", function (obj) {
      var data = obj.data;
      if (obj.event === "del") {
        layer.confirm("确定删除？", function (index) {
          admin.req({
            url: prefix + "/" + data.runtimeId,
            type: "delete",
            contentType: "application/json;charset=UTF-8",
            done: function (res) {
              layer.msg("删除成功");
              layui.table.reload("zkmes-energymgmt-runtime-table"); //重载表格
              layer.close(index); //执行关闭
            },
          });
        });
      } else if (obj.event === "edit") {
        admin.popup({
          title: "实时数据详情",
          area: popupWidthHeight,
          offset: popupOffsetWidthHeight,
          id: "popup-zkmes-energymgmt-runtime-edit",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/energymgmt/runtime/form", data)
              .done(function () {
                form.render(null, "zkmes-energymgmt-runtime-form");

                //提交
                form.on("submit(zkmes-energymgmt-runtime-form-submit)", function (data) {
                	  var field = data.field; //获取提交的字段
                       
                	  layui.table.reload("zkmes-energymgmt-runtime-table"); //重载表格
                      layer.close(index); //执行关闭 
                });
              });
          },
        });
      }
    });

    // 头部工具栏点击事件
    table.on("toolbar(zkmes-energymgmt-runtime-table)", function (obj) {
      switch (obj.event) { 
        case "delete":
          layer.msg("删除");
          break;
        case "update":
          layer.msg("编辑");
          break;
        case "LAYTABLE_TIPS":
          layer.msg("提示");
          break;
        case "refresh":
       	  layui.table.reloadData("zkmes-energymgmt-runtime-table"); //重载表格
          layer.msg('刷新成功');
       	  break;
      }
    });
 
  });
</script>
