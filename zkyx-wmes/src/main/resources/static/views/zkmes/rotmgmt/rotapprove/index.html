<title>税率审批</title>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>税率管理</cite></a>
    <a><cite>税率审批</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body">
      <!--    search start -->
      <div class="keySearch-cont" style="margin-bottom: 10px;">
        	关键字搜索：
        <div class="layui-inline">
          <input class="layui-input" name="keySearch-input" id="keySearch-input" autocomplete="off"
            placeholder="请输入关键字">
        </div>
        <button class="layui-btn" data-type="keySearch" lay-on="keySearch">搜索</button>
      </div>
      <!--    search end -->
      <table id="zkmes-rotmgmt-rotapprove-table" lay-filter="zkmes-rotmgmt-rotapprove-table"></table>
      <script type="text/html" id="zkmes-rotmgmt-rotapprove-toolbar-head">
	    <div class="layui-btn-container">  
		  <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
	    </div>
	  </script>

	 <script type="text/html" id="zkmes-rotmgmt-rotapprove-toolbar-row">
				{{# if(d.approveStatus == 9){ }}
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="approve"><i class="layui-icon layui-icon-edit"></i>审批</a> 
				{{# }else{ }}
         <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="detail"><i class="layui-icon layui-icon-edit"></i>详情</a> 
				{{# } }}
		</script>

    </div>
  </div>
</div>

<script>
layui.use(['admin', 'table', 'common', 'util'], function () {
    var $ = layui.$
      , admin = layui.admin
      , view = layui.view
      , table = layui.table
      , common = layui.common
      , util = layui.util
      , form = layui.form;

    var prefix = "zkmes/rotmgmt/rotapprove";
    // 调用 common.js 模块 getPopupSize 函数，用 ES6 解构赋值获取返回的两个参数
    const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();

    table.render({
      elem: '#zkmes-rotmgmt-rotapprove-table'
      , url: prefix + '/list'
      , toolbar: '#zkmes-rotmgmt-rotapprove-toolbar-head'
      , page: true
      , defaultToolbar: ['filter', 'print', 'exports', {
        title: '提示',
        layEvent: 'LAYTABLE_TIPS',
        icon: 'layui-icon-tips'
      }]
      , height: 'full-200'
      	, cols: [[
          { field: 'rotId', title: 'ID' }
          , { field: 'rotName', title: '税率名称' }
          , { field: 'rot', title: '税率', templet: function (res) {
              var html = '<span class="layui-badge layui-bg-blue">' + res.rot + '%</span>';
              return html;
            }
          }
          , {
            field: 'status', title: '启用状态', templet: function (res) {
              var html = res.status == 0 ? '<span class="layui-badge layui-bg-blue">启用</span>' : '<span class="layui-badge layui-bg-orange">停用</span>';
              return html;
            }
          } 
          , { field: 'createTime', title: '创建时间' }
          , {
              field: 'approve', title: '审批状态', templet: function (res) {
                var html = res.approveStatus == 9 ? '<span class="layui-badge layui-bg-orange">待审批</span>' : '<span class="layui-badge layui-bg-blue">已审批</span>' ;
                return html;
              }
            }
          , { title: '操作', width: 160, align: 'center', fixed: 'right', toolbar: '#zkmes-rotmgmt-rotapprove-toolbar-row' }
        ]]
    });

    //工具条
    table.on('tool(zkmes-rotmgmt-rotapprove-table)', function (obj) {
      var data = obj.data;
      if (obj.event === 'approve') {
        admin.popup({
          title: '税率审批'
          , area: popupWidthHeight
          , offset: popupOffsetWidthHeight
          , id: 'popup-zkmes-rotmgmt-rotapprove-edit'
          , success: function (layero, index) {
            view(this.id).render('zkmes/rotmgmt/rotapprove/form', data).done(function () {
              form.render(null, 'zkmes-rotmgmt-rotapprove-form');
              //提交
              form.on('submit(zkmes-rotmgmt-rotapprove-form-agree-submit)', function (data) {
       
                var field = data.field; //获取提交的字段    
                var j = {
                		rotId: field.rotId, 
                		approveStatus: 0
                };  
                //提交 Ajax 成功后，关闭当前弹层并重载表格
                admin.req({
                  url: prefix
                  , type: 'put'
                  , contentType: 'application/json;charset=UTF-8'
                  , data: JSON.stringify(j)
                  , done: function (res) {
                    layer.msg("修改成功");
                    layui.table.reload('zkmes-rotmgmt-rotapprove-table'); //重载表格
                    layer.close(index); //执行关闭 
                  }
                });
              });
              
              form.on('submit(zkmes-rotmgmt-rotapprove-form-disagree-submit)', function (data) {
                var field = data.field; //获取提交的字段    
                var j = {
                		rotId: field.rotId, 
                		approveStatus: 1
                };  
                //提交 Ajax 成功后，关闭当前弹层并重载表格
                admin.req({
                  url: prefix
                  , type: 'put'
                  , contentType: 'application/json;charset=UTF-8'
                  , data: JSON.stringify(j)
                  , done: function (res) {
                    layer.msg("修改成功");
                    layui.table.reload('zkmes-rotmgmt-rotapprove-table'); //重载表格
                    layer.close(index); //执行关闭 
                  }
                });
              });
              
            });
          }
        });
      }else if (obj.event === 'detail') {
    
      	data.c_e = "detail";
      	
        admin.popup({
          title: '税率详情'
          , area: popupWidthHeight
          , offset: popupOffsetWidthHeight
          , id: 'popup-zkmes-rotmgmt-rotapprove-detail'
          , success: function (layero, index) {
            view(this.id).render('zkmes/rotmgmt/rotapprove/form', data).done(function () {
              form.render(null, 'zkmes-rotmgmt-rotapprove-form');
              //提交
              form.on('submit(zkmes-rotmgmt-rotapprove-form-close)', function (data) { 
                var field = data.field; //获取提交的字段    
                layer.close(index); //执行关闭 
              }); 
            });
          }
        });
      }
    });

    // 头部工具栏点击事件
    table.on('toolbar(zkmes-rotmgmt-rotapprove-table)', function (obj) {
      switch (obj.event) { 
        case 'delete':
          layer.msg('删除');
          break;
        case 'update':
          layer.msg('编辑');
          break;
        case 'LAYTABLE_TIPS':
          layer.msg('提示');
          break;
        case "refresh":
            layer.msg('刷新成功');
            layui.table.reloadData("zkmes-rotmgmt-rotapprove-table"); //重载表格
            break;
      }
    });
    util.on("lay-on", {
        // 关键字搜索功能
    	keySearch: function () {
          var keySearchValue = $('#keySearch-input').val();
          // 重载表格，传递搜索参数
          table.reload('zkmes-rotmgmt-rotapprove-table', {
            page: {
              curr: 1 // 从第一页开始
            },
            where: {
              searchValue: keySearchValue // 传递关键字参数到后端
            }
          });
        },
      });
  });
</script>