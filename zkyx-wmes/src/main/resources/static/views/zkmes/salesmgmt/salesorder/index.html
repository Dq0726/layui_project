<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>销售管理</cite></a>
    <a><cite>销售订单</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body">
      <!--    search start -->
      <div class="keySearch-cont" style="margin-bottom: 10px;">
        <div class="layui-inline">
          <input class="layui-input" name="keySearch-input" id="keySearch-input" autocomplete="off"
            placeholder="请输入关键字">
        </div>
        <button class="layui-btn" data-type="keySearch" lay-on="keySearch">搜索</button>
      </div>
      <!--    search end -->
      <table id="zkmes-salesmgmt-salesorder-table" lay-filter="zkmes-salesmgmt-salesorder-table"></table>

      <script type="text/html" id="zkmes-salesmgmt-salesorder-toolbar-head">
        <div class="layui-btn-container">  
          <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
        </div>
      </script>

      <script type="text/html" id="zkmes-salesmgmt-salesorder-toolbar-row">
		{{# if(d.outboundorderId == null){ }} 
         	<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="generate"
          	><i class="layui-icon layui-icon-template"></i>生成出库单</a
        	>
		{{# }else{ }}
			<a class="layui-btn layui-btn-xs layui-bg-green">已生成出库单</a>
		{{# } }}

        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"
          ><i class="layui-icon layui-icon-edit"></i>编辑</a
        > 
 		<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"
          ><i class="layui-icon layui-icon-del"></i>删除</a
        >
      </script>
    </div>
  </div>
</div>

<script>
  layui.use(["admin", "table",'common', 'util'], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      common = layui.common,
      util = layui.util, 
      form = layui.form;

    var prefix = "zkmes/salesmgmt/salesorder";
    // 调用 common.js 模块 getPopupSize 函数，用 ES6 解构赋值获取返回的两个参数
    const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();

    table.render({
      elem: "#zkmes-salesmgmt-salesorder-table",
      url: prefix + "/list",
      toolbar: "#zkmes-salesmgmt-salesorder-toolbar-head",
      page: true,
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-200",
      cols: [
        [
          { field: "salesorderId", title: "订单号", width: 180  }, 
          { field: "salesorderName", title: "订单名称" },
          { field: "customerName", title: "客户名称" },
          { field: "contactsName", title: "客户联系人姓名" },
          { field: "contactsTelephone", title: "客户联系人电话", width: 130 },
          { field: "salesorderName", title: "销售订单名称" }, 
          { field: "signingDate", title: "订单签订日期" },
          { field: "deliveryDate", title: "订单交货日期" },
          { field: "salesman", title: "销售负责人" },
         /*  {
            field: "tax",
            title: "含税",
            templet: function (res) {
              var text = res.tax == 0 ? "是" : "否";
              var html = '<span class="layui-badge layui-bg-green">' + text + "</span>";
              return html;
            },
          }, 
          {
            field: "status",
            title: "状态",
            templet: function (res) {
            	var html = "-";
                if (res.status == 0) {
                  html = '<span class="layui-badge layui-bg-blue">未知</span>';
                } else if (res.status == 1 ) {
                  html = '<span class="layui-badge layui-bg-green">待审核</span>';
                }else if (res.status == 2 ) {
                  html = '<span class="layui-badge layui-bg-green">已确认仓库，待入库</span>';
                } else if (res.status == 3 ) {
                  html = '<span class="layui-badge layui-bg-green">已完成</span>';
                } 
                return html;
            },
          }, */
 
          {
            title: "操作",
            width: 240,
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-salesmgmt-salesorder-toolbar-row",
          },
        ],
      ],
    });

    //工具条
    table.on("tool(zkmes-salesmgmt-salesorder-table)", function (obj) {
      var data = obj.data;
      if (obj.event === "del") {
        layer.confirm("确定删除？", function (index) {
          admin.req({
            url: prefix + "/" + data.salesorderId,
            type: "delete",
            contentType: "application/json;charset=UTF-8",
            done: function (res) {
              layer.msg("删除成功");
              layui.table.reload("zkmes-salesmgmt-salesorder-table"); //重载表格
              layer.close(index); //执行关闭
            },
          });
        });
      } else if (obj.event === "edit") {
        admin.popup({
          title: "销售订单信息",
          area: popupWidthHeight,
          offset: popupOffsetWidthHeight,
          id: "popup-zkmes-salesmgmt-salesorder-edit",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/salesmgmt/salesorder/form", data)
              .done(function () {
                form.render(null, "zkmes-salesmgmt-salesorder-form");

                //提交
                form.on("submit(zkmes-salesmgmt-salesorder-form-submit)", function (data) {
                  var field = data.field; //获取提交的字段  
                  //提交 Ajax 成功后，关闭当前弹层并重载表格
                  admin.req({
                    url: prefix ,
                    type: "put",
                    contentType: "application/json;charset=UTF-8",
                    data: JSON.stringify(field),
                    done: function (res) {
                      layer.msg("修改成功");
                      layui.table.reload("zkmes-salesmgmt-salesorder-table"); //重载表格
                      layer.close(index); //执行关闭
                    },
                  }); 
                });
              });
          },
        });
      }else if (obj.event === "generate") { 
  			layer.confirm("确定生成出库单？", function (index) { 
	  			var field = {}; 
   	  		  
   	  		field.salesorderId =  data.salesorderId;   
   	  		
   	  		admin.req({
          	url: prefix + "/outboundorder" ,
          	type: "post",
          	contentType: "application/json;charset=UTF-8",
          	data: JSON.stringify(field),
          	done: function (res) {
            	layer.msg("新增成功");
            	layui.table.reload("zkmes-salesmgmt-quotationorder-table"); //重载表格
            	layer.close(index); //执行关闭
          	},
        	});    
     		}); 
			}
    });

    // 头部工具栏点击事件
    table.on("toolbar(zkmes-salesmgmt-salesorder-table)", function (obj) {
      switch (obj.event) {
        case "add":
          admin.popup({
            title: "添加销售订单信息",
            area: popupWidthHeight,
            offset: popupOffsetWidthHeight,
            id: "popup-zkmes-salesmgmt-salesorder-add",
            success: function (layero, index) {
              view(this.id)
                .render("zkmes/salesmgmt/salesorder/form")
                .done(function () {
                  form.render(null, "zkmes-salesmgmt-salesorder-form");
                  //提交
                  form.on("submit(zkmes-salesmgmt-salesorder-form-submit)", function (data) {
                    var field = data.field; //获取提交的字段
                    //提交 Ajax 成功后，关闭当前弹层并重载表格
                    /* admin.req({
                      url: prefix ,
                      type: "post",
                      contentType: "application/json;charset=UTF-8",
                      data: JSON.stringify(field),
                      done: function (res) {
                        layer.msg("新增成功");
                        layui.table.reload("zkmes-salesmgmt-salesorder-table"); //重载表格
                        layer.close(index); //执行关闭
                      },
                    }); */
                    layer.msg("暂无权限");layer.close(index); 
                  });
                });
            },
          });
          break;
        case "delete":
          layer.msg("删除");
          break;
        case "update":
          layer.msg("编辑");
          break;
        case "LAYTABLE_TIPS":
          layer.msg("提示");
          break;
        case "refresh":
       	  layui.table.reloadData("zkmes-salesmgmt-salesorder-table"); //重载表格
          layer.msg('刷新成功');
       	  break;
      }
    });
    util.on("lay-on", {
        // 关键字搜索功能
    	keySearch: function () {
          var keySearchValue = $('#keySearch-input').val();
          // 重载表格，传递搜索参数
          table.reload('zkmes-salesmgmt-salesorder-table', {
            page: {
              curr: 1 // 从第一页开始
            },
            where: {
              searchValue: keySearchValue // 传递关键字参数到后端
            }
          });
        },
      });
 
  });
</script>
