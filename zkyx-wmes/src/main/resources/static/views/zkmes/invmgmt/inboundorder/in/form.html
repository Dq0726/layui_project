<div class="layui-form" lay-filter="zkmes-invmgmt-inboundorder-in-form">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">入库产品编号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="inboundorderproductId"
            name="inboundorderproductId"
            placeholder="请输入"
            value="{{ d.params.inboundorderproductId || '' }}"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">入库单号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="inboundorderId"
            name="inboundorderId"
            placeholder="请输入"
            value="{{ d.params.inboundorderId || '' }}"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">物料编号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="productId"
            name="productId"
            placeholder="请输入"
            value="{{ d.params.productId || '' }}"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">入库数量</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="inboundQty"
            name="inboundQty"
            placeholder="请输入"
            value="{{ d.params.inboundQty || '' }}"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">已确认数量</label>
      <div class="layui-input-inline">
        <input type="text" id="cfmdQty" placeholder="请输入" autocomplete="off" class="layui-input" readonly />
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">待确认数量</label>
      <div class="layui-input-inline">
        <input type="text" id="tbcQty" placeholder="请输入" autocomplete="off" class="layui-input" readonly />
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <table
      id="zkmes-invmgmt-inboundorder-in-form-table"
      lay-filter="zkmes-invmgmt-inboundorder-in-form-table"
    ></table>
    <script type="text/html" id="zkmes-invmgmt-inboundorder-in-form-toolbar-head">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
    </script>
    <script type="text/html" id="zkmes-invmgmt-inboundorder-in-form-toolbar-row">

      {{# if(d.inboundorderproductStatus == 0){ }}
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"
        ><i class="layui-icon layui-icon-delete"></i>删除</a>
      {{# }else if(d.inboundorderproductStatus == 1){ }} 

      {{# if(d.status == 0){ }}
      <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="sync">同步</a>
     
      {{# }else if(d.status == 1){ }}
      <a class="layui-btn layui-btn-disabled layui-btn-xs">已同步</a>
      {{# }
			}
       }}
    </script>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-block">
      <script type="text/html" template>
        {{# if(d.params.status == 0){ }}
          <input type="button" id="outinv" lay-active="cfmd" value="确认入库信息" class="layui-btn layui-bg-blue" />
        {{# }else if(d.params.status == 1){ }}
 <input type="button" id="outinv" lay-active="cfmd" value="确认入库信息" class="layui-btn layui-bg-blue" />
          <input type="button" id="review" lay-active="review" value="入库审核" class="layui-btn layui-bg-blue" /> 
        {{# } }}
      </script>

      <input
        type="button"
        id="zkmes-invmgmt-inboundorder-in-form-submit"
        lay-submit
        lay-filter="zkmes-invmgmt-inboundorder-in-form-submit"
        class="layui-btn layui-hide"
      />
    </div>
  </div>
</div>

<script type="text/html" template lay-done="zkmesInvmgmtInboundorderInFormParamsDone(d.params)"></script>
 
<script>
zkmesInvmgmtInboundorderInFormParamsDone = function (params) {
    layui.use(["admin", "form"], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        table = layui.table,
        form = layui.form;

      var prefix = "zkmes/invmgmt/inbatch";

      table.render({
        elem: "#zkmes-invmgmt-inboundorder-in-form-table",
        url: prefix + "/list",
        where: {
          inboundorderId: params.inboundorderId,
          productId: params.productId,
        },
        toolbar: "#zkmes-invmgmt-inboundorder-in-form-toolbar-head",
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-400",
        cols: [
          [
            { field: "inbatchId", title: "入库批次" },
            { field: "inbatchId", title: "库存批次" },
            { field: "productId", title: "物料编号" },
            { field: "productName", title: "物料名称" },
            { field: "supplierName", title: "供应商名称" },
            { field: "warehouseName", title: "仓库名称" },
            { field: "remainingQty", title: "库存数量" },
            {
              field: "inboundQty",
              title: "入库数量",
              edit: function (d) {
                if (d.inboundorderproductStatus == 0) {
                  return "text"; // 编辑模式
                }
              },
            },
            {
              field: "status",
              title: "状态",
              templet: function (res) {
                var html = "-";

                if (params.status == 0) {
                  html = '<span class="layui-badge layui-bg-blue">待确认入库信息</span>';
                } else if (params.status == 1) {
                  if (res.status == 0) {
                    html = '<span class="layui-badge layui-bg-blue">待入库</span>';
                  } else if (res.status == 1) {
                    html = '<span class="layui-badge layui-bg-green">已入库</span>';
                  }
                }

                return html;
              },
            },
            {
              title: "操作",
              align: "center",
              fixed: "right",
              toolbar: "#zkmes-invmgmt-inboundorder-in-form-toolbar-row",
            },
          ],
        ],
        done: function (res, curr, count) {
          //如果是异步请求数据方式，res即为你接口返回的信息。
          //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度

          var data = res.data;
          var inboundQty = 0;

          for (var i = 0; i < data.length; i++) {
            // 遍历数组，对每个元素进行操作
            inboundQty += data[i].inboundQty;
          }

          var tbcQty = parseFloat($("#inboundQty").val() - inboundQty).toFixed(2);
          if (tbcQty < 0) {
            layer.msg("超过需求数量,请检查");
          }

          $("#cfmdQty").val(parseFloat(inboundQty).toFixed(2));
          $("#tbcQty").val(tbcQty); 
        },
      });

      // 单元格编辑后的事件
      table.on("edit(zkmes-invmgmt-inboundorder-in-form-table)", function (obj) { 
        var data = obj.data; // 得到所在行所有键值 
 
        var divQty = data.remainingQty - data.inboundQty;

        if (divQty < 0) {
          layer.msg("超过最大值");
          layui.table.reloadData("zkmes-invmgmt-inboundorder-in-form-table"); //重载表格
          return;
        }
 
        var j = {
          inbatchId: data.inbatchId,
          inboundQty: data.inboundQty 
        };

        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
          url: prefix,
          type: "put",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(j),
          done: function (res) {
            //  layer.msg("修改成功");
            layui.table.reloadData("zkmes-invmgmt-inboundorder-in-form-table"); //重载表格
            layer.close(index); //执行关闭
          },
        });
 
      });

      //工具条
      table.on("tool(zkmes-invmgmt-inboundorder-in-form-table)", function (obj) {
        var data = obj.data;
        if (obj.event === "del") {
          layer.confirm("确定删除？", function (index) {
            admin.req({
              url: prefix + "/" + data.inbatchId,
              type: "delete",
              contentType: "application/json;charset=UTF-8",
              done: function (res) {
                layer.msg("删除成功");
                layui.table.reload("zkmes-invmgmt-inboundorder-in-form-table"); //重载表格
                layer.close(index); //执行关闭
              },
            });
          });
        } else if (obj.event === "sync") { 
          admin.req({
            url: prefix + "/sync",
            type: "post",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(data),
            done: function (res) {
              layer.alert(res.msg);
              layui.table.reloadData("zkmes-invmgmt-inboundorder-in-form-table"); //重载表格
            },
          });
        }
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-invmgmt-inboundorder-in-form-table)", function (obj) {
        switch (obj.event) {
          case "add":
            var data = {
              productId: $("#productId").val(),
            };

            admin.popup({
              title: "添加入库产品",
              area: "1500px",
              offset: "50px",
              id: "popup-zkmes-invmgmt-inboundorder-in-inbatch-form-add",
              success: function (layero, index) {
                view(this.id)
                  .render("zkmes/invmgmt/inboundorder/out/inbatch-form", data)
                  .done(function () {
                    form.render(null, "zkmes-invmgmt-inboundorder-in-inbatch-form");
                    //提交
                    form.on("submit(zkmes-invmgmt-inboundorder-in-inbatch-form-submit)", function (data) {
                      var field = data.field; //获取提交的字段

                      var tableData = table.getData("zkmes-invmgmt-inboundorder-in-form-table");

                      for (var i = 0; i < tableData.length; i++) {
                        if (tableData[i].inbatchId == field.inbatchId) {
                          layer.msg(tableData[i].inbatchId + "已选择，请重新选择。");
                          return;
                        }
                      }

                      field.inboundorderId = $("#inboundorderId").val();
                      field.inboundorderproductId = $("#inboundorderproductId").val();

                      //提交 Ajax 成功后，关闭当前弹层并重载表格
                      admin.req({
                        url: prefix,
                        type: "post",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(field),
                        done: function (res) {
                          layer.msg("新增成功");
                          layui.table.reload("zkmes-invmgmt-inboundorder-in-form-table"); //重载表格
                          layer.close(index); //执行关闭
                        },
                      });
                    });
                  });
              },
            });
            break;
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-invmgmt-inboundorder-in-form-table"); //重载表格
            break;
        }
      });

      form.render(null);
    });
  };

  layui.use(["admin", "form", "common"], function () {
    var $ = layui.$,
      util = layui.util,
      admin = layui.admin,
      common = layui.common,
      view = layui.view,
      table = layui.table,
      form = layui.form;

    //处理属性 为 lay-active 的所有元素事件
    util.event("lay-active", {
      cfmd: function (othis) {
        var tbcQty = $("#tbcQty").val();

        if (tbcQty != 0) {
          layer.msg("确认数量错误，请检查");
          return;
        }

        var tableData = table.getData("zkmes-invmgmt-inboundorder-in-form-table");
        
        var j = {
          inboundorderproductId: $("input[name='inboundorderproductId']").val(),
          status: 1,
          inbatchList: tableData
        };

        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
          url: "zkmes/invmgmt/inboundorder/product",
          type: "put",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(j),
          done: function (res) {
            layer.msg("修改成功");
          //  var submit = $("#zkmes-invmgmt-inboundorder-in-form-submit");
         //   submit.trigger("click");
          },
        });
      },
      review: function (othis) {},
    });
  });
</script>
