<div class="layui-form" lay-filter="zkmes-invmgmt-inboundorder-form" style="padding: 10px 30px 0 0">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">入库单号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            name="inboundorderId"
            placeholder="请输入"
            value="{{ d.params.inboundorderId || '' }}"
            lay-verify="required"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>

   

    <div class="layui-inline">
      <label class="layui-form-label">供应商</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchSupplier"
            lay-verify="required"
            readonly
            placeholder="请选择"
            value="{{ d.params.supplierName || '' }}"
            name="supplierName"
            lay-options="{split: true}"
            class="layui-input"
          />
      	</script>
      </div>
    </div> 
    
    <div class="layui-inline">
      <label class="layui-form-label">审核时间</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            name="reviewTime"
            placeholder="请输入"
            value="{{ d.params.reviewTime || '' }}" 
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>
    
  </div>

  <div class="layui-form-item">  
      <label class="layui-form-label">备注</label>
      <div class="layui-input-block">
        <script type="text/html" template>
          <input
            type="text"
            name="remark"
            placeholder="请输入"
            value="{{ d.params.remark || '' }}"
            autocomplete="off"
            class="layui-input"
          />
        </script>
      </div> 
  </div>

  <div class="layui-form-item">
    <table id="zkmes-invmgmt-inboundorder-form-table" lay-filter="zkmes-invmgmt-inboundorder-form-table"></table>
    <script type="text/html" id="zkmes-invmgmt-inboundorder-form-toolbar-head">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
    </script>
  
    <script type="text/html" id="zkmes-invmgmt-inboundorder-form-toolbar-row">  
 		{{# if(d.inboundorderStatus == 1){ }}
  	<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="in">设置仓库</a>
 	  {{# }else if(d.inboundorderStatus == 2){ 
					if(d.status == 0){ 
	  }}
 		<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="sync">同步</a> 
 		{{#		}else if(d.status == 1){ }}
  	<a class="layui-btn layui-btn-disabled layui-btn-xs">已同步</a>
   	{{# 	} }}
		{{#	} }}
	  
 
      
     
    </script>
   
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-block">
      <script type="text/html" template>
        {{# if(d.params.status == 1){ }}
        <input type="button" lay-active="cfmd" value="确认仓库" class="layui-btn layui-bg-blue" />
        {{# }else if(d.params. status == 2){ }}
        <input type="button" lay-active="pass" value="审核通过" class="layui-btn layui-bg-blue" />
        {{# } }}
      </script>
      <input
        type="button"
        id="zkmes-invmgmt-inboundorder-form-submit"
        lay-submit
        lay-filter="zkmes-invmgmt-inboundorder-form-submit"
        class="layui-btn layui-hide"
      />
    </div>
  </div>
</div>

<script type="text/html" template lay-done="zkmesInvmgmtInboundorderFormParamsDone(d.params)"></script>

<script>
zkmesInvmgmtInboundorderFormParamsDone = function (params) {
    layui.use(["admin", "form", "xmSelect"], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        table = layui.table,
        form = layui.form,
        util = layui.util,
        laydate = layui.laydate,
        xmSelect = layui.xmSelect;

      var prefix = "zkmes/invmgmt/inboundorder/product";

      table.render({
        elem: "#zkmes-invmgmt-inboundorder-form-table",
        url: prefix + "/list",
        where: {
          inboundorderId: params.inboundorderId,
        },
        toolbar: "#zkmes-invmgmt-inboundorder-form-toolbar-head",
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-450",
        cols: [
          [
            {type: 'numbers', title: '序号',align:'left' },
            { field: "productId", title: "物料编号" },
            { field: "productName", title: "名称" },
            { field: "modelName", title: "型号" },
            { field: "specName", title: "规格" },
            { field: "uomName", title: "单位" },
            { field: "inboundQty", title: "数量" },  
            { field: "createTime", title: "创建时间" },
            {
              title: "操作",
              width: 150,
              align: "center",
              fixed: "right",
              toolbar: "#zkmes-invmgmt-inboundorder-form-toolbar-row",
            },
          ],
        ],
      });

      //工具条
      table.on("tool(zkmes-invmgmt-inboundorder-form-table)", function (obj) {
        var data = obj.data;
        if (obj.event === "in") {
          admin.popup({
            title: "设置仓库",
            area: "1500px",
            offset: "110px",
            id: "popup-zkmes-invmgmt-inboundorder-in-form",
            success: function (layero, index) {
              view(this.id)
                .render("zkmes/invmgmt/inboundorder/in/form", data)
                .done(function () {
                  form.render(null, "zkmes-invmgmt-inboundorder-in-form");
                  //提交 
                  form.on("submit(zkmes-invmgmt-inboundorder-in-form-submit)", function (data) {
                    var field = data.field; //获取提交的字段

                    field.inboundorderproductId = obj.data.inboundorderproductId;

                    //提交 Ajax 成功后，关闭当前弹层并重载表格
                    admin.req({
                      url: prefix,
                      type: "put",
                      contentType: "application/json;charset=UTF-8",
                      data: JSON.stringify(field),
                      done: function (res) {
                        layer.msg("新增成功");
                        layui.table.reload("zkmes-invmgmt-inboundorder-form-table"); //重载表格
                        layer.close(index); //执行关闭
                      },
                    });
                  });
                });
            },
          });
        } else if (obj.event === "sync") {
          //确定仓库不为空
          if (data.warehouseId == null) {
            layer.msg("请选择仓库");
            return;
          }

          var j = {
            inboundorderId: $("input[name='inboundorderId']").val(),
            inboundorderproductId: data.inboundorderproductId,
            warehouseId: data.warehouseId,
            productId: data.productId,
            inboundQty: data.inboundQty,
          };

          admin.req({
            url: prefix + "/sync",
            type: "post",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(j),
            done: function (res) {
              layer.msg(res.msg);
              layui.table.reloadData("zkmes-invmgmt-inboundorder-form-table"); //重载表格
            },
          });
        }
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-invmgmt-inboundorder-form-table)", function (obj) {
        switch (obj.event) {
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-invmgmt-inboundorder-form-table"); //重载表格
            break;
        }
      });
 
      form.render(null);
 
    });
  };

  layui.use(["admin", "form", "common"], function () {
    var $ = layui.$,
      admin = layui.admin,
      table = layui.table,
      common = layui.common,
      util = layui.util,
      view = layui.view,
      form = layui.form;
    
    //处理属性 为 lay-active 的所有元素事件
    util.event("lay-active", {
      cfmd: function (othis) {
        var tableData = table.getData("zkmes-invmgmt-inboundorder-form-table");
 
        for (var i = 0; i < tableData.length; i++) {
          if (tableData[i].warehouseId == null) {
            layer.msg(tableData[i].productId + "未设置仓库，请设置。");
            return;
          }
        }

        var j = {
          inboundorderId: $("input[name='inboundorderId']").val(),
          status: 2,
        };

        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
          url: "zkmes/invmgmt/inboundorder",
          type: "put",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(j),
          done: function (res) {
            layer.msg("成功");
            var submit = $("#zkmes-invmgmt-inboundorder-form-submit");
            submit.trigger("click");
          },
        });
      },
      pass: function (othis) {
         
        var tableData = table.getData("zkmes-invmgmt-inboundorder-form-table");
        
        for (var i = 0; i < tableData.length; i++) {
            if(tableData[i].status != "1"){
          	layer.msg(tableData[i].productId + "未入库，请确认。"); 
            	return ;
            }
        }
         
        var j = {
          inboundorderId: $("input[name='inboundorderId']").val(),
       	  status: 3
       };
        
        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
      	  url: "zkmes/invmgmt/inboundorder" 
          , type: 'put'
          , contentType: 'application/json;charset=UTF-8'
          , data: JSON.stringify(j)
          , done: function (res) {
          	layer.msg("成功");
          	 var submit = $("#zkmes-invmgmt-inboundorder-form-submit");
               submit.trigger("click");
          }
        });  
        
        
        
        
      },
    });
    
    
  });
</script>
