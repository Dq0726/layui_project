<div class="layui-form" lay-filter="zkmes-invmgmt-finishedin-edit-form" style="padding: 10px 30px 0 0">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">入库单号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="inboundorderId"
            name="inboundorderId"
            placeholder="请输入"
            value="{{ d.params.inboundorderId || '' }}"
            lay-verify="required"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">交货日期</label>
      <div class="layui-input-inline">
         <input
          type="text"
          id="ID-laydate-deliverydate"
          placeholder="请输入"
          name="deliverydate"
          autocomplete="off"
          class="layui-input"
        />
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">供应商</label>
      <div class="layui-input-inline">
                <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchSupplier"
            lay-verify="required"
            readonly
            placeholder="请选择"
            value="{{ d.params.supplierName || '' }}"
            name="supplierName"
            lay-options="{split: true}"
            class="layui-input"
          />
          </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">仓库</label>
      <div class="layui-input-inline">
                <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchWarehouse"
            lay-verify="required"
            readonly
            placeholder="请选择"
            value="{{ d.params.warehouseName || '' }}"
            name="warehouseName"
            lay-options="{split: true}"
            class="layui-input"
          />
          </script>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">总价(元)</label>
      <div class="layui-input-inline">
      <div style="display: flex">
        <script type="text/html" template>
          <input
            type="text"
 						id="totalPrice"
            name="totalPrice"
            placeholder="请输入"
            value="{{ d.params.totalPrice || '' }}" 
            autocomplete="off"
            class="layui-input" 
          />
 		 		<button type="button" class="layui-btn" lay-on="comp">计算</button>
        </script>
        </div>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">是否含税</label>
      <div class="layui-input-inline">
        <input type="radio" name="tax" value="0" title="是" />
        <input type="radio" name="tax" value="1" title="否" />
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">备注</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            name="remark"
            placeholder="请输入"
            value="{{ d.params.remark || '' }}"
            autocomplete="off"
            class="layui-input"
          />
        </script>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <table id="zkmes-invmgmt-finishedin-edit-form-table" lay-filter="zkmes-invmgmt-finishedin-edit-form-table"></table>
    <script type="text/html" id="zkmes-invmgmt-finishedin-edit-form-toolbar-head">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
    </script>

    <script type="text/html" id="zkmes-invmgmt-finishedin-edit-form-toolbar-row">
      {{# if(d.status == 0){ }}
      <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="sync">同步</a>
      {{# }else{ }}
      <a class="layui-btn layui-btn-disabled layui-btn-xs">已同步</a>
      {{# } }}
    </script>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-inline">
      <input
        type="button"
        id="zkmes-invmgmt-finishedin-edit-form-submit"
        lay-submit
        lay-filter="zkmes-invmgmt-finishedin-edit-form-submit"
        value="确认"
        class="layui-btn"
      />
    </div>
  </div>
</div>

<script type="text/html" template lay-done="layui.data.sendZkmesInvmgmtPurchaseinEditFormParams(d.params)"></script>

<script>
  layui.data.sendZkmesInvmgmtPurchaseinEditFormParams = function (params) {
    layui.use(["admin", "form", "xmSelect"], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        table = layui.table,
        form = layui.form,
        laydate = layui.laydate,
        util = layui.util,
        xmSelect = layui.xmSelect;

      //alert(params.purchaseorderId);
      //执行重载
      table.reloadData("zkmes-invmgmt-finishedin-edit-form-table", {
        url: "zkmes/invmgmt/finishedin/product/list", 
        where: {
        	inboundorderId: params.inboundorderId,
        },
      });
      
      // 普通事件
      util.on("lay-on", {
        // 获取验证码
        comp: function (othis) {
          // 获取当前页接口数据
          var dataArr = table.getData("zkmes-invmgmt-finishedin-edit-form-table");

          var totalPrice = 0.0;

          for (var i = 0; i < dataArr.length; i++) {
            totalPrice += parseFloat(dataArr[i].amount);
          }

          $("#totalPrice").val(totalPrice);
        },
      });

      laydate.render({
          elem: "#ID-laydate-deliverydate",
          value: params.deliverydate,
          isInitValue: true,
          type: "date",
          fullPanel: true,
          done: function (value, date, endDate) {
            //console.log(value); // 日期字符，如： 2017-08-18
            // console.log(date); // 包含年月日时分秒各项值的对象
            // console.log(endDate); // 结束日期时间对象，当设置 range 时才会返回。对象成员同上。
            // var rshours = $("#rshours").val();
            // var currentDate = new Date(value);
            // currentDate.setHours(currentDate.getHours() + parseInt(rshours));
            // var result = util.toDateString(currentDate);
            // $("#endtime").val(result);
          },
        });
      
      
      form.on("input-affix(searchSupplier)", function (data) {
          admin.popup({
              title: "选择供应商",
              area: "1500px",
              offset: "110px",
              id: "popup-zkmes-invmgmt-finishedin-edit-form-supplier",
              success: function (layero, index) {
                  view(this.id)
                      .render("zkmes/invmgmt/finishedin/supplier-form")
                      .done(function () {
                          form.render(null, "zkmes-invmgmt-finishedin-supplier-form");
                          //提交
                          form.on(
                              "submit(zkmes-invmgmt-finishedin-supplier-form-submit)",
                              function (data) {
                                  var field = data.field; //获取提交的字段
                                  form.val("zkmes-invmgmt-finishedin-edit-form", field);
                                  layer.msg("选择成功");
                                  layer.close(index); //执行关闭
                              }
                          );
                      });
              },
          });
      });

      form.on("input-affix(searchWarehouse)", function (data) {
          admin.popup({
              title: "选择仓库",
              area: "1500px",
              offset: "110px",
              id: "popup-zkmes-invmgmt-finishedin-edit-form-warehouse",
              success: function (layero, index) {
                  view(this.id)
                      .render("zkmes/invmgmt/finishedin/warehouse-form")
                      .done(function () {
                          form.render(null, "zkmes-invmgmt-finishedin-warehouse-form");
                          //提交
                          form.on(
                              "submit(zkmes-invmgmt-finishedin-warehouse-form-submit)",
                              function (data) {
                                  var field = data.field; //获取提交的字段
                                  console.log(field,'warehouse');
                                  form.val("zkmes-invmgmt-finishedin-edit-form", field);
                                  layer.msg("选择成功");
                                  layer.close(index); //执行关闭
                              }
                          );
                      });
              },
          });
      });

      if (params.tax == null) {
        $("input[name=tax][value=0]").attr("checked", true);
      } else {
        $("input[name=tax][value=0]").attr("checked", params.tax == 0 ? true : false);
        $("input[name=tax][value=1]").attr("checked", params.tax == 1 ? true : false);
      }

      form.render(null);
    });
  };

  layui.use(["admin", "form", "common"], function () {
    var $ = layui.$,
      util = layui.util,
      admin = layui.admin,
      common = layui.common,
      view = layui.view,
      table = layui.table,
      form = layui.form;

    var prefix = "zkmes/invmgmt/finishedin/product";

    table.render({
      elem: "#zkmes-invmgmt-finishedin-edit-form-table",
      data: [],
      toolbar: "#zkmes-invmgmt-finishedin-edit-form-toolbar-head",
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-450",
      cols: [
        [
          { field: "productId", title: "物料编号" },
          { field: "productName", title: "名称" },
          { field: "modelName", title: "型号" },
          { field: "specName", title: "规格" },
          { field: "uomName", title: "单位" },

          {
            field: "inboundQty",
            title: "数量",
            edit: function (d) {
              if (d.status == 0) {
                return "text"; // 编辑模式
              }
            },
          },
          {
            field: "unitPrice",
            title: "单价",
            edit: function (d) {
              if (d.status == 0) {
                return "text"; // 编辑模式
              }
            },
          },
          { field: "amount", title: "金额" },

          { field: "createTime", title: "创建时间" },
          {
            title: "操作",
            width: 180,
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-invmgmt-finishedin-edit-form-toolbar-row",
          },
        ],
      ],
    });

    // 单元格编辑后的事件
    table.on("edit(zkmes-invmgmt-finishedin-edit-form-table)", function (obj) {
      var field = obj.field; // 得到修改的字段
      var value = obj.value; // 得到修改后的值
      var oldValue = obj.oldValue; // 得到修改前的值 -- v2.8.0 新增
      var data = obj.data; // 得到所在行所有键值
      var col = obj.getCol(); // 得到当前列的表头配置属性 -- v2.8.0 新增

      // 值的校验
      if (value.replace(/\s/g, "") === "") {
        layer.tips("值不能为空", this, { tips: 1 });
        return obj.reedit(); // 重新编辑 -- v2.8.0 新增
      }
      // 编辑后续操作，如提交更新请求，以完成真实的数据更新
      // …
      // var amount = util.escape(value) * util.escape(data.inboundQty)

      var j = {
        inboundorderproductId: data.inboundorderproductId,
        inboundQty: data.inboundQty,
        unitPrice: data.unitPrice,
        amount: parseFloat(parseFloat(data.unitPrice) * parseFloat(data.inboundQty)).toFixed(2),
      };

      //提交 Ajax 成功后，关闭当前弹层并重载表格
      admin.req({
        url: prefix,
        type: "put",
        contentType: "application/json;charset=UTF-8",
        data: JSON.stringify(j),
        done: function (res) {
          //  layer.msg("修改成功");
          layui.table.reloadData("zkmes-invmgmt-finishedin-edit-form-table"); //重载表格
          layer.close(index); //执行关闭
        },
      });

      // 显示 - 仅用于演示
      // layer.msg('[ID: '+ data.purchaseorderId +'] ' + field + ' 字段更改值为：'+ util.escape(value));
    });

    //工具条
    table.on("tool(zkmes-invmgmt-finishedin-edit-form-table)", function (obj) {
      var data = obj.data;
      if (obj.event === "del") {
        layer.confirm("确定删除？", function (index) {
          admin.req({
            url: prefix + "/" + data.inboundorderId,
            type: "delete",
            contentType: "application/json;charset=UTF-8",
            done: function (res) {
              layer.msg("删除成功");
              layui.table.reload("zkmes-invmgmt-finishedin-edit-form-table"); //重载表格
              layer.close(index); //执行关闭
            },
          });
        });
      } else if (obj.event === "sync") {

   	   	var j = {
   	   		inboundorderproductId: data.inboundorderproductId,
	        productId: data.productId,
	        inboundQty: data.inboundQty,
	    };
        
        admin.req({
          url: prefix + "/sync",
          type: "post",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(j),
          done: function (res) {
        	  
       
        	  layer.msg(res.msg);
              layui.table.reloadData("zkmes-invmgmt-finishedin-edit-form-table"); //重载表格

            
          },
        });
      }
    });

    // 头部工具栏点击事件
    table.on("toolbar(zkmes-invmgmt-finishedin-edit-form-table)", function (obj) {
      switch (obj.event) {
        case "add":
          admin.popup({
            title: "添加成品入库产品信息",
            area: "1500px",
            offset: "110px",
            id: "popup-zkmes-invmgmt-finishedin-edit-form-add",
            success: function (layero, index) {
              view(this.id)
                .render("zkmes/invmgmt/finishedin/product-form")
                .done(function () {
                  form.render(null, "zkmes-invmgmt-finishedin-product-form");
                  //提交
                  form.on("submit(zkmes-invmgmt-finishedin-product-form-submit)", function (data) {
                    var field = data.field; //获取提交的字段
  
                    field.inboundorderId = $("#inboundorderId").val();
  
                    //提交 Ajax 成功后，关闭当前弹层并重载表格
                    admin.req({
                      url: prefix,
                      type: "post",
                      contentType: "application/json;charset=UTF-8",
                      data: JSON.stringify(field),
                      done: function (res) {
                        layer.msg("新增成功");
                        layui.table.reload("zkmes-invmgmt-finishedin-edit-form-table"); //重载表格
                        layer.close(index); //执行关闭
                      },
                    });
                  });
                });
            },
          });
          break;
        case "delete":
          layer.msg("删除");
          break;
        case "update":
          layer.msg("编辑");
          break;
        case "LAYTABLE_TIPS":
          layer.msg("提示");
          break;
        case "refresh":
          layui.table.reloadData("zkmes-invmgmt-finishedin-edit-form-table"); //重载表格
          break;
      }
    });
  });
</script>
