<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>系统管理</cite></a>
    <a><cite>角色管理</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body">
      <table id="system-role-table" lay-filter="system-role-table"></table>

      <script type="text/html" id="system-role-toolbar-head">
	    <div class="layui-btn-container"> 
		  <button class="layui-btn layui-btn-sm" lay-event="add">新增角色</button> 
		  <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
	    </div>
	  </script>

      <script type="text/html" id="system-role-toolbar-row">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
      </script>

    </div>
  </div>
</div>

<script>
  layui.use(['admin', 'table', 'common'], function () {
    var $ = layui.$
      , admin = layui.admin
      , view = layui.view
      , table = layui.table
      , common = layui.common
      , form = layui.form;


    var prefix = "system/role";

    // 调用 common.js 模块 getPopupSize 函数，用 ES6 解构赋值获取返回的两个参数
    const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();

    //角色管理
    table.render({
      elem: '#system-role-table'
      , url: prefix + '/list'
      , toolbar: '#system-role-toolbar-head'
      , defaultToolbar: ['filter', 'print', 'exports', {
        title: '提示',
        layEvent: 'LAYTABLE_TIPS',
        icon: 'layui-icon-tips'
      }]
      , height: 'full-200'
      , cols: [[
        { field: 'roleId', title: '角色编号' }
        , { field: 'roleName', title: '角色名' }
        , { field: 'roleKey', title: '权限字符' }
        , { field: 'roleSort', title: '显示顺序' }
        , {
          field: 'status', title: '状态', templet: function (res) {

            var checked = res.status == 0 ? "checked" : "";
            var html = '<input type="checkbox" name="status"  lay-filter="system-role-table-status" lay-skin="switch" lay-text="ON|OFF" ' + checked + '>';
            return html;
          }
        }
        , { field: 'createTime', title: '创建时间' }
        , { title: '操作', width: 160, align: 'center', fixed: 'right', toolbar: '#system-role-toolbar-row' }
      ]]
    });

    //工具条
    table.on('tool(system-role-table)', function (obj) {
      var data = obj.data;
      if (obj.event === 'del') {
        layer.confirm('确定删除此角色？', function (index) {
          admin.req({
            url: prefix + "/" + data.roleId
            , type: 'delete'
            , contentType: 'application/json;charset=UTF-8'
            , done: function (res) {
              layer.msg("删除成功");
              layui.table.reload('system-role-table'); //重载表格
              layer.close(index); //执行关闭 
            }
          });
        });
      } else if (obj.event === 'edit') {
        admin.popup({
          title: '修改角色'
          , area: popupWidthHeight
          , offset: popupOffsetWidthHeight
          , id: 'popup-system-role-edit'
          , success: function (layero, index) {


            var menuIds = [];


            //提交 Ajax 成功后，关闭当前弹层并重载表格
            admin.req({
              url: "system/menu/roleMenuTreeselect/2"
              , type: 'get'
              , contentType: 'application/json;charset=UTF-8'
              , async: false
              , done: function (res) {
                menuIds = res.checkedKeys
              }
            });


            data.menuIds = menuIds;


            view(this.id).render('system/role/form', data).done(function () {
              form.render(null, 'system-role-form');

              //提交
              form.on('submit(system-role-form-submit)', function (data) {
                var field = data.field; //获取提交的字段
                field.status = field.status ? 0 : 1;
                field.menuIds = field.menuIds.split(",");

                //提交 Ajax 成功后，关闭当前弹层并重载表格
                admin.req({
                  url: prefix
                  , type: 'put'
                  , contentType: 'application/json;charset=UTF-8'
                  , data: JSON.stringify(field)
                  , done: function (res) {
                    layer.msg("修改成功");
                    layui.table.reload('system-role-table'); //重载表格
                    layer.close(index); //执行关闭 
                  }
                });
              });
            });
          }
        });
      }
    });


    //  var offseth = $('.layui-header').outerHeight() + $('.layui-breadcrumb').outerHeight();
    //  var h = $(window).height() - offseth; 

    var h = $(window).height()

    var offsetw = $('.layui-side').outerWidth();
    var w = $(window).width() - offsetw;

    // 头部工具栏点击事件
    table.on('toolbar(system-role-table)', function (obj) {
      switch (obj.event) {
        case 'add':
          admin.popup({
            title: '添加角色'
            , area: popupWidthHeight
            , offset: popupOffsetWidthHeight

            , id: 'popup-system-role-add'
            , success: function (layero, index) {
              view(this.id).render('system/role/form').done(function () {
                form.render(null, 'system-role-form');
                //提交
                form.on('submit(system-role-form-submit)', function (data) {
                  var field = data.field; //获取提交的字段 
                  field.status = field.status ? 0 : 1;
                  field.menuIds = field.menuIds.split(",");
 
                  //提交 Ajax 成功后，关闭当前弹层并重载表格
                  admin.req({
                    url: prefix
                    , type: 'post'
                    , contentType: 'application/json;charset=UTF-8'
                    , data: JSON.stringify(field)
                    , done: function (res) {
                      layer.msg("新增成功");
                      layui.table.reload('system-role-table'); //重载表格
                      layer.close(index); //执行关闭 
                    }
                  });
                });
              });
            }
          });
          break;
        case 'delete':
          layer.msg('删除');
          break;
        case 'update':
          layer.msg('编辑');
          break;
        case 'LAYTABLE_TIPS':
          layer.msg('提示');
          break;
        case "refresh":
            layui.table.reloadData("system-role-table"); //重载表格
            layer.msg('刷新成功');
            break;
      }
    });


    form.on('switch(system-role-table-status)', function (data) {
      var checked = data.elem.checked;

      alert(checked);

      form.render();
    });


  });
</script>