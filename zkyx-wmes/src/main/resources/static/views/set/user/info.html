<title>设置我的资料</title>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>设置</cite></a>
    <a><cite>我的资料</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-row layui-col-space15">
    <div class="layui-col-md12">
      <div class="layui-card">
        <div class="layui-card-header">设置我的资料</div>
        <div class="layui-card-body" pad15>
          <div class="layui-form" lay-filter="user_info_form">
            <div class="layui-form-item">
              <label class="layui-form-label">我的角色</label>
              <div class="layui-input-inline">
                <input type="text" name="role_name" readonly class="layui-input">
              </div>
              <div class="layui-form-mid layui-word-aux">当前角色不可更改为其它角色</div>
            </div>

            <div class="layui-form-item">

              <div class="layui-form-item">
                <label class="layui-form-label">我的部門</label>
                <div class="layui-input-inline">
                  <input type="text" name="dept_name" readonly class="layui-input">
                </div>
                <div class="layui-form-mid layui-word-aux">当前角色不可更改为其它部门</div>
              </div>


            </div>

            <div class="layui-form-item">
              <label class="layui-form-label">用户名</label>
              <div class="layui-input-inline">
                <input type="text" name="user_name" value="" readonly class="layui-input">
              </div>
              <div class="layui-form-mid layui-word-aux">不可修改。一般用于后台登入名</div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">昵称</label>
              <div class="layui-input-inline">
                <input type="text" name="nick_name" value="" lay-verify="nickname" autocomplete="off"
                  placeholder="请输入昵称" class="layui-input">
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">性别</label>
              <div class="layui-input-block">
                <input type="radio" name="sex" value=1 title="男">
                <input type="radio" name="sex" value=2 title="女">
                <input type="radio" name="sex" value=0 title="未知" checked>
                <input type="radio" name="sex" value=9 title="未说明">
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">头像</label>
              <div class="layui-input-inline">
              
                <input name="avatar" lay-verify="required" id="LAY_avatarSrc" placeholder="图片地址"
                  value="https://sentsin.gitee.io/res/images/demo/layer.png" class="layui-input">
              </div>
              <div class="layui-input-inline layui-btn-container" style="width: auto;">
                <button type="button" class="layui-btn layui-btn-primary" id="LAY_avatarUpload">
                  <i class="layui-icon">&#xe67c;</i>上传图片
                </button>
                <button class="layui-btn layui-btn-primary" layadmin-event="avartatPreview">查看图片</button>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">手机</label>
              <div class="layui-input-inline">
                <input type="text" name="cellphone" value="" lay-verify="phone" autocomplete="off" class="layui-input">
              </div>
            </div>

            <div class="layui-form-item">
              <label class="layui-form-label">固定电话</label>
              <div class="layui-input-inline">
                <input type="text" name="telephone" value="" autocomplete="off" class="layui-input">
              </div>
            </div>


            <div class="layui-form-item">
              <label class="layui-form-label">邮箱</label>
              <div class="layui-input-inline">
                <input type="text" name="email" value="" lay-verify="email" autocomplete="off" class="layui-input">
              </div>
            </div>
            <div class="layui-form-item layui-form-text">
              <label class="layui-form-label">备注</label>
              <div class="layui-input-block">
                <textarea name="remarks" placeholder="请输入内容" class="layui-textarea"></textarea>
              </div>
            </div>
            <div class="layui-form-item">
              <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="setmyinfo">确认修改</button>
                <button type="reset" class="layui-btn layui-btn-primary">重新填写</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  layui.data.done = function (d) {

    layui.use(['form'], function () {
      var form = layui.form;
      form.render("select", 'user_info_form'); //渲染该模板下的动态表单
    });
  };
</script>



<script>
  layui.use(['form', 'upload'
  ], function () {
    var $ = layui.$
      , layer = layui.layer
      , laytpl = layui.laytpl
      , setter = layui.setter
      , view = layui.view
      , admin = layui.admin
      , form = layui.form
      , upload = layui.upload;

    var $body = $('body');

    form.render();

    //自定义验证
    form.verify({
      nick_name: function (value, item) { //value：表单的值、item：表单的DOM对象
        if (!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)) {
          return '用户名不能有特殊字符';
        }
        if (/(^\_)|(\__)|(\_+$)/.test(value)) {
          return '用户名首尾不能出现下划线\'_\'';
        }
        if (/^\d+\d+\d$/.test(value)) {
          return '用户名不能全为数字';
        }
      }

    });
    //请求登入接口
    admin.req({
      url: '/system/user/profile' //实际使用请改成服务端真实接口
      , type: 'get'
      , contentType: 'application/json;charset=UTF-8'
      , done: function (res) {
 
        form.val("user_info_form",
          {
            role_name: res.roleGroup,
            /* dept_name: dept_name,*/
             user_name: res.data.userName,
            nick_name: res.data.nickName,
            sex: res.data.sex,
            avatar: res.data.avatar,
            cellphone: res.data.cellphone,
            telephone: res.data.telephone,
            email: res.data.email,
            remarks: res.data.remarks, 
          });
      }
    });


    //设置我的资料
    form.on('submit(setmyinfo)', function (obj) {

      //请求登入接口
      admin.req({
        url: '/inet/services/user/users' //实际使用请改成服务端真实接口
        , type: 'post'
        , contentType: 'application/json;charset=UTF-8'
        , data: JSON.stringify(obj.field)
        , done: function (res) {
          layer.msg("修改成功");

        }
      });
      return false;
    });

    //上传头像
    var avatarSrc = $('#LAY_avatarSrc');
    upload.render({
      url: '/system/user/profile/avatar'
      , elem: '#LAY_avatarUpload'
      , done: function (res) {
        if (res.status == 0) {
          avatarSrc.val(res.url);
        } else {
          layer.msg(res.msg, { icon: 5 });
        }
      }
    });

    //查看头像
    admin.events.avartatPreview = function (othis) {
      var src = avatarSrc.val();
      layer.photos({
        photos: {
          "title": "查看头像" //相册标题
          , "data": [{
            "src": src //原图地址
          }]
        }
        , shade: 0.01
        , closeBtn: 1
        , anim: 5
      });
    };
 
  })
</script>