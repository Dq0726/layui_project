<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    #canvas {
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <script type="text/html" template>
      <link
        rel="stylesheet"
        href="{{ layui.setter.paths.core }}css/login.css?v={{ layui.admin.v }}"
        media="all"
      />
    </script>

  <div class="layadmin-user-login layadmin-user-display-show" id="LAY-user-login" style="display: none">
    <div class="layadmin-user-login-main">
      <div class="layadmin-user-login-box layadmin-user-login-header">
        <div class="login-header">
          <div class="login-header-cont">
            <div class="header-cont-text">中科MES智能生产管理系统</div>
          </div>
        </div>

      </div>
        <div class="login-body-cont">
          <div class="login-body-contmain">
            <div class="contmain-top">
              <div class="login-text">欢迎登录</div>
            </div>
            <div class="contmain-bottom"  lay-filter="uia-login-form">
              <div class="layadmin-user-login-box layadmin-user-login-body layui-form">
                <div class="layui-form-item">
                  <label class="layadmin-user-login-icon layui-icon layui-icon-username"
                    for="LAY-user-login-username"></label>
                  <input type="text" name="username" id="LAY-user-login-username" lay-verify="required"
                    placeholder="用户名" class="layui-input" />
                </div>
                <div class="layui-form-item">
                  <label class="layadmin-user-login-icon layui-icon layui-icon-password"
                    for="LAY-user-login-password"></label>
                  <input type="password" name="password" id="LAY-user-login-password" lay-verify="required"
                    placeholder="密码" class="layui-input" />
                </div>
                <div class="layui-form-item">
                  <div class="layui-row">
                    <div class="layui-col-xs7">
                      <label class="layadmin-user-login-icon layui-icon layui-icon-vercode"
                        for="LAY-user-login-vercode"></label>
                      <input type="text" name="code" id="LAY-user-login-vercode" lay-verify="required"
                        placeholder="图形验证码" class="layui-input" />
                    </div>
                    <div class="layui-col-xs5">
                      <div style="margin-left: 10px">
                        <img src="" class="imgcode" width="100" lay-on="codeChange" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="layui-form-item" style="margin-bottom: 20px">
                  <input type="checkbox" name="remember" lay-skin="primary" title="记住密码" />
                  <a class="main-text layadmin-user-jump-change layadmin-link main-text" lay-on="forget"
                    style="margin-top: 7px;cursor: pointer;">忘记密码？</a>
                </div>
                <div class="layui-form-item">
                  <button class="layui-btn layui-btn-fluid main-btn" lay-submit lay-filter="LAY-user-login-submit">
                    登 入
                  </button>
                </div>
                <div class="layui-trans layui-form-item layadmin-user-login-other">
                  <a class="main-text layadmin-user-jump-change layadmin-link" lay-on="register" style=";cursor: pointer;">注册帐号</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      <div class="layui-trans layadmin-user-login-footer">
        <p>© All Rights Reserved</p>
      </div>
    </div>
  </div>

  <script>
    layui.use(["admin", "form", "uia", "common", "util"], function () {
      var $ = layui.$,
        setter = layui.setter,
        admin = layui.admin,
        form = layui.form,
        router = layui.router(),
        search = router.search,
        util = layui.util,
        view = layui.view,
        common = layui.common;
      

      form.render();

      var uuid = "";
      


      // 封装验证码刷新函数
      function refreshCaptcha() {
        admin.req({
          url: "/captchaImage?type=math&s=" + Math.random(),
          type: "get",
          contentType: "application/json;charset=UTF-8",
          done: function (res) {
            uuid = res.uuid;
            $(".imgcode").attr("src", "data:image/png;base64," + res.img);
          },
        });
      }

      // 初始化验证码
      refreshCaptcha();

      //提交
      form.on("submit(LAY-user-login-submit)", function (obj) {
         
        var code = obj.field["code"];
        var password = obj.field["password"];
        obj.field["uuid"] = uuid;

        // var pwd = common.aes(password, code);
        // obj.field["password"] = pwd;

        //验证码判断
        /*       if(code != num){
          layer.msg('验证码错误,请重新输入', {
          offset: '15px'
         ,icon: 5
         });
         return
        } */

        //请求登入接口
        admin.req({
          url: "/login", //实际使用请改成服务端真实接口
          type: "post",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(obj.field),
          success: function (res) {
        	  console.log(res.code);
						if(res.code == 200) {
				 		//请求成功后，写入 access_token
	            layui.data(setter.tableName, {
	              key: setter.request.tokenName,
	              value: res.token,
	            });

	            admin.setComponentsToken();

	            //登入成功的提示与跳转
	            layer.msg(
	              "登入成功",
	              {
	                offset: "15px",
	                icon: 1,
	                time: 1000,
	              },
	              function () {
	                location.hash = search.redirect
	                  ? decodeURIComponent(search.redirect)
	                  : "/";
	              }
	          
	            );
						}else {
				 // 登录失败时刷新验证码 
	            refreshCaptcha();
	            layer.msg(res.msg || "登录失败，验证码已刷新", { icon: 2 });
						}
           
           
          },
          error: function (res) {
        	  
          	alert(111);
            // 登录失败时刷新验证码
            refreshCaptcha();
            layer.msg(res.msg || "登录失败，验证码已刷新", { icon: 2 });
          },
        });
      });
      util.on("lay-on", {
        codeChange: refreshCaptcha,  // 使用统一的验证码刷新函数
        //注册 
        register: function () {
          admin.popup({
        	  title: "用户注册",
            area: "500px",
            offset: "200px",
            id: "popup-uia-register-form",
            success: function (layero, index) { 
          	  // 找到弹框最外层DOM并赋私有类名，方便后续对弹窗内容更改样式
                $(layero).find('.layui-layer-title')
                  .addClass('register-class');
            	view(this.id)
                .render("uia/register-form")
                .done(function (res) { 
                	form.render(null, "uia-register-form");  
                   //提交
                    form.on(
                      "submit(uia-register-form-submit1)",
                      function (data) {
                        var field = data.field;
                      
                    	  //请求接口
                        admin.req({
                          url: '/register' 
                          , type: 'post'
                          , contentType: 'application/json;charset=UTF-8'
                          , data: JSON.stringify(field) 
                          ,done: function(res){        
                            layer.msg('注册成功', {
                              offset: '15px'
                              ,icon: 1
                              ,time: 1000
                            }, function(){
                            
                            });
                            
                         	 layer.close(index); //执行关闭
                          }
                        });
                    	  
                    	  
                      }
                    ); 
                })
            },
          });
        },
        forget: function () { 
        	layer.msg('如需重置密码，请联系相关支持人员进行处理');
		/* admin.popup({
              title: "忘记密码",
              area: "500px",
              offset: "100px",
              id: "popup-uia-forget-form",
              success: function (layero, index) { 
            	  view(this.id)
                  .render("uia/forget-form")
                  .done(function (res) {
                  	 
                  	form.render(null, "uia-forget-form"); 
      
                    //提交
                    form.on(
                      "submit(uia-register-form-submit)",
                      function (data) {
      
                    	  
                      }
                    );
                  })
              },
            }); */
          },
      });
      //页面中部内容formDom及背景动态初始化
      let formDom = ()=> {
          var winHeight = $(window).height();        
          $('#LAY-user-login').css('height', winHeight);     
          // 补全右括号和分号
          $(window).resize(function() {  
              winHeight = $(window).height();        
              $('#LAY-user-login').css('height', winHeight); 
          }); 
      } 
      formDom();
      
    });
  </script>
</body>

</html>