<title>生产报工</title>

<style>
  .grid-demo {
    text-align: center;
    color: #000;
  }

  .layadmin-dataview {
    height: 180px !important;
  }
</style>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>中科MES</cite></a>
    <a><cite>生产管理</cite></a>
    <a><cite>生产报工</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card" style="padding-top: 10px">
    <div class="layui-card-header">
      <div class="layui-row layui-col-space1">
        <div class="layui-col-md3">
          <label class="layui-form-label">任务编号</label>
          <div class="layui-input-inline"> 
              <input
                type="text"
                id="productiontaskId"
                name="productiontaskId"
                placeholder="请输入" 
                lay-verify="required"
                autocomplete="off"
                class="layui-input"
              /> 
          </div>
        </div>

        <div class="layui-col-md3">
          <label class="layui-form-label">订单编号</label>
          <div class="layui-input-inline"> 
              <input
                type="text"
                id="productiontaskId"
                name="productiontaskId"
                placeholder="请输入" 
                lay-verify="required"
                autocomplete="off"
                class="layui-input"
              /> 
          </div>
        </div>
        <div class="layui-col-md3">
          <label class="layui-form-label">报工状态</label>
          <div class="layui-input-inline"> 
              <input
                type="text"
                id="productiontaskId"
                name="productiontaskId"
                placeholder="请输入" 
                lay-verify="required"
                autocomplete="off"
                class="layui-input"
              /> 
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="layui-input-wrap" style="text-align:center">
            <button class="layui-btn" lay-submit lay-filter="demo-table-search">查询</button>
          </div>
        </div>
      </div>
    </div>

    <div class="layui-card-body">
      <div class="layui-row layui-col-space1">
        <div class="layui-col-md4">
          <div class="grid-demo grid-demo-bg1">
            <div>
              <h2>未开工任务数量</h2>
            </div>
            <div>
              <div class="layadmin-dataview" data-anim="fade">
                <div id="LAY-index-notworkingtask" style="height: 100%">
                  <i class="layui-icon layui-icon-loading1 layadmin-loading"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="layui-col-md4">
          <div class="grid-demo grid-demo-bg1">
            <div>
              <h2>已报工任务数量</h2>
            </div>
            <div>
              <div class="layadmin-dataview" data-anim="fade">
                <div id="LAY-index-workingtask" style="height: 100%">
                  <i class="layui-icon layui-icon-loading1 layadmin-loading"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="layui-col-md4">
          <div class="grid-demo grid-demo-bg1">
            <div>
              <h2>已暂停任务数量</h2>
            </div>
            <div>
              <div class="layadmin-dataview" data-anim="fade">
                <div id="LAY-index-pauseworkingtask" style="height: 100%">
                  <i class="layui-icon layui-icon-loading1 layadmin-loading"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr />

      <table
        id="zkmes-productionmgmt-productionrepor-table"
        lay-filter="zkmes-productionmgmt-productionrepor-table"
      ></table>

      <script type="text/html" id="zkmes-productionmgmt-productionrepor-toolbar-row">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"
          ><i class="layui-icon layui-icon-edit"></i>开工</a
        >
      </script>
    </div>
  </div>
</div>

<script>
  ///数据概览1
  layui.use(["admin", "echarts"], function () {
    var $ = layui.$,
      admin = layui.admin,
      echarts = layui.echarts;

    var echartsApp = [],
      options = {
        series: [
          {
            type: "gauge",
            min: 0,
            max: 250,
            pointer: {
              show: false,
            },
            progress: {
              show: true,
            },
            axisLine: {},
            splitLine: {
              show: false,
            },
            axisTick: {
              show: false,
            },
            axisLabel: {
              show: false,
            },
            title: {
              fontSize: 14,
            },
            detail: {
              valueAnimation: true,
              fontSize: 40,
              offsetCenter: [0, 0],
            },
            data: [{ value: 0 }],
          },
        ],
      },
      elemNotworkingtask = document.getElementById("LAY-index-notworkingtask"),
      elemWorkingtask = document.getElementById("LAY-index-workingtask"),
      elemPauseworkingtask = document.getElementById("LAY-index-pauseworkingtask"),
      renderDataView = function () {
        echartsApp[0] = echarts.init(elemNotworkingtask);
        echartsApp[1] = echarts.init(elemWorkingtask);
        echartsApp[2] = echarts.init(elemPauseworkingtask);

        echartsApp[0].setOption(options);
        echartsApp[1].setOption(options);
        echartsApp[2].setOption(options);
        // window.onresize = echartsApp[index].resize;
        admin.resize(function () {
          echartsApp[0].resize();
          echartsApp[1].resize();
          echartsApp[2].resize();
        });

        setInterval(function () {
          var value = Math.floor(Math.random() * (100 - 1 + 1)) + 1;

          var max = value + (Math.floor(Math.random() * (100 - 1 + 1)) + 1);

          echartsApp[0].setOption({
            series: [
              {
                min: 0,
                max: max,
                data: [{ value: value }],
              },
            ],
          });

          var value1 = Math.floor(Math.random() * (100 - 1 + 1)) + 1;
          echartsApp[1].setOption({
            series: [
              {
                min: 0,
                max: max,
                data: [{ value: value1 }],
              },
            ],
          });

          var value2 = Math.floor(Math.random() * (100 - 1 + 1)) + 1;
          echartsApp[2].setOption({
            series: [
              {
                min: 0,
                max: max,
                data: [{ value: value2 }],
              },
            ],
          });
        }, 2000);
      };

    //没找到DOM，终止执行
    // if (!elemDataView) return;

    renderDataView();
  });

  layui.use(["admin", "table"], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      element = layui.element,
      util = layui.util,
      form = layui.form;

    // 假设你要设置进度为50%
    var percent = 50;
    var tpl =
      '<div class="layui-progress-bar" style="border-radius: 50%; transform: rotate(' +
      ((percent / 100) * 360 - 90) +
      'deg);" lay-percent="' +
      percent +
      '%"></div><div class="layui-progress-text">' +
      percent +
      "%</div>";
    $(".layui-progress-circle").html(tpl);

    var prefix = "zkmes/productionmgmt/productionrepor";

    table.render({
      elem: "#zkmes-productionmgmt-productionrepor-table",
      url: prefix + "/list",
      page: true,
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-450",
      cols: [
        [
          { field: "productiontaskId", title: "任务编号" },
          { field: "productiontaskName", title: "任务名称" },
          { field: "productionorderId", title: "订单编号" },
          { field: "productionorderName", title: "订单名称" },
          { field: "productId", title: "产品编号" },
          { field: "productName", title: "产品名称" },
          { field: "productionQty", title: "订单数量" },
          { field: "schedulingQty", title: "排产数量" },
          { field: "reporQty", title: "报工数量" },
          { field: "reporProgress", title: "报工进度" },
          
          { field: "startTime", title: "开工时间" },
          
          
          { field: "status", title: "状态", templet: function (res) {
              var status = res.status;
              var html = "未知";
              if(status == 0){
            	  html = "已完成"
              } else if(status == 1){
            	  html = "未开工"
              } else if(status == 2){
            	  html = "开工"
              } else if(status == 3){
            	  html = "暂停"
              } 
            	  
            	  
              return html;
            }
           },
          {
            title: "操作",
            width: 160,
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-productionmgmt-productionrepor-toolbar-row",
          },
        ],
      ],
    });

    //工具条
    table.on("tool(zkmes-productionmgmt-productionrepor-table)", function (obj) {
      var data = obj.data;
      if (obj.event === "del") {
        layer.confirm("确定删除？", function (index) {
          admin.req({
            url: prefix + "/" + data.purchaseorderId,
            type: "delete",
            contentType: "application/json;charset=UTF-8",
            done: function (res) {
              layer.msg("删除成功");
              layui.table.reload("zkmes-productionmgmt-productionrepor-table"); //重载表格
              layer.close(index); //执行关闭
            },
          });
        });
      } else if (obj.event === "edit") {
        admin.popup({
          title: "修改生产报工信息",
          area: "1500px",
          offset: "100px",
          id: "popup-zkmes-productionmgmt-productionrepor-edit",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/productionmgmt/productionrepor/form", data)
              .done(function () {
                form.render(null, "zkmes-productionmgmt-productionrepor-form");

                //提交
                form.on("submit(zkmes-productionmgmt-productionrepor-form-submit)", function (data) {
                  var field = data.field; //获取提交的字段

                  var listData = table.getData("zkmes-productionmgmt-productionrepor-form-table");

                  field.listData = listData;

                  //提交 Ajax 成功后，关闭当前弹层并重载表格
                  admin.req({
                    url: prefix,
                    type: "put",
                    contentType: "application/json;charset=UTF-8",
                    data: JSON.stringify(field),
                    done: function (res) {
                      layer.msg("修改成功");
                      layui.table.reload("zkmes-productionmgmt-productionrepor-table"); //重载表格
                      layer.close(index); //执行关闭
                    },
                  });
                });
              });
          },
        });
      }
    });
  });
</script>
