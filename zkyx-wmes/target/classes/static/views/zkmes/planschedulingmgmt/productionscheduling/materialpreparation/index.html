<div style="padding: 10px 30px 0 0">
  <table
    id="zkmes-planschedulingmgmt-productionscheduling-materialpreparation-table"
    lay-filter="zkmes-planschedulingmgmt-productionscheduling-materialpreparation-table"
  ></table>
  <script type="text/html" id="zkmes-planschedulingmgmt-productionscheduling-materialpreparation-toolbar-head">
    <div class="layui-btn-container">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
    </div>
  </script>
  <script type="text/html" id="zkmes-planschedulingmgmt-productionscheduling-materialpreparation-toolbar-row">
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"
      ><i class="layui-icon layui-icon-edit"></i>编辑</a
    >
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"
      ><i class="layui-icon layui-icon-delete"></i>删除</a
    >
  </script>
</div>

<script>
  layui.use(["admin", "form"], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      element = layui.element,
      table = layui.table,
      form = layui.form;
 
    var prefix = "zkmes/productionmgmt/productiontask";

    table.render({
      elem: "#zkmes-planschedulingmgmt-productionscheduling-materialpreparation-table",
      url: "zkmes/productionmgmt/productionscheduling/productiontask/list",
      toolbar: "#zkmes-planschedulingmgmt-productionscheduling-materialpreparation-toolbar-head",
      page: true,
      where: {
        productionplanId: $("#productionplanId").val(),
      },
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-450",
      cols: [
        [
          { field: "productiontaskId", title: "任务编号" },
          { field: "productiontaskName", title: "任务名称" }, 
          { field: "teamName", title: "班组" },
          { field: "schedulingQty", title: "备料数量" },
          { field: "begintime", title: "备料时间" }, 
          {
            title: "操作",
            width: 160,
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-planschedulingmgmt-productionscheduling-materialpreparation-toolbar-row",
          },
        ],
      ],
    });

    //工具条
    table.on("tool(zkmes-planschedulingmgmt-productionscheduling-materialpreparation-table)", function (obj) {
      var data = obj.data;
      if (obj.event === "del") {
        layer.confirm("确定删除？", function (index) {
          admin.req({
            url: prefix + "/" + data.productiontaskId,
            type: "delete",
            contentType: "application/json;charset=UTF-8",
            done: function (res) {
              layer.msg("删除成功");
              layui.table.reload("zkmes-planschedulingmgmt-productiontask-table"); //重载表格
              layer.close(index); //执行关闭
            },
          });
        });
      } else if (obj.event === "edit") {
        admin.popup({
          title: "添加备料任务",
          area: "450px",
          offset: "300px",
          id: "popup-zkmes-planschedulingmgmt-productionscheduling-materialpreparation-edit",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/planschedulingmgmt/productionscheduling/materialpreparation/form", data)
              .done(function () {
                form.render(null, "zkmes-planschedulingmgmt-productionscheduling-materialpreparation-form");

                //提交
                form.on("submit(zkmes-planschedulingmgmt-productionscheduling-materialpreparation-form-submit)", function (data) {
                  var field = data.field; //获取提交的字段

                 
                  admin.req({
                    url: prefix,
                    type: "put",
                    contentType: "application/json;charset=UTF-8",
                    data: JSON.stringify(field),
                    done: function (res) {
                      layer.msg("新增成功");
                      layui.table.reload("zkmes-planschedulingmgmt-productionscheduling-materialpreparation-table"); //重载表格
                      layer.close(index); //执行关闭
                    },
                  });
                });
              });
          },
        });
      }
    });

    // 头部工具栏点击事件
    table.on("toolbar(zkmes-planschedulingmgmt-productionscheduling-materialpreparation-table)", function (obj) {
      switch (obj.event) {
        case "add":
          admin.popup({
            title: "添加备料任务",
            area: "450px",
            offset: "300px",
            id: "popup-zkmes-planschedulingmgmt-productionscheduling-materialpreparation-add",
            success: function (layero, index) {
              view(this.id)
                .render("zkmes/planschedulingmgmt/productionscheduling/materialpreparation/form")
                .done(function () {
                  form.render(null, "zkmes-planschedulingmgmt-productionscheduling-materialpreparation-form");
                  //提交
                  form.on(
                    "submit(zkmes-planschedulingmgmt-productionscheduling-materialpreparation-form-submit)",
                    function (data) {
                      var field = data.field; //获取提交的字段
 
                      field.productionplanId = $("#productionplanId").val();;
                      field.processId = $("#processId").val();;
                      //提交 Ajax 成功后，关闭当前弹层并重载表格
                      admin.req({
                        url: prefix,
                        type: "post",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(field),
                        done: function (res) {
                          layer.msg("新增成功");
                          layui.table.reload("zkmes-planschedulingmgmt-productionscheduling-materialpreparation-table"); //重载表格
                          layer.close(index); //执行关闭
                        },
                      });
                    }
                  );
                });
            },
          });
          break;
        case "delete":
          layer.msg("删除");
          break;
        case "update":
          layer.msg("编辑");
          break;
        case "LAYTABLE_TIPS":
          layer.msg("提示");
          break;
      }
    });
  });
</script>
