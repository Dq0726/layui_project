<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>计划排程</cite></a>
    <a><cite>生产排产</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body">
	<!--    search start -->
	<div class="keySearch-cont" style="margin-bottom: 10px;">
	    <div class="layui-inline">
	        <input class="layui-input" name="keySearch-input" id="keySearch-input" autocomplete="off"
	        placeholder="请输入关键字">
	    </div>
	    <button class="layui-btn" data-type="keySearch" lay-on="keySearch">搜索</button>
	</div>
	<!--    search end -->
      <table
        id="zkmes-planschedulingmgmt-productionscheduling-table"
        lay-filter="zkmes-planschedulingmgmt-productionscheduling-table"
      ></table>

      <script type="text/html" id="zkmes-planschedulingmgmt-productionscheduling-toolbar-head">
        <div class="layui-btn-container"> 
          <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
        </div>
      </script>

      <script type="text/html" id="zkmes-planschedulingmgmt-productionscheduling-toolbar-row">
        {{# if(d.pid == null) { }}
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"
          ><i class="layui-icon layui-icon-edit"></i
        ></a>
        {{# } }}

        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"
          ><i class="layui-icon layui-icon-delete"></i
        ></a>
      </script>
    </div>
  </div>
</div>

<script>
  layui.use(["admin", "table", 'util'], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      form = layui.form,
      util = layui.util,
      treeTable = layui.treeTable;

    var prefix = "zkmes/productionmgmt/productionscheduling";

    var insTb = treeTable.render({
      elem: "#zkmes-planschedulingmgmt-productionscheduling-table",
      url: prefix + "/list",
      toolbar: "#zkmes-planschedulingmgmt-productionscheduling-toolbar-head",
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-200",
      tree: {
        customName: {
          id: "id", //子ID
          pid: "pid", //父ID
          name: "productionorderId",
        },
        data: {
          isSimpleData: true,
        },
        view: {
          expandAllDefault: true,
        },
      },
      cols: [
        [
          {
            field: "productionplanId",
            title: "生产单/任务单号",
            templet: function (res) { 
              var html = "";
               
              if(res.type == "0"){
            	  html = '<span class="layui-badge layui-bg-blue">' + res.productionplanId + "</span>";
              }else{
            	  html = '&ensp;&ensp;<span class="layui-badge layui-bg-green">' + res.taskId + "</span>";
              }
               
              return html;
            },
          },
          { field: "productName", title: "产品名称" },
          { field: "processName", title: "工单执行" },
          { field: "processName", title: "执行车间" },
          { field: "qty", title: "数量" },
          { field: "begintime", title: "开始时间" },
          { field: "endtime", title: "结束时间" },
          {
            title: "操作",
            width: 160,
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-planschedulingmgmt-productionscheduling-toolbar-row",
          },
        ],
      ],
      style: "margin-top:0;",
      response: {
        statusName: "code", //数据状态的字段名称，默认：code
        statusCode: 200, //成功的状态码，默认：0
        msgName: "msg", //状态信息的字段名称，默认：msg
        dataName: "data", //数据列表的字段名称，默认：data
      },
    });

    //工具条
    table.on("tool(zkmes-planschedulingmgmt-productionscheduling-table)", function (obj) {
      var data = obj.data;
      if (obj.event === "del") {
        layer.confirm("确定删除？", function (index) {
          admin.req({
            url: prefix + "/" + data.purchaseorderId,
            type: "delete",
            contentType: "application/json;charset=UTF-8",
            done: function (res) {
              layer.msg("删除成功");
              layui.table.reload("zkmes-planschedulingmgmt-productionscheduling-table"); //重载表格
              layer.close(index); //执行关闭
            },
          });
        });
      } else if (obj.event === "add") {
        admin.popup({
          title: "生产排产信息",
          area: "1500px",
          offset: "100px",
          id: "popup-zkmes-planschedulingmgmt-productionscheduling-add",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/planschedulingmgmt/productionscheduling/form", data)
              .done(function () {
                form.render(null, "zkmes-planschedulingmgmt-productionscheduling-form");
                //提交
                form.on("submit(zkmes-planschedulingmgmt-productionscheduling-form-submit)", function (data) {
                  var field = data.field; //获取提交的字段
                  field.status = field.status ? 0 : 1;
                  //提交 Ajax 成功后，关闭当前弹层并重载表格
                  admin.req({
                    url: prefix,
                    type: "post",
                    contentType: "application/json;charset=UTF-8",
                    data: JSON.stringify(field),
                    done: function (res) {
                      layer.msg("新增成功");
                      layui.table.reload("zkmes-planschedulingmgmt-productionscheduling-table"); //重载表格
                      layer.close(index); //执行关闭
                    },
                  });
                });
              });
          },
        });
      } else if (obj.event === "edit") {
        admin.popup({
          title: "生产排产信息",
          area: "1500px",
          offset: "100px",
          id: "popup-zkmes-planschedulingmgmt-productionscheduling-edit",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/planschedulingmgmt/productionscheduling/form", data)
              .done(function () {
                form.render(null, "zkmes-planschedulingmgmt-productionscheduling-form");

                //提交
                form.on("submit(zkmes-planschedulingmgmt-productionscheduling-form-submit)", function (data) {
                  var field = data.field; //获取提交的字段
                  field.status = field.status ? 0 : 1;

                  //提交 Ajax 成功后，关闭当前弹层并重载表格
                  admin.req({
                    url: prefix,
                    type: "put",
                    contentType: "application/json;charset=UTF-8",
                    data: JSON.stringify(field),
                    done: function (res) {
                      layer.msg("修改成功");
                      layui.table.reload("zkmes-planschedulingmgmt-productionscheduling-table"); //重载表格
                      layer.close(index); //执行关闭
                    },
                  });
                });
              });
          },
        });
      }
    });

    // 头部工具栏点击事件
    table.on("toolbar(zkmes-planschedulingmgmt-productionscheduling-table)", function (obj) {
      switch (obj.event) { 
        case "delete":
          layer.msg("删除");
          break;
        case "update":
          layer.msg("编辑");
          break;
        case "LAYTABLE_TIPS":
          layer.msg("提示");
          break;
        case "refresh":
            layui.treeTable.reloadData("zkmes-planschedulingmgmt-productionscheduling-table", {}); //重载表格
            layer.msg('刷新成功');
            break;
      }
    });
    util.on("lay-on", {
        // 关键字搜索功能
    	keySearch: function () {
          var keySearchValue = $('#keySearch-input').val();
          // 重载表格，传递搜索参数
          table.reload('zkmes-planschedulingmgmt-productionscheduling-table', {
            page: {
              curr: 1 // 从第一页开始
            },
            where: {
              searchValue: keySearchValue // 传递关键字参数到后端
            }
          });
        },
      });
  });
</script>
