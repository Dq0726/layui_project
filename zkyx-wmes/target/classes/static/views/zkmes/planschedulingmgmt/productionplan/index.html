<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>计划排程</cite></a>
    <a><cite>生产计划</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body">
	      <!--    search start -->
	      <div class="keySearch-cont" style="margin-bottom: 10px;">
	        <div class="layui-inline">
	          <input class="layui-input" name="keySearch-input" id="keySearch-input" autocomplete="off"
	            placeholder="请输入关键字">
	        </div>
	        <button class="layui-btn" data-type="keySearch " lay-on="keySearch">搜索</button>
	      </div>
	      <!--    search end -->
      <table
        id="zkmes-planschedulingmgmt-productionplan-table"
        lay-filter="zkmes-planschedulingmgmt-productionplan-table"
      ></table>

      <script
        type="text/html"
        id="zkmes-planschedulingmgmt-productionplan-toolbar-head"
      >
        <div class="layui-btn-container">
          <button class="layui-btn layui-btn-sm" lay-event="order">
            客户订单
          </button>
          <button class="layui-btn layui-btn-sm" lay-event="stock">
            库存备货
          </button>
          <button class="layui-btn layui-btn-sm" lay-event="refresh">
            刷新
          </button>
        </div>
      </script>

      <script
        type="text/html"
        id="zkmes-planschedulingmgmt-productionplan-toolbar-row"
      >
        <a class="layui-btn layui-btn layui-btn-xs" lay-event="review"
          ><i class="layui-icon layui-icon-edit"></i>审核</a
        >
        <a
          class="layui-btn layui-btn layui-bg-blue layui-btn-xs"
          lay-event="edit"
          ><i class="layui-icon layui-icon-edit"></i>编辑</a
        >
        <a class="layui-btn layui-btn layui-bg-red layui-btn-xs" lay-event="del"
          ><i class="layui-icon layui-icon-delete"></i>删除</a
        >
      </script>
    </div>
  </div>
</div>

<script>
  layui.use(["admin", "table", 'util'], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      util = layui.util, 
      form = layui.form;

    var prefix = "zkmes/productionmgmt/productionplan";

    table.render({
      elem: "#zkmes-planschedulingmgmt-productionplan-table",
      url: prefix + "/list",
      toolbar: "#zkmes-planschedulingmgmt-productionplan-toolbar-head",
      page: true,
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-200",
      cols: [
        [
          {type: 'numbers', title: '序号'}, // 使用layui的numbers类型自动生成序号
          { field: "productionplanId", title: "计划单号" },
          { field: "productionplanName", title: "计划名称" },
          { field: "productionQty", title: "生产数量" },
          {
            field: "source",
            title: "订单来源",
            templet: function (res) {
              var html =
                res.source == 0
                  ? '<span class="layui-badge layui-bg-blue">库存备货</span>'
                  : '<span class="layui-badge layui-bg-green">客户订单</span>';
              return html;
            },
          },
          { field: "productId", title: "产品编号" },
          { field: "productName", title: "产品名称" },
          { field: "specName", title: "规格" },
          { field: "modelName", title: "型号" },
          {
            field: "batchno",
            title: "批次号",
            templet: function (res) {
              if (res.batchno == null) {
                return "-";
              } else {
                return res.batchno;
              }
            },
          },
          { field: "customerName", title: "客户名称" },
          {
            field: "status",
            title: "审批状态",
            templet: function (res) {
              var html =
                '<span class="layui-badge layui-bg-orange">审核中</span>';

              if (res.status == 1) {
                html = '<span class="layui-badge layui-bg-green">通过</span>';
              } else if (res.status == 2) {
                html = '<span class="layui-badge layui-bg-red">未通过</span>';
              }

              return html;
            },
          },
          { field: "createTime", title: "创建时间" },
          {
            title: "操作",
            width: 220,
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-planschedulingmgmt-productionplan-toolbar-row",
          },
        ],
      ],
    });

    //工具条
    table.on("tool(zkmes-planschedulingmgmt-productionplan-table)", function (obj) {
      var data = obj.data;
      if (obj.event === "del") {
        layer.confirm("确定删除？", function (index) {
          admin.req({
            url: prefix + "/" + data.productionplanId,
            type: "delete",
            contentType: "application/json;charset=UTF-8",
            done: function (res) {
              layer.msg("删除成功");
              layui.table.reload("zkmes-planschedulingmgmt-productionplan-table"); //重载表格
              layer.close(index); //执行关闭
            },
          });
        });
      } else if (obj.event === "edit") {
        admin.popup({
          title: "修改生产计划",
          area: "1500px",
          offset: "50px",
          id: "popup-zkmes-planschedulingmgmt-productionplan-edit",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/planschedulingmgmt/productionplan/edit-form", data)
              .done(function () {
                form.render(
                  null,
                  "zkmes-planschedulingmgmt-productionplan-edit-form"
                );
                //提交
                form.on(
                  "submit(zkmes-planschedulingmgmt-productionplan-edit-form-submit)",
                  function (data) {
                    var field = data.field; //获取提交的字段
                    console.log(field, "add");
                    //提交 Ajax 成功后，关闭当前弹层并重载表格
                    admin.req({
                      url: prefix,
                      type: "put",
                      contentType: "application/json;charset=UTF-8",
                      data: JSON.stringify(field),
                      done: function (res) {
                        layer.msg("修改成功");
                        layui.table.reload(
                          "zkmes-planschedulingmgmt-productionplan-table"
                        ); //重载表格
                        layer.close(index); //执行关闭
                      },
                    });
                  }
                );
              });
          },
        });
      } else if (obj.event === "review") {
        admin.popup({
          title: "审核生产计划",
          area: "1500px",
          offset: "100px",
          id: "popup-zkmes-planschedulingmgmt-productionplan-review",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/planschedulingmgmt/productionplan/review-form", data)
              .done(function () {
                form.render(
                  null,
                  "zkmes-planschedulingmgmt-productionplan-review-form"
                );
                //提交
                form.on(
                  "submit(zkmes-planschedulingmgmt-productionplan-review-form-submit)",
                  function (data) {
                    var field = data.field; //获取提交的字段

                    admin.req({
                      url: "zkmes/planschedulingmgmt/productionplan/review",
                      type: "put",
                      contentType: "application/json;charset=UTF-8",
                      data: JSON.stringify(field),
                      done: function (res) {
                        layer.msg("提交成功");
                        layui.table.reload(
                          "zkmes-planschedulingmgmt-productionplan-table"
                        ); //重载表格
                        layer.close(index); //执行关闭
                      },
                    });
                  }
                );
              });
          },
        });
      }
    });

    // 头部工具栏点击事件
    table.on(
      "toolbar(zkmes-planschedulingmgmt-productionplan-table)",
      function (obj) {
        switch (obj.event) {
          case "stock":
            var data = new Object();
            data.source = 0;
            admin.popup({
              title: "生产计划--库存备货",
              area: "1100px",
              offset: "100px",
              id: "popup-zkmes-planschedulingmgmt-productionplan-add",
              success: function (layero, index) {
                view(this.id)
                  .render("zkmes/planschedulingmgmt/productionplan/add-form", data)
                  .done(function () {
                    form.render(
                      null,
                      "zkmes-planschedulingmgmt-productionplan-add-form"
                    );
                    //提交
                    form.on(
                      "submit(zkmes-planschedulingmgmt-productionplan-add-form-submit)",
                      function (data) {
         /*                var field = data.field; //获取提交的字段
                        field.source = 0;
                        //提交 Ajax 成功后，关闭当前弹层并重载表格
                        admin.req({
                          url: prefix,
                          type: "post",
                          contentType: "application/json;charset=UTF-8",
                          data: JSON.stringify(field),
                          done: function (res) {
                            layer.msg("新增成功");
                            layui.table.reload(
                              "zkmes-planschedulingmgmt-productionplan-table"
                            ); //重载表格
                            layer.close(index); //执行关闭
                          },
                        }); */
                    	  layer.alert("暂无权限");layer.close(index); 
                      }
                    );
                  });
              },
            });
            break;
          case "order":
            var data = new Object();
            data.source = 1;
            admin.popup({
              title: "生产计划--客户订单",
              area: "1100px",
              offset: "100px",
              id: "popup-zkmes-planschedulingmgmt-productionplan-add",
              success: function (layero, index) {
                view(this.id)
                  .render("zkmes/planschedulingmgmt/productionplan/add-form", data)
                  .done(function () {
                    form.render(
                      null,
                      "zkmes-planschedulingmgmt-productionplan-add-form"
                    );
                    //提交
                    form.on(
                      "submit(zkmes-planschedulingmgmt-productionplan-add-form-submit)",
                      function (data) {
/*                         var field = data.field; //获取提交的字段
                        field.source = 1;
                        //提交 Ajax 成功后，关闭当前弹层并重载表格
                        admin.req({
                          url: prefix,
                          type: "post",
                          contentType: "application/json;charset=UTF-8",
                          data: JSON.stringify(field),
                          done: function (res) {
                            layer.msg("新增成功");
                            layui.table.reload(
                              "zkmes-planschedulingmgmt-productionplan-table"
                            ); //重载表格
                            layer.close(index); //执行关闭
                          },
                        }); */
                    	  layer.alert("暂无权限");layer.close(index); 
                      }
                    );
                  });
              },
            });
            break;
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-planschedulingmgmt-productionplan-table"); //重载表格
            layer.msg('刷新成功');
            break;
        }
      }
    );
    util.on("lay-on", {
        // 关键字搜索功能
    	keySearch: function () {
          var keySearchValue = $('#keySearch-input').val();
          // 重载表格，传递搜索参数
          table.reload('zkmes-planschedulingmgmt-productionplan-table', {
            page: {
              curr: 1 // 从第一页开始
            },
            where: {
              searchValue: keySearchValue // 传递关键字参数到后端
            }
          });
        },
      });
  });
</script>
