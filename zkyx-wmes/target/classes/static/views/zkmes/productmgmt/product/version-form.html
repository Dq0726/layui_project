 <div class="layui-form" lay-filter="zkmes-productmgmt-product-version-form">
    
  <script type="text/html" template>
 	<input
		type="text"
		id="productUuid" 
		name="productUuid" 
		value="{{ d.params.productUuid || '' }}" 
		class="layui-input layui-hide"
	/>
	</script>
  <div class="layui-form-item">
    <label class="layui-form-label">产品名称<span class="required">*</span></label>
    <div class="layui-input-inline">
      <script type="text/html" template>
          <input
          type="text"
          name="productName"
          placeholder="请输入"
          autocomplete="off"
          class="layui-input"
          value="{{ d.params.productName || '' }}"
					disabled
        />
      </script>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">版本号<span class="required">*</span></label>
    <div class="layui-input-inline">
      <script type="text/html" template>
        <input
          type="text"
          name="version"
          placeholder="请输入"
          value="{{ d.params.version || '' }}"
          lay-verify="required" 
		  {{# if( d.params.versionId != null && d.params.versionId != ''){ }} 
		  {{="readonly"}}
		  {{# } }} 
          autocomplete="off"
          class="layui-input"
        />
      </script>
    </div>
  </div>
   
  <div class="layui-form-item">
   <div class="layui-inline">
    <label class="layui-form-label">工艺名称</label>
    <div class="layui-input-inline">
       <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchTechnique" 
            readonly
            placeholder="请选择"
            value="{{ d.params.techniqueName || '' }}"
            name="techniqueName"
            lay-options="{split: true}"
            class="layui-input"
          />
            <input
            type="text" 
            readonly 
            value="{{ d.params.techniqueId || '' }}"
            name="techniqueId" 
            class="layui-input layui-hide"
          />
        </script>
    </div>
    </div> 
     <div class="layui-inline"> 
      <div class="layui-inline " id="processBtn">  
      </div>
     </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">产品CAD文件</label>
    <div class="layui-inline">
        <button type="button"  class="layui-btn layui-btn-primary layui-btn-sm" id="cadFolderUpload" lay-on="cadFolderUpload">
	      <i class="layui-icon layui-icon-upload"></i>查看产品CAD文件
	  	</button> 
    </div>
  </div> 
   <div class="layui-form-item">
    <label class="layui-form-label">产品其他文件</label>
    <div class="layui-inline">
        <button type="button" class="layui-btn layui-btn-primary layui-btn-sm" id="elseFolderUpload" lay-on="elseFolderUpload">
	      <i class="layui-icon layui-icon-upload"></i>查看产品其他文件
	  	</button> 
    </div>
<!--     <div class="layui-inline"> 
      <div class="layui-input-block block-no-leftmargin" id="elseUploadPreview">  
      </div>
    </div> -->
  </div>
  

  <div class="layui-form-item">
    <label class="layui-form-label">备注</label>
    <div class="layui-input-block">
      <script type="text/html" template>
          <input
          type="text"
          name="remark"
          placeholder="请输入"
          autocomplete="off"
          class="layui-input"
          value="{{ d.params.remark || '' }}"
        />
      </script>
    </div>
  </div>
 
  <script type="text/html" template>
  {{# if( d.params.version != null && d.params.version != '' ){ }} 
  <div class="layui-form-item">
    <fieldset class="layui-elem-field layui-field-title">
      <legend>Bom清单</legend>
    </fieldset>
    <table
      id="zkmes-productmgmt-product-version-form-table"
      lay-filter="zkmes-productmgmt-product-version-form-table"
    ></table> 
  </div>
  {{# } }} 
  </script>
  
  <script
    type="text/html"
    id="zkmes-productmgmt-product-version-form-toolbar-head" >
    <div class="layui-btn-container">
      <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
      <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
    </div>
  </script>
  <script
    type="text/html"
    id="zkmes-productmgmt-product-version-form-toolbar-row" >
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">
			<i class="layui-icon layui-icon-delete"></i>删除</a>
  </script>
     
  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-inline">
      <input type="button" id="zkmes-productmgmt-product-version-form-submit" lay-submit lay-filter="zkmes-productmgmt-product-version-form-submit" value="确认" class="layui-btn" />
    </div>
  </div>
</div>


<script type="text/html" template lay-done="zkmesProductmanageProductVersionFromDone(d.params)"></script>

<script>
  zkmesProductmanageProductVersionFromDone = function (params) {
    layui.use(["admin", "form", "common", "util", "upload"], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        form = layui.form,
        table = layui.table,
        upload = layui.upload,
        common = layui.common,
        util = layui.util;

      if (params.productUuid == null || params.productUuid == "") return;

      // 调用 common.js模块getPopupSize 函数，用ES6解构赋值获取返回的四个参数
      const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();

    
      
		admin.req({
		  url: "zkmes/techniquemgmt/techniquegroup/list",  // 去掉手动拼接的参数
		  type: 'get',
		  data: { 
		    versionId: params.versionId  // 参数会自动转为 ?techniqueId=xxx
		  },
		  contentType: 'application/json;charset=UTF-8',
		  done: function (res) {
		    let processBtn = $("processBtn");
		    let ProcessData = res.rows;
		    ProcessData.forEach(function(obj,index){
		    	console.log(`索引为${index}的值为：${obj.processName}`)
		        // 创建按钮并添加到 #container
		        $('<button>', {
		        	type:'button',
		            text: `${index+1}、${obj.processName}`,
		            class: 'layui-btn layui-btn-primary layui-btn-sm',
		            click: function() {
		                alert($(this).text());
		            }
		        }).appendTo('#processBtn');
		    })
		   
		  }
		});
      
		
	  var prefix = "zkmes/productmgmt/bom";
	  
      table.render({
        elem: "#zkmes-productmgmt-product-version-form-table",
        url: prefix + "/list",
        page: true,
        where: {
          versionId: params.versionId,
        },
        toolbar: "#zkmes-productmgmt-product-form-toolbar-head",
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-450",
        cols: [
          [
            { type: "numbers", title: "序号" },
            { field: "bomProductId", title: "BOM物料编号" },
            { field: "bomProductName", title: "BOM物料名称" },
            { field: "specName", title: "BOM物料规格" },
            { field: "modelName", title: "BOM物料型号" },
            { field: "uomName", title: "BOM物料单位" },
            {
              field: "ratio",
              title: "BOM物料使用比例",
              edit: function (d) {
                return "text"; // 编辑模式
              },
            },
            { field: "createTime", title: "创建时间" },
            {
              title: "操作",
              width: 120,
              align: "center",
              fixed: "right",
              toolbar: "#zkmes-productmgmt-product-version-form-toolbar-row",
            },
          ],
        ],
      });

      //工具条
      table.on("tool(zkmes-productmgmt-product-edit-form-table)", function (obj) {
        var data = obj.data;
        if (obj.event === "del") {
          layer.confirm("确定删除？", function (index) {
            admin.req({
              url: prefix + "/" + data.bomId,
              type: "delete",
              contentType: "application/json;charset=UTF-8",
              done: function (res) {
                layer.msg("删除成功");
                layui.table.reload("zkmes-productmgmt-product-edit-form-table"); //重载表格
                layer.close(index); //执行关闭
              },
            });
          });
        }
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-productmgmt-product-version-form-table)", function (obj) {
        switch (obj.event) {
          case "add":
            admin.popup({
              title: "添加BOM",
              area: popupWidthHeight,
              offset: popupOffsetWidthHeight,
              id: "popup-zkmes-productmgmt-version-form-add",
              success: function (layero, index) {
                view(this.id)
                  .render("zkmes/productmgmt/product/bom-form")
                  .done(function () {
                    form.render(null, "zkmes-productmgmt-product-bom-form");
                    //提交
                    form.on("submit(zkmes-productmgmt-product-bom-form-submit)", function (data) {
                      var field = data.field; //获取提交的字段
                      field.productUuid = $("#productUuid").val();
 
                      //提交 Ajax 成功后，关闭当前弹层并重载表格
                      admin.req({
                        url: prefix,
                        type: "post",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(field),
                        done: function (res) {
                          layer.msg("新增成功");
                          layui.table.reload("zkmes-productmgmt-product-version-form-table"); //重载表格
                          layer.close(index); //执行关闭
                        },
                      });
                    });
                  });
              },
            });
            break;
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-productmgmt-product-version-form-table"); //重载表格
            layer.msg('刷新成功');
            break;
        }
      });

      // 单元格编辑后的事件
      table.on("edit(zkmes-productmgmt-product-version-form-table)", function (obj) { 
        var data = obj.data; // 得到所在行所有键值 
  
        var j = {
          bomId: data.bomId,
          ratio: data.ratio,
        };

        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
          url: prefix,
          type: "put",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(j),
          done: function (res) {
            layer.msg("修改成功");
            layui.table.reloadData("zkmes-productmgmt-product-version-form-table"); //重载表格
          },
        });
      });
      
      util.on("lay-on", {
    	  cadFolderUpload: function () {
              admin.popup({
                  title: '添加产品文件'
                  , area: popupWidthHeight
                  , offset: popupOffsetWidthHeight
                  , id: 'popup-zkmes-productmgmt-product-folder-table'
                  , success: function (layero, index) {
                    view(this.id).render('zkmes/productmgmt/product/folder-form').done(function () {
                      form.render(null, 'zkmes-productmgmt-product-folder-form');
                      //提交
                      form.on('submit(zkmes-productmgmt-product-folder-form-submit)', function (data) {
                        var field = data.field; //获取提交的字段 
                        field.status = field.status ? 0 : 1;
                        //提交 Ajax 成功后，关闭当前弹层并重载表格
                        admin.req({
                          url: prefix
                          , type: 'post'
                          , contentType: 'application/json;charset=UTF-8'
                          , data: JSON.stringify(field)
                          , done: function (res) {
                            layer.msg("新增成功");
                            layui.table.reload('zkmes-productmgmt-product-version-form'); //重载表格
                            layer.close(index); //执行关闭 
                          }
                        });
                      });
                    });
                  }
                });
          },
        });
      });
  };

  layui.use(["admin", "form"], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      form = layui.form;

    ///////technique
    form.on("input-affix(searchTechnique)", function (data) {
      admin.popup({
        title: "选择工艺",
        area: "1500px",
        offset: "110px",
        id: "popup-zkmes-productmgmt-product-version-form-technique",
        success: function (layero, index) {
          view(this.id)
            .render("zkmes/productmgmt/product/technique-form")
            .done(function () {
              form.render(null, "zkmes-productmgmt-product-technique-form");
              //提交
              form.on("submit(zkmes-productmgmt-product-technique-form-submit)", function (data) {
                var field = data.field; //获取提交的字段
                form.val("zkmes-productmgmt-product-version-form", field);
                layer.msg("选择成功");
                layer.close(index); //执行关闭
              });
            });
        },
      });
    });

  });
</script>

