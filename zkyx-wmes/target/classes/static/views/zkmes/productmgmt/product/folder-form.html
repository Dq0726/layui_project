<div class="layui-form" lay-filter="zkmes-productmgmt-product-folder-form" style="padding: 10px 30px 0 0">


  <div class="layui-form-item">
    <table
      id="zkmes-productmgmt-product-folder-form-table"
      lay-filter="zkmes-productmgmt-product-folder-form-table"
    ></table> 
  </div>


  <script type="text/html" id="zkmes-productmgmt-product-folder-form-toolbar-head">
    <div class="layui-btn-container">
      <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
      <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
    </div>
  </script>
  <script type="text/html" id="zkmes-productmgmt-product-folder-form-toolbar-row">
    <a class="layui-btn layui-btn-normal layui-btn-xs edit-btn" lay-event="edit">
      <i class="layui-icon layui-icon-edit"></i>编辑</a>
    <a class="layui-btn layui-btn-warm layui-btn-xs submit-btn" lay-event="submit" style="display:none;">
      <i class="layui-icon layui-icon-ok"></i>提交</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">
      <i class="layui-icon layui-icon-delete"></i>删除</a>
  </script>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-inline">
      <input type="button" id="zkmes-productmgmt-product-folder-form-submit" lay-submit
        lay-filter="zkmes-productmgmt-product-folder-form-submit" value="确认" class="layui-btn" />
    </div>
  </div>
</div>



<script>
  // 格式化日期函数，将日期格式化为 YYYY-MM-DD HH:MM:SS 格式
  function formatDate(date) {
    var year = date.getFullYear();
    var month = (date.getMonth() + 1).toString().padStart(2, '0');
    var day = date.getDate().toString().padStart(2, '0');
    var hours = date.getHours().toString().padStart(2, '0');
    var minutes = date.getMinutes().toString().padStart(2, '0');
    var seconds = date.getSeconds().toString().padStart(2, '0');
    
    return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
  }

  layui.use(["admin", "form", "common", "util", "upload"], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      form = layui.form,
      table = layui.table,
      upload = layui.upload,
      common = layui.common,
      util = layui.util;

    // 调用 common.js模块getPopupSize 函数，用ES6解构赋值获取返回的四个参数
    const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();

    //var prefix = "";

    table.render({
      elem: "#zkmes-productmgmt-product-folder-form-table",
      //url: prefix + "/list",
      where: {
        //folderId: params.folderId,
      },
      toolbar: "#zkmes-productmgmt-product-folder-form-toolbar-head",
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-250",
      cols: [
        [
          { field: "id", title: "编号" ,width: 120,},
          { 
            field: "fileCode", 
            title: "文件编号",
            edit: function(d){ return d._edit ? 'text' : false; }
          },
          { field: "fileName", title: "文件名称" },
          { 
            field: "fileType",
            width: 100,
            title: "文件类型" 
          },
          { field: "fileSize", title: "文件大小", width: 100, },
          { 
            field: "fileSource", 
            title: "源文件",
            templet: function(d){
              var html = '<div><button class="layui-btn layui-btn-sm layui-btn-primary" lay-on="uploadFile" data-index="'+ d.LAY_INDEX +'">上传文件</button>';
              if(d.fileName) {
                html += '<button class="layui-btn layui-btn-sm layui-btn-normal" lay-on="previewFile" data-index="'+ d.LAY_INDEX +'" style="margin-left: 5px;">预览</button>';
                html += '<button class="layui-btn layui-btn-sm layui-btn-warm" lay-on="downloadFile" data-index="'+ d.LAY_INDEX +'" style="margin-left: 5px;">下载</button>';
              }
              html += '</div>';
              return html;
            }
          },
          { 
            field: "remark", 
            title: "文件说明",
            edit: function(d){ return d._edit ? 'text' : false; }
          },
          { field: "createTime", title: "创建时间" },
          {
            title: "操作",
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-productmgmt-product-folder-form-toolbar-row",
          },
        ],
      ],
      data: [{ // 赋值已知数据
          "id": "10001",
          "fileCode": "FILE-001",
          "fileName": "设计文件A",
          "fileType": "PDF",
          "fileSize": "23MB",
          "fileSource": "",
          "remark": "初始设计文档",
          "createTime": "2025-7-14 15:50:21",
        }, {
         "id": "10002",
          "fileCode": "FILE-002",
          "fileName": "设计文件B",
          "fileType": "PDF",
          "fileSize": "36.2MB",
          "fileSource": "",
          "remark": "修订版设计文档",
          "createTime": "2025-7-14 15:50:21",
        }],
    });

    // 监听表格工具栏事件
    table.on('toolbar(zkmes-productmgmt-product-folder-form-table)', function(obj){
      var checkStatus = table.checkStatus(obj.config.id);
      switch(obj.event){
        case 'add':
          // 获取当前表格数据
          var tableData = table.cache['zkmes-productmgmt-product-folder-form-table'] || [];
          // 创建新行数据，除了fileSource和操作列外，其他字段为空
          var newRow = {
            "id": "",
            "fileCode": "", // 添加文件编号字段
            "fileName": "",
            "fileType": "",
            "fileSize": "",
            "fileSource": "",
            "remark": "", // 添加备注字段
            "createTime": formatDate(new Date()), // 设置当前时间作为创建时间，使用自定义格式
            // 添加LAY_INDEX属性，确保上传文件和预览按钮能正常工作
            "LAY_INDEX": tableData.length
          };
          // 将新行添加到表格数据中
          tableData.push(newRow);
          // 重新加载表格
          table.reload('zkmes-productmgmt-product-folder-form-table', {
            data: tableData
          });
          break;
        case 'refresh':
          // 刷新表格
          /*
          // 在实际应用中，这里应该是从服务器获取最新文件列表的代码
          // 使用admin.req获取文件列表的示例代码
          var loadIndex = layer.load(2, {shade: [0.1, '#fff']});
          
          admin.req({
            url: '/api/files/list',
            type: 'get',
            data: {
              // 可以添加查询参数，如文件夹ID等
              // folderId: params.folderId
            },
            done: function(res) {
              layer.close(loadIndex);
              
              if (res.code === 0 && res.data) {
                // 获取成功，更新表格数据
                table.reload('zkmes-productmgmt-product-folder-form-table', {
                  data: res.data
                });
                layer.msg('数据刷新成功', {icon: 1});
              } else {
                layer.msg('获取文件列表失败: ' + (res.msg || '未知错误'), {icon: 2});
              }
            },
            error: function(xhr, status, error) {
              layer.close(loadIndex);
              console.error('获取文件列表时发生错误:', error);
              layer.msg('获取文件列表时发生错误: ' + error, {icon: 2});
            }
          });
          */
          
          // 当前仅重新加载表格
          table.reload('zkmes-productmgmt-product-folder-form-table');
          break;
      }
    });

    // 使用 util.on 绑定事件
    util.on('lay-on', {
      downloadFile: function() {
        var btn = this;
        var rowIndex = $(btn).data('index');
        var tableData = table.cache['zkmes-productmgmt-product-folder-form-table'];
      
        if (tableData && tableData[rowIndex]) {
          var fileData = tableData[rowIndex];
        
          // 检查是否有文件可以下载
          if (!fileData.fileName) {
            layer.msg('没有可下载的文件，请先上传文件', {icon: 2});
            return;
          }
        
          // 如果有实际文件对象，可以使用 URL.createObjectURL 创建下载链接
          if (fileData._file) {
            var fileUrl = URL.createObjectURL(fileData._file);
            
            // 创建一个临时的a标签用于下载
            var a = document.createElement('a');
            a.href = fileUrl;
            a.download = fileData.fileName; // 设置下载的文件名
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // 使用完毕后释放URL对象
            setTimeout(function() {
              URL.revokeObjectURL(fileUrl);
            }, 100);
            
            layer.msg('文件下载中...', {icon: 1});
          } else {
            // 如果没有实际文件对象，模拟下载
            // 在实际应用中，这里应该是从服务器获取文件URL进行下载
            layer.msg('模拟下载文件: ' + fileData.fileName, {icon: 1});
          }
        }
      },
      uploadFile: function() {
        var btn = this;
        var rowIndex = $(btn).data('index');
        // 创建一个隐藏的 file input
        var $fileInput = $('<input type="file" style="display:none" accept="*" />');
        $(document.body).append($fileInput);
        $fileInput.on('change', function(e) {
          var file = this.files[0];
          if (!file) return;
          
          // 模拟上传过程（如需真实上传可在此发起 ajax）
          /*
          // 在实际应用中，这里应该是将文件上传到服务器的代码
          // 使用admin.req上传文件的示例代码
          var formData = new FormData();
          formData.append('file', file);
          
          // 显示上传进度条
          var loadIndex = layer.load(2, {shade: [0.1, '#fff']});
          
          admin.req({
            url: '/api/files/upload',
            type: 'post',
            data: formData,
            contentType: false, // 不设置内容类型
            processData: false, // 不处理数据
            done: function(res) {
              layer.close(loadIndex);
              
              if (res.code === 0 && res.data) {
                // 上传成功，更新表格数据
                var tableData = table.cache['zkmes-productmgmt-product-folder-form-table'];
                if (tableData && tableData[rowIndex]) {
                  tableData[rowIndex].id = res.data.fileId;
                  tableData[rowIndex].fileName = file.name;
                  tableData[rowIndex].fileType = file.type || file.name.split('.').pop().toUpperCase();
                  tableData[rowIndex].fileSize = (file.size / 1024 / 1024).toFixed(2) + 'MB';
                  tableData[rowIndex].createTime = res.data.createTime || new Date().toLocaleString();
                  // 存储文件对象，用于预览
                  tableData[rowIndex]._file = file;
                  table.reload('zkmes-productmgmt-product-folder-form-table', {data: tableData});
                }
                
                layer.msg('文件上传成功', {icon: 1});
              } else {
                layer.msg('文件上传失败: ' + (res.msg || '未知错误'), {icon: 2});
              }
            },
            error: function(xhr, status, error) {
              layer.close(loadIndex);
              console.error('文件上传时发生错误:', error);
              layer.msg('文件上传时发生错误: ' + error, {icon: 2});
            }
          });
          */
          
          // 当前使用模拟上传
          // 假设上传成功后获得 fileId
          var fakeFileId = 'F' + Date.now();
          var tableData = table.cache['zkmes-productmgmt-product-folder-form-table'];
          if (tableData && tableData[rowIndex]) {
            tableData[rowIndex].id = fakeFileId;
            tableData[rowIndex].fileName = file.name;
            tableData[rowIndex].fileType = file.name.split('.').pop().toUpperCase();
            tableData[rowIndex].fileSize = (file.size / 1024 / 1024).toFixed(2) + 'MB';
            // 确保文件编号和备注字段已初始化
            tableData[rowIndex].fileCode = tableData[rowIndex].fileCode || '';
            tableData[rowIndex].remark = tableData[rowIndex].remark || '';
            // 存储文件对象，用于预览
            tableData[rowIndex]._file = file;
            table.reload('zkmes-productmgmt-product-folder-form-table', {data: tableData});
          }
          $fileInput.remove();
        });
        $fileInput.trigger('click');
      },
      previewFile: function() {
        var btn = this;
        var rowIndex = $(btn).data('index');
        var tableData = table.cache['zkmes-productmgmt-product-folder-form-table'];
      
        if (tableData && tableData[rowIndex]) {
          var fileData = tableData[rowIndex];
        
          // 检查是否有文件可以预览
          if (!fileData.fileName) {
            layer.msg('没有可预览的文件，请先上传文件', {icon: 2});
            return;
          }
        
          // 如果有实际文件对象，可以使用 URL.createObjectURL 创建预览链接
          if (fileData._file) {
            var fileUrl = URL.createObjectURL(fileData._file);
            window.open(fileUrl, '_blank');
            // 使用完毕后释放URL对象
            setTimeout(function() {
              URL.revokeObjectURL(fileUrl);
            }, 100);
          } else {
            // 如果没有实际文件对象，模拟预览
            // 在实际应用中，这里应该是从服务器获取文件URL
            /*
            // 从服务器获取文件URL的示例代码 - 使用admin.req
            admin.req({
              url: '/api/files/' + fileData.id + '/url',
              type: 'get',
              dataType: 'json',
              done: function(res) {
                // 请求成功的回调
                if (res.code === 0 && res.data && res.data.fileUrl) {
                  // 获取到文件URL后，可以直接在新窗口打开
                  window.open(res.data.fileUrl, '_blank');
                } else {
                  // 如果获取URL失败，显示错误信息
                  layer.msg('获取文件URL失败: ' + (res.msg || '未知错误'), {icon: 2});
                  // 仍然可以使用模拟预览作为备选方案
                  openSimulatedPreview();
                }
              },
              error: function(xhr, status, error) {
                // 请求失败的回调
                console.error('获取文件URL时发生错误:', error);
                layer.msg('获取文件URL时发生错误: ' + error, {icon: 2});
                // 使用模拟预览作为备选方案
                openSimulatedPreview();
              }
            });
            
            // 模拟预览的辅助函数
            function openSimulatedPreview() {
              // 创建模拟预览窗口的代码...
            }
            */
            
            // 当前使用模拟预览
            layer.msg('正在打开预览窗口...', {icon: 1});
          
            // 创建一个简单的预览页面
            var previewWindow = window.open('', '_blank');
            if (previewWindow) {
              previewWindow.document.write(
                '<html><head><title>文件预览 - ' + fileData.fileName + '</title>' +
                '<style>body{font-family:Arial,sans-serif;margin:20px;line-height:1.6;}</style>' +
                '</head><body>' +
                '<h2>文件预览</h2>' +
                '<p><strong>文件名:</strong> ' + fileData.fileName + '</p>' +
                '<p><strong>文件类型:</strong> ' + fileData.fileType + '</p>' +
                '<p><strong>文件大小:</strong> ' + fileData.fileSize + '</p>' +
                '<p><strong>文件ID:</strong> ' + fileData.id + '</p>' +
                '</body></html>'
              );
              previewWindow.document.close();
            } else {
              layer.msg('浏览器阻止了弹出窗口，请允许弹出窗口后重试', {icon: 2});
            }
          }
        }
      }
    });

    // 监听单元格编辑事件，只允许当前可编辑行的文件编号和备注可编辑
    table.on('edit(zkmes-productmgmt-product-folder-form-table)', function(obj){
      var value = obj.value;
      var data = obj.data;
      var field = obj.field;
      var tableData = table.cache['zkmes-productmgmt-product-folder-form-table'];
      var index = $(obj.tr).data('index');
      // 只允许当前可编辑行的fileCode和remark可编辑
      if (tableData && tableData[index] && tableData[index]._edit && (field === 'fileCode' || field === 'remark')) {
        tableData[index][field] = value;
      } else {
        // 禁止其他行编辑
        layer.msg('请先点击编辑按钮', {icon: 0});
        table.reload('zkmes-productmgmt-product-folder-form-table', {data: tableData});
      }
    });
    
    // 监听行工具条事件
    // 用于记录当前可编辑的行索引
    var editableRowIndex = null;
    table.on('tool(zkmes-productmgmt-product-folder-form-table)', function(obj){
      var data = obj.data;
      var tableData = table.cache['zkmes-productmgmt-product-folder-form-table'];
      if(obj.event === 'del'){
        layer.confirm('确定删除此文件？', function(index){
          obj.del();
          layer.close(index);
        });
      } else if(obj.event === 'edit') {
        // 只允许一行可编辑
        editableRowIndex = obj.tr.data('index');
        // 设置所有行为不可编辑
        tableData.forEach(function(row, idx){
          row._edit = false;
        });
        // 当前行可编辑
        tableData[editableRowIndex]._edit = true;
        // 重新渲染表格，设置edit属性
        table.reload('zkmes-productmgmt-product-folder-form-table', {
          data: tableData,
          done: function(){
            // 显示/隐藏按钮
            var trs = $("#zkmes-productmgmt-product-folder-form-table").next().find('tr');
            trs.each(function(i, tr){
              var $tr = $(tr);
              if(i-1 === editableRowIndex){
                $tr.find('.edit-btn').hide();
                $tr.find('.submit-btn').show();
              }else{
                $tr.find('.edit-btn').show();
                $tr.find('.submit-btn').hide();
              }
            });
          }
        });
      } else if(obj.event === 'submit') {
        // 提交，保存内容
        editableRowIndex = null;
        // 设置所有行为不可编辑
        tableData.forEach(function(row, idx){
          row._edit = false;
        });
        table.reload('zkmes-productmgmt-product-folder-form-table', {
          data: tableData,
          done: function(){
            // 所有行按钮恢复
            var trs = $("#zkmes-productmgmt-product-folder-form-table").next().find('tr');
            trs.each(function(i, tr){
              var $tr = $(tr);
              $tr.find('.edit-btn').show();
              $tr.find('.submit-btn').hide();
            });
          }
        });
        layer.msg('提交成功');
      }
    });

  });
</script>