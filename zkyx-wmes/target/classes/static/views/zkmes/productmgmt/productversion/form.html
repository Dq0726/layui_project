<div
  class="layui-form"
  lay-filter="zkmes-productmgmt-product-form"
  style="padding: 10px 30px 0 0"
>
  <!-- 用户展示部分 start-->
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">物料编码<span class="required">*</span></label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            name="productId"
            id="productId"
            placeholder="请输入"
            value="{{ d.params.productId || '' }}"
            autocomplete="off"
						{{# if( d.params.productId != null && d.params.productId != ''){ }} 
						{{="readonly"}}
					  {{# } }} 
            class="layui-input"
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">物料名称<span class="required">*</span></label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            name="productName"
            placeholder="请输入"
            value="{{ d.params.productName || '' }}"
            lay-verify="required"
            autocomplete="off"
            class="layui-input"
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">是否启用</label>
      <div class="layui-input-inline">
        <input type="radio" name="status" value="0" title="是" checked/>
        <input type="radio" name="status" value="1" title="否" />
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">物料规格<span class="required">*</span></label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchSpec"
            lay-verify="required"
            readonly
            placeholder="请选择"
            value="{{ d.params.specName || '' }}"
            name="specName"
            lay-options="{split: true}"
            class="layui-input"
          />
					<input
            type="text" 
            readonly 
            value="{{ d.params.specId || '' }}"
            name="specId" 
            class="layui-input layui-hide"
          />
        </script>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">物料型号<span class="required">*</span></label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchModel"
            lay-verify="required"
            readonly
            placeholder="请选择"
            value="{{ d.params.modelName || '' }}"
            name="modelName"
            lay-options="{split: true}"
            class="layui-input"
          />
					<input
            type="text" 
            readonly 
            value="{{ d.params.modelId || '' }}"
            name="modelId" 
            class="layui-input layui-hide"
          />
        </script>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">物料单位<span class="required">*</span></label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchUom"
            lay-verify="required"
            readonly
            placeholder="请选择"
            value="{{ d.params.uomName || '' }}"
            name="uomName"
            lay-options="{split: true}"
            class="layui-input"
          />
					<input
            type="text" 
            readonly 
            value="{{ d.params.uomId || '' }}"
            name="uomId" 
            class="layui-input layui-hide"
          />
        </script>
      </div>
    </div> 
    <div class="layui-inline">
      <label class="layui-form-label">产品分类<span class="required">*</span></label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchClassify"
            lay-verify="required"
            readonly
            placeholder="请选择"
            value="{{ d.params.classifyName || '' }}"
            name="classifyName"
            lay-options="{split: true}"
            class="layui-input"
          />
					<input
            type="text" 
            readonly 
            value="{{ d.params.classifyId || '' }}"
            name="classifyId" 
            class="layui-input layui-hide"
          />
        </script>
      </div>
    </div>


  </div>

  <div class="layui-form-item">
    <label class="layui-form-label">备注</label>
    <div class="layui-input-block">
      <script type="text/html" template>
        <input
          type="text"
          name="remark"
          placeholder="请输入"
          autocomplete="off"
          class="layui-input"
          value="{{ d.params.remark || '' }}"
        />
      </script>
    </div>
  </div>
  <!-- 用户展示部分 end -->
   
  <script type="text/html" template>
  {{# if(d.params.productId != null && d.params.productId != ''){ }} 
  <div class="layui-form-item">
    <fieldset class="layui-elem-field layui-field-title">
      <legend>版本列表</legend>
    </fieldset>
    <table
      id="zkmes-productmgmt-product-form-table"
      lay-filter="zkmes-productmgmt-product-form-table"
    ></table> 
  </div>
  {{# } }}
  </script>
   
  <script type="text/html" id="zkmes-productmgmt-product-form-toolbar-head">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
    <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
  </div>
  </script>
  <script type="text/html" id="zkmes-productmgmt-product-form-toolbar-row">
  <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">
    <i class="layui-icon layui-icon-edit"></i>编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">
    <i class="layui-icon layui-icon-delete"></i>删除</a>
  </script>
    
    
  <div class="layui-form-item">
    <div class="layui-input-inline" style="width: 250px">
      <input
        type="button"
        id="zkmes-productmgmt-product-form-submit"
        lay-submit
        lay-filter="zkmes-productmgmt-product-form-submit"
        value="确认"
        class="layui-btn"
      />
    </div>
  </div>
</div>

<script
  type="text/html"
  template
  lay-done="zkmesProductmanageProductEditFormDone(d.params)"
></script>

<script>
	zkmesProductmanageProductEditFormDone = function (params) {
    layui.use(["admin", "form", "common", "util"], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        form = layui.form,
        table = layui.table, 
        common = layui.common, 
        util = layui.util;

 
      if(params.productId == null || params.productId == '')
      	return 
      
      
      
      // 调用 common.js模块getPopupSize 函数，用ES6解构赋值获取返回的四个参数
      const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();
      
      
      var prefix = "zkmes/productmgmt/product/version";

      table.render({
        elem: "#zkmes-productmgmt-product-form-table",
        url: prefix + "/list",
        where: {
        	productId: params.productId,
        },
        toolbar: "#zkmes-productmgmt-product-form-toolbar-head",
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-450",
        cols: [
          [
            { type: "numbers", title: "序号" },
            { field: "versionId", title: "版本ID" },
            { field: "version", title: "版本号" },
             { field: 'tag', title: '标签' }
            , { field: 'describe', title: '说明' }
            , {
              field: 'status', title: '启用状态', templet: function (res) {
                var html = res.status == 0 ? '<span class="layui-badge layui-bg-blue">启用</span>' : '<span class="layui-badge layui-bg-orange">停用</span>';
                return html;
              }
            },
            { field: "createTime", title: "创建时间" },
            {
              title: "操作",
              width: 160,
              align: "center",
              fixed: "right",
              toolbar: "#zkmes-productmgmt-product-form-toolbar-row",
            },
          ],
        ],
      });

      //工具条
      table.on(
        "tool(zkmes-productmgmt-product-form-table)",
        function (obj) {
          var data = obj.data;
          if (obj.event === "del") {
            layer.confirm("确定删除？", function (index) {
              admin.req({
                url: prefix + "/" + data.versionId,
                type: "delete",
                contentType: "application/json;charset=UTF-8",
                done: function (res) {
                  layer.msg("删除成功");
                  layui.table.reload(
                    "zkmes-productmgmt-product-form-table"
                  ); //重载表格
                  layer.close(index); //执行关闭
                },
              });
            });
          }else if (obj.event === "edit") {
          	 admin.popup({
               title: "编辑产品版本"
               , area: popupWidthHeight
               , offset: popupOffsetWidthHeight
               , id: "popup-zkmes-productmgmt-product-form-add",
               success: function (layero, index) {
                 view(this.id)
                   .render("zkmes/productmgmt/product/version-form", data)
                   .done(function () {
                     form.render(
                       null,
                       "zkmes-productmgmt-product-version-form"
                     );
                     //提交
                     form.on(
                       "submit(zkmes-productmgmt-product-version-form-submit)",
                       function (data) {
                         var field = data.field; //获取提交的字段
                         field.productId = $("#productId").val();
                     
                         //提交 Ajax 成功后，关闭当前弹层并重载表格
                          admin.req({
                           url: prefix,
                           type: "put",
                           contentType: "application/json;charset=UTF-8",
                           data: JSON.stringify(field),
                           done: function (res) {
                             layer.msg("新增成功");
                             layui.table.reload(
                               "zkmes-productmgmt-product-form-table"
                             ); //重载表格
                             layer.close(index); //执行关闭
                           },
                         }); 
                      });
                   });
               },
             });
          }
        });

      // 头部工具栏点击事件
      table.on(
        "toolbar(zkmes-productmgmt-product-form-table)",
        function (obj) {
          switch (obj.event) {
            case "add":
              admin.popup({
                title: "添加产品版本",
                 area: popupWidthHeight
                , offset: popupOffsetWidthHeight
                , id: "popup-zkmes-productmgmt-product-form-add",
                success: function (layero, index) {
                  view(this.id)
                    .render("zkmes/productmgmt/product/version-form")
                    .done(function () {
                      form.render(
                        null,
                        "zkmes-productmgmt-product-version-form"
                      );
                      //提交
                      form.on(
                        "submit(zkmes-productmgmt-product-version-form-submit)",
                        function (data) {
                          var field = data.field; //获取提交的字段
                          field.productId = $("#productId").val();
                      
                          //提交 Ajax 成功后，关闭当前弹层并重载表格
                           admin.req({
                            url: prefix,
                            type: "post",
                            contentType: "application/json;charset=UTF-8",
                            data: JSON.stringify(field),
                            done: function (res) {
                              layer.msg("新增成功");
                              layui.table.reload(
                                "zkmes-productmgmt-product-form-table"
                              ); //重载表格
                              layer.close(index); //执行关闭
                            },
                          }); 
                       });
                    });
                },
              });
              break;
            case "delete":
              layer.msg("删除");
              break;
            case "update":
              layer.msg("编辑");
              break;
            case "LAYTABLE_TIPS":
              layer.msg("提示");
              break;
            case "refresh":
              layui.table.reloadData(
                "zkmes-productmgmt-product-form-table"
              ); //重载表格
              break;
          }
        }
      );

      $("input[name=status][value=0]").attr(
          "checked",
          params.status == 0 ? true : false
        );
        $("input[name=status][value=1]").attr(
          "checked",
          params.status == 1 ? true : false
        );
        
        form.render(null);
      
     
      
      util.on("lay-on", {
        design: function () {
          admin.popup({
            title: "产品设计资料",
            area: "1000px",
            offset: "100px",
            id: "popup-zkmes-productmgmt-product-designdata",
            success: function (layero, index) { 
              view(this.id)
                .render("zkmes/productmgmt/product/designdata")
                .done(function () {});
            },
          });
        },
      });

    
    });
  };

  layui.use(["admin", "form"], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      form = layui.form;
    
    
    ///////spec
    form.on("input-affix(searchSpec)", function (data) {
      admin.popup({
        title: "选择物料规格",
        area: ['100%', '100%'],
        id: "popup-zkmes-productmgmt-product-form-spec",
        success: function (layero, index) { 
          view(this.id)
            .render("zkmes/productmgmt/product/spec-form")
            .done(function () {
              form.render(null, "zkmes-productmgmt-product-spec-form");
              //提交
              form.on(
                "submit(zkmes-productmgmt-product-spec-form-submit)",
                function (data) {
                  var field = data.field; //获取提交的字段 
                  form.val("zkmes-productmgmt-product-form", field); s
                  layer.msg("选择成功");
                  layer.close(index); //执行关闭
                }
              );
            });
        },
      });
    });

    ///////model
    form.on("input-affix(searchModel)", function (data) {
      admin.popup({
        title: "选择物料型号",
        area: "1500px",
        offset: "110px",
        id: "popup-zkmes-productmgmt-product-form-model",
        success: function (layero, index) {
          view(this.id)
            .render("zkmes/productmgmt/product/model-form")
            .done(function () {
              form.render(null, "zkmes-productmgmt-product-model-form");
              //提交
              form.on(
                "submit(zkmes-productmgmt-product-model-form-submit)",
                function (data) {
                  var field = data.field; //获取提交的字段
                  form.val("zkmes-productmgmt-product-form", field); 
                  layer.msg("选择成功"); 
                  layer.close(index); //执行关闭
                }
              );
            });
        },
      });
    });

    ///////uom
    form.on("input-affix(searchUom)", function (data) {
      admin.popup({
        title: "选择单位",
        area: "1500px",
        offset: "110px",
        id: "popup-zkmes-productmgmt-product-form-uom",
        success: function (layero, index) {
          view(this.id)
            .render("zkmes/productmgmt/product/uom-form")
            .done(function () {
              form.render(null, "zkmes-productmgmt-product-uom-form");
              //提交
              form.on(
                "submit(zkmes-productmgmt-product-uom-form-submit)",
                function (data) {
                  var field = data.field; //获取提交的字段
                  form.val("zkmes-productmgmt-product-form", field); 
                  layer.msg("选择成功"); 
                  layer.close(index); //执行关闭
                }
              );
            });
        },
      });
    });

    ///////classify
    form.on("input-affix(searchClassify)", function (data) {
      admin.popup({
        title: "选择分类",
        area: "1500px",
        offset: "110px",
        id: "popup-zkmes-productmgmt-product-form-classify",
        success: function (layero, index) {
          view(this.id)
            .render("zkmes/productmgmt/product/classify-form")
            .done(function () {
              form.render(null, "zkmes-productmgmt-product-classify-form");
              //提交
              form.on(
                "submit(zkmes-productmgmt-product-classify-form-submit)",
                function (data) {
                  var field = data.field; //获取提交的字段
                  form.val("zkmes-productmgmt-product-form", field); 
                  layer.msg("选择成功"); 
                  layer.close(index); //执行关闭
                }
              );
            });
        },
      });
    });

    
    
    
  });
</script>
