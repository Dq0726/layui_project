<div class="layui-form" lay-filter="zkmes-invmgmt-outboundorder-out-form" style="padding: 10px 30px 0 0">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">出库产品编号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="outboundorderproductId"
            name="outboundorderproductId"
            placeholder="请输入"
            value="{{ d.params.outboundorderproductId || '' }}"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">出库单号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="outboundorderId"
            name="outboundorderId"
            placeholder="请输入"
            value="{{ d.params.outboundorderId || '' }}"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">物料编号</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="productId"
            name="productId"
            placeholder="请输入"
            value="{{ d.params.productId || '' }}"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">需求数量</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            id="outboundQty"
            name="outboundQty"
            placeholder="请输入"
            value="{{ d.params.outboundQty || '' }}"
            autocomplete="off"
            class="layui-input"
            readonly
          />
        </script>
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">已确认数量</label>
      <div class="layui-input-inline">
        <input type="text" id="cfmdQty" placeholder="请输入" autocomplete="off" class="layui-input" readonly />
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">待确认数量</label>
      <div class="layui-input-inline">
        <input type="text" id="tbcQty" placeholder="请输入" autocomplete="off" class="layui-input" readonly />
      </div>
    </div>
  </div>

  <div class="layui-form-item">
    <table
      id="zkmes-invmgmt-outboundorder-out-form-table"
      lay-filter="zkmes-invmgmt-outboundorder-out-form-table"
    ></table>
    <script type="text/html" id="zkmes-invmgmt-outboundorder-out-form-toolbar-head">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
    </script>
    <script type="text/html" id="zkmes-invmgmt-outboundorder-out-form-toolbar-row">

      {{# if(d.outboundorderproductStatus == 0){ }}
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"
        ><i class="layui-icon layui-icon-delete"></i>删除</a>
      {{# }else if(d.outboundorderproductStatus == 1){ }} 

      {{# if(d.status == 0){ }}
      <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="sync">同步</a>
     
      {{# }else if(d.status == 1){ }}
      <a class="layui-btn layui-btn-disabled layui-btn-xs">已同步</a>
      {{# }
			}
       }}
    </script>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-block">
      <script type="text/html" template>
        {{# if(d.params.status == 0){ }}
          <input type="button" id="outinv" lay-active="cfmd" value="确认出库信息" class="layui-btn layui-bg-blue" />
        {{# }else if(d.params.status == 1){ }}
 <input type="button" id="outinv" lay-active="cfmd" value="确认出库信息" class="layui-btn layui-bg-blue" />
          <input type="button" id="review" lay-active="review" value="出库审核" class="layui-btn layui-bg-blue" /> 
        {{# } }}
      </script>

      <input
        type="button"
        id="zkmes-invmgmt-outboundorder-out-form-submit"
        lay-submit
        lay-filter="zkmes-invmgmt-outboundorder-out-form-submit"
        class="layui-btn layui-hide"
      />
    </div>
  </div>
</div>

<script type="text/html" template lay-done="layui.data.sendZkmesInvmgmtOutboundorderOutFormParams(d.params)"></script>

<script>
  layui.data.sendZkmesInvmgmtOutboundorderOutFormParams = function (params) {
    layui.use(["admin", "form", "xmSelect"], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        table = layui.table,
        form = layui.form,
        xmSelect = layui.xmSelect;

      var prefix = "zkmes/invmgmt/outbatch";

      table.render({
        elem: "#zkmes-invmgmt-outboundorder-out-form-table",
        url: prefix + "/list",
        where: {
          outboundorderId: params.outboundorderId,
          productId: params.productId,
        },
        toolbar: "#zkmes-invmgmt-outboundorder-out-form-toolbar-head",
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-400",
        cols: [
          [
            { field: "outbatchId", title: "出库批次" },
            { field: "inbatchId", title: "库存批次" },
            { field: "productId", title: "物料编号" },
            { field: "productName", title: "物料名称" },
            { field: "supplierName", title: "供应商名称" },
            { field: "warehouseName", title: "仓库名称" },
            { field: "remainingQty", title: "库存数量" },
            {
              field: "outboundQty",
              title: "出库数量",
              edit: function (d) {
                if (d.outboundorderproductStatus == 0) {
                  return "text"; // 编辑模式
                }
              },
            },
            {
              field: "status",
              title: "状态",
              templet: function (res) {
                var html = "-";

                if (params.status == 0) {
                  html = '<span class="layui-badge layui-bg-blue">待确认出库信息</span>';
                } else if (params.status == 1) {
                  if (res.status == 0) {
                    html = '<span class="layui-badge layui-bg-blue">待出库</span>';
                  } else if (res.status == 1) {
                    html = '<span class="layui-badge layui-bg-green">已出库</span>';
                  }
                }

                return html;
              },
            },
            {
              title: "操作",
              align: "center",
              fixed: "right",
              toolbar: "#zkmes-invmgmt-outboundorder-out-form-toolbar-row",
            },
          ],
        ],
        done: function (res, curr, count) {
          //如果是异步请求数据方式，res即为你接口返回的信息。
          //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度

          var data = res.data;
          var outboundQty = 0;

          for (var i = 0; i < data.length; i++) {
            // 遍历数组，对每个元素进行操作
            outboundQty += data[i].outboundQty;
          }

          var tbcQty = parseFloat($("#outboundQty").val() - outboundQty).toFixed(2);
          if (tbcQty < 0) {
            layer.msg("超过需求数量,请检查");
          }

          $("#cfmdQty").val(parseFloat(outboundQty).toFixed(2));
          $("#tbcQty").val(tbcQty);

          // console.log(outboundQty);

          //得到当前页码
          // console.log(curr);

          //得到数据总量
          // console.log(count);
        },
      });

      // 单元格编辑后的事件
      table.on("edit(zkmes-invmgmt-outboundorder-out-form-table)", function (obj) {
        var field = obj.field; // 得到修改的字段
        var value = obj.value; // 得到修改后的值
        var oldValue = obj.oldValue; // 得到修改前的值 -- v2.8.0 新增
        var data = obj.data; // 得到所在行所有键值
        var col = obj.getCol(); // 得到当前列的表头配置属性 -- v2.8.0 新增

        // 值的校验
        if (value.replace(/\s/g, "") === "") {
          layer.tips("值不能为空", this, { tips: 1 });
          return obj.reedit(); // 重新编辑 -- v2.8.0 新增
        }
        // 编辑后续操作，如提交更新请求，以完成真实的数据更新
        // …
        // var amount = util.escape(value) * util.escape(data.outboundQty)

        var divQty = data.remainingQty - data.outboundQty;

        if (divQty < 0) {
          layer.msg("超过最大值");
          layui.table.reloadData("zkmes-invmgmt-outboundorder-out-form-table"); //重载表格
          return;
        }

        //  alert(data.remainingQty + "-" + data.outboundQty);

        var j = {
          outbatchId: data.outbatchId,
          outboundQty: data.outboundQty,
          //   unitPrice: data.unitPrice,
          //   amount: parseFloat(parseFloat(data.unitPrice) * parseFloat(data.outboundQty)).toFixed(2),
        };

        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
          url: prefix,
          type: "put",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(j),
          done: function (res) {
            //  layer.msg("修改成功");
            layui.table.reloadData("zkmes-invmgmt-outboundorder-out-form-table"); //重载表格
            layer.close(index); //执行关闭
          },
        });

        // 显示 - 仅用于演示
        // layer.msg('[ID: '+ data.purchaseorderId +'] ' + field + ' 字段更改值为：'+ util.escape(value));
      });

      //工具条
      table.on("tool(zkmes-invmgmt-outboundorder-out-form-table)", function (obj) {
        var data = obj.data;
        if (obj.event === "del") {
          layer.confirm("确定删除？", function (index) {
            admin.req({
              url: prefix + "/" + data.outbatchId,
              type: "delete",
              contentType: "application/json;charset=UTF-8",
              done: function (res) {
                layer.msg("删除成功");
                layui.table.reload("zkmes-invmgmt-outboundorder-out-form-table"); //重载表格
                layer.close(index); //执行关闭
              },
            });
          });
        } else if (obj.event === "sync") {
         /*  var j = {
            outboundorderproductId: data.outboundorderproductId,
            productId: data.productId,
            warehouseId: $('[name="warehouseId"]').val(),
            outboundQty: data.outboundQty,
          };
 */
          admin.req({
            url: prefix + "/sync",
            type: "post",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(data),
            done: function (res) {
              layer.alert(res.msg);
              layui.table.reloadData("zkmes-invmgmt-outboundorder-out-form-table"); //重载表格
            },
          });
        }
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-invmgmt-outboundorder-out-form-table)", function (obj) {
        switch (obj.event) {
          case "add":
            var data = {
              productId: $("#productId").val(),
            };

            admin.popup({
              title: "添加出库产品",
              area: "1500px",
              offset: "50px",
              id: "popup-zkmes-invmgmt-outboundorder-out-inbatch-form-add",
              success: function (layero, index) {
                view(this.id)
                  .render("zkmes/invmgmt/outboundorder/out/inbatch-form", data)
                  .done(function () {
                    form.render(null, "zkmes-invmgmt-outboundorder-out-inbatch-form");
                    //提交
                    form.on("submit(zkmes-invmgmt-outboundorder-out-inbatch-form-submit)", function (data) {
                      var field = data.field; //获取提交的字段

                      var tableData = table.getData("zkmes-invmgmt-outboundorder-out-form-table");

                      for (var i = 0; i < tableData.length; i++) {
                        if (tableData[i].inbatchId == field.inbatchId) {
                          layer.msg(tableData[i].inbatchId + "已选择，请重新选择。");
                          return;
                        }
                      }

                      field.outboundorderId = $("#outboundorderId").val();
                      field.outboundorderproductId = $("#outboundorderproductId").val();

                      //提交 Ajax 成功后，关闭当前弹层并重载表格
                      admin.req({
                        url: prefix,
                        type: "post",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(field),
                        done: function (res) {
                          layer.msg("新增成功");
                          layui.table.reload("zkmes-invmgmt-outboundorder-out-form-table"); //重载表格
                          layer.close(index); //执行关闭
                        },
                      });
                    });
                  });
              },
            });
            break;
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-invmgmt-outboundorder-out-form-table"); //重载表格
            break;
        }
      });

      form.render(null);
    });
  };

  layui.use(["admin", "form", "common"], function () {
    var $ = layui.$,
      util = layui.util,
      admin = layui.admin,
      common = layui.common,
      view = layui.view,
      table = layui.table,
      form = layui.form;

    //处理属性 为 lay-active 的所有元素事件
    util.event("lay-active", {
      cfmd: function (othis) {
        var tbcQty = $("#tbcQty").val();

        if (tbcQty != 0) {
          layer.msg("确认数量错误，请检查");
          return;
        }

        var tableData = table.getData("zkmes-invmgmt-outboundorder-out-form-table");
        
        var j = {
          outboundorderproductId: $("input[name='outboundorderproductId']").val(),
          status: 1,
          outbatchList: tableData
        };

        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
          url: "zkmes/invmgmt/outboundorder/product",
          type: "put",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(j),
          done: function (res) {
            layer.msg("修改成功");
          //  var submit = $("#zkmes-invmgmt-outboundorder-out-form-submit");
         //   submit.trigger("click");
          },
        });
      },
      review: function (othis) {},
    });
  });
</script>
