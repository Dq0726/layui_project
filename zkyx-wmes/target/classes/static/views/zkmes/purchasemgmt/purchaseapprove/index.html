<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>库存管理</cite></a>
    <a><cite>采购审批</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body">
      <!--    search start -->
      <div class="keySearch-cont" style="margin-bottom: 10px;">
        <div class="layui-inline">
          <input class="layui-input" name="keySearch-input" id="keySearch-input" autocomplete="off"
            placeholder="请输入关键字">
        </div>
        <button class="layui-btn" data-type="keySearch" lay-on="keySearch">搜索</button>
      </div>
      <!--    search end -->
      <table id="zkmes-purchasemgmt-purchaseapprove-table" lay-filter="zkmes-purchasemgmt-purchaseapprove-table"></table>

      <script type="text/html" id="zkmes-purchasemgmt-purchaseapprove-toolbar-head">
        <div class="layui-btn-container">
          <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
        </div>
      </script>

      <script type="text/html" id="zkmes-purchasemgmt-purchaseapprove-toolbar-row"> 
				{{# if(d.approveStatus == 9){ }}
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="approve"><i class="layui-icon layui-icon-edit"></i>审批</a> 
				{{# }else{ }}
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="detail"><i class="layui-icon layui-icon-edit"></i>详情</a>  
				{{# } }}


      </script>
    </div>
  </div>
</div>

<script>
  layui.use(["admin", "table", 'common', 'util'], function () {
    var $ = layui.$,
      admin = layui.admin,
      view = layui.view,
      table = layui.table,
      common = layui.common,
      util = layui.util, 
      form = layui.form;

    // 调用 common.js 模块 getPopupSize 函数，用 ES6 解构赋值获取返回的两个参数
    const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();

    var prefix = "zkmes/purchasemgmt/purchaseapprove";

    table.render({
      elem: "#zkmes-purchasemgmt-purchaseapprove-table",
      url: prefix + "/list",
      toolbar: "#zkmes-purchasemgmt-purchaseapprove-toolbar-head",
      page: true,
      defaultToolbar: [
        "filter",
        "print",
        "exports",
        {
          title: "提示",
          layEvent: "LAYTABLE_TIPS",
          icon: "layui-icon-tips",
        },
      ],
      height: "full-200",
      cols: [
        [
          { field: "purchaseorderId", title: "采购单号" },
          /* { field: "inboundorderId", title: "入库单号" }, */
          { field: "signingdate", title: "签订日期" },
          { field: "deliverydate", title: "交货日期" },
          { field: "supplierName", title: "供应商名称" }, 
          {
              field: 'approve', title: '审批状态', templet: function (res) {
                var html = res.approveStatus == 9 ? '<span class="layui-badge layui-bg-orange">待审批</span>' : '<span class="layui-badge layui-bg-blue">已审批</span>' ;
                return html;
              }
          }, 
          { field: "createTime", title: "创建时间" },
          {
            title: "操作",
            width: 120,
            align: "center",
            fixed: "right",
            toolbar: "#zkmes-purchasemgmt-purchaseapprove-toolbar-row",
          },
        ],
      ],
    });

    //工具条
    table.on("tool(zkmes-purchasemgmt-purchaseapprove-table)", function (obj) {
      var data = obj.data;
      if (obj.event === "approve") {
        admin.popup({
          title: "采购单审批",
          area: popupWidthHeight,
          offset: popupOffsetWidthHeight,
          id: "popup-zkmes-purchasemgmt-purchaseapprove-approve",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/purchasemgmt/purchaseapprove/form", data)
              .done(function () {
                form.render(null, "zkmes-purchasemgmt-purchaseapprove-form"); 
                //提交
                form.on("submit(zkmes-purchasemgmt-purchaseapprove-form-agree-submit)", function (data) {
                  var field = data.field; //获取提交的字段
                  var j = {
                		  purchaseorderId: field.purchaseorderId, 
                  		approveStatus: 0
                  };  
                  //提交 Ajax 成功后，关闭当前弹层并重载表格
                  admin.req({
                    url: prefix
                    , type: 'put'
                    , contentType: 'application/json;charset=UTF-8'
                    , data: JSON.stringify(j)
                    , done: function (res) {
                      layer.msg("修改成功");
                      layui.table.reload('zkmes-purchasemgmt-purchaseapprove-table'); //重载表格
                      layer.close(index); //执行关闭 
                    }
                  }); 
                });
                
              //提交
                form.on("submit(zkmes-purchasemgmt-purchaseapprove-form-disagree-submit)", function (data) {
                  var field = data.field; //获取提交的字段
                  var j = {
                		  purchaseorderId: field.purchaseorderId, 
                  		approveStatus: 1
                  };  
                  //提交 Ajax 成功后，关闭当前弹层并重载表格
                  admin.req({
                    url: prefix
                    , type: 'put'
                    , contentType: 'application/json;charset=UTF-8'
                    , data: JSON.stringify(j)
                    , done: function (res) {
                      layer.msg("修改成功");
                      layui.table.reload('zkmes-purchasemgmt-purchaseapprove-table'); //重载表格
                      layer.close(index); //执行关闭 
                    }
                  }); 
                });
              
              
              });
          },
        });
      }else if (obj.event === "detail") {
      	data.c_e = "detail";
      	
        admin.popup({
          title: "审批详情",
          area: popupWidthHeight,
          offset: popupOffsetWidthHeight,
          id: "popup-zkmes-purchasemgmt-purchaseapprove-detail",
          success: function (layero, index) {
            view(this.id)
              .render("zkmes/purchasemgmt/purchaseapprove/form", data)
              .done(function () {
                form.render(null, "zkmes-purchasemgmt-purchaseapprove-form"); 
                //提交
                form.on("submit(zkmes-purchasemgmt-purchaseapprove-form-close)", function (data) {
                  var field = data.field; //获取提交的字段
                  layer.close(index); //执行关闭 
                }); 
              });
          },
        });
      } 
    });
    //工具条
    table.on("toolbar(zkmes-purchasemgmt-purchaseapprove-table)", function (obj) {
      switch (obj.event) {
      case "add":
    	layer.msg("新增");
        break;
      case "delete":
        layer.msg("删除");
        break;
      case "update":
        layer.msg("编辑");
        break;
      case "LAYTABLE_TIPS":
        layer.msg("提示");
        break;
      case "refresh":
        layui.table.reloadData("zkmes-purchasemgmt-purchaseapprove-table"); //重载表格
        layer.msg('刷新成功');
        break;
    }
    });
    util.on("lay-on", {
        // 关键字搜索功能
    	keySearch: function () {
          var keySearchValue = $('#keySearch-input').val();
          // 重载表格，传递搜索参数
          table.reload('zkmes-purchasemgmt-purchaseapprove-table', {
            page: {
              curr: 1 // 从第一页开始
            },
            where: {
              searchValue: keySearchValue // 传递关键字参数到后端
            }
          });
        },
      });
  });
</script>