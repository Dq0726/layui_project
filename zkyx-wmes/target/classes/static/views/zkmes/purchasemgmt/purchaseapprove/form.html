<div class="layui-form" lay-filter="zkmes-purchasemgmt-purchaseapprove-form">
   
    <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">采购单号<span class="required">*</span></label>
      <div class="layui-input-inline">
        <div style="display: flex">
          <script type="text/html" template>
          <input
            type="text"
            id="purchaseorderId"
            name="purchaseorderId" 
            placeholder="请输入"
            value="{{ d.params.purchaseorderId || '' }}" 
            autocomplete="off"
            class="layui-input" 
            disabled
          />  
        </script>
        </div>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">签订日期</label>
      <div class="layui-input-inline"> 
      <script type="text/html" template>
          <input
            type="text" 
            name="signingdate" 
            placeholder="请输入"
            value="{{ d.params.signingdate || '' }}" 
            autocomplete="off"
            class="layui-input" 
            disabled
          />  
        </script> 
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">交货日期</label>
      <div class="layui-input-inline">
      <script type="text/html" template>
          <input
            type="text" 
            name="deliverydate" 
            placeholder="请输入"
            value="{{ d.params.deliverydate || '' }}" 
            autocomplete="off"
            class="layui-input" 
            disabled
          />  
        </script>  
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">供应商</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text" 
            placeholder="请选择"
            value="{{ d.params.supplierName || '' }}"
            name="supplierName" 
            class="layui-input"
            disabled
          /> 
          </script>
      </div>
    </div> 
  </div>
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">是否含税</label>
      <div class="layui-input-inline">
        <input type="checkbox" id="tax" name="tax" lay-skin="switch" lay-filter="tax-checkbox-filter" title="含税|不含税">
      </div>
    </div> 
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">备注</label>
    <div class="layui-input-block">
      <script type="text/html" template>
        <textarea type="text" name="remark" autocomplete="off" class="layui-textarea">{{ d.params.remark || '' }}</textarea>
      </script>
    </div>
  </div>
   
  <div class="layui-form-item">
    <table
      id="zkmes-purchasemgmt-purchaseapprove-form-table"
      lay-filter="zkmes-purchasemgmt-purchaseapprove-form-table"
    ></table> 
  </div>

  <script type="text/html" id="zkmes-purchasemgmt-purchaseapprove-form-toolbar-head">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
      </div>
  </script>
    
  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-block">
    <script type="text/html" template> 
      {{# if(d.params.c_e != "detail"){ }}
      <input
        type="button"
        id="zkmes-purchasemgmt-purchaseapprove-form-agree-submit"
        lay-submit
        lay-filter="zkmes-purchasemgmt-purchaseapprove-form-agree-submit"
        value="同意"
        class="layui-btn"
      />
      
      <input
        type="button"
        id="zkmes-purchasemgmt-purchaseapprove-form-disagree-submit"
        lay-submit
        lay-filter="zkmes-purchasemgmt-purchaseapprove-form-disagree-submit"
        value="拒绝"
        class="layui-btn"
      />
      {{# }else{ }}
      <input
        type="button"
        id="zkmes-purchasemgmt-purchaseapprove-form-close"
        lay-submit
        lay-filter="zkmes-purchasemgmt-purchaseapprove-form-close"
        value="关闭"
        class="layui-btn"
      />
      {{# } }}
     </script>
      
      
    
    </div>
  </div>
</div>

<script
  type="text/html"
  template
  lay-done="zkmesPurchasemgmtPurchaseapproveFormParamsDone(d.params)"
></script>

<script>

var title1 = [

  { type: 'numbers', title: '序号' },
  { field: "productId", title: "产品编码", width: 100 },
  { field: "productName", title: "产品名称" },
  { field: "modelName", title: "型号" },
  {
    field: "purchaseQty", title: "数量" 
  },
  { field: "uomName", title: "单位" },
  {
    field: "rot", title: "税率",
    templet: function (res) {
      var html = "-";

      if (res.rot == null) { 
      } else {
        html = '<span id="rot" >' + res.rot + '%</span> '; 
      }
      return html;
    }
  },
  {
    field: "unitPrice", title: "单价(不含税)",
    templet: function (res) {
      return Number(res.unitPrice).toFixed(2)
    } 
  },
  {
    field: "amount", width: 255, title: "价格(不含税)", align: "center",
    totalRow: '合计(不含税)：{{= Number(d.TOTAL_NUMS).toFixed(2) }}'
  },
  {
    field: "taxAmount", width: 255, title: "税额", align: "center",
    totalRow: '税额：{{=  Number(d.TOTAL_NUMS).toFixed(2) }}'
  },
  {
    title: "",
    align: "center",
    width: 255, 
    fixed: "right", 
    totalRow: '价税合计：{{=  d.TOTAL_ROW.total }}'
  },
];

var title2 = [
  { type: 'numbers', title: '序号' },
  { field: "productId", title: "产品编码", width: 100 },
  { field: "productName", title: "产品名称" },
  { field: "modelName", title: "型号" },
  {
    field: "purchaseQty", title: "数量" 
  },
  { field: "uomName", title: "单位" },
  {
    field: "rot", title: "税率",
    templet: function (res) {
      var html = "-";

      if (res.rot == null) { 
      } else {
        html = '<span id="rot" >' + res.rot + '%</span> ';
      }
      return html;
    }
  },
  {
    field: "unitPrice", title: "单价(含税)",
    templet: function (res) {
      return parseFloat(res.unitPrice).toFixed(2)
    } 
  },
  {
    field: "amount", width: 255, title: "价格(含税)", align: "center",
    totalRow: '合计(含税)：{{= Number(d.TOTAL_NUMS).toFixed(2) }}'
  },
  {
    field: "taxAmount", width: 255, title: "税额", align: "center",
    totalRow: '税额：{{=  Number(d.TOTAL_NUMS).toFixed(2) }}'
  },
  {
    title: "",
    align: "center",
    width: 255, 
    fixed: "right",
    totalRow: '价税合计：{{=  d.TOTAL_ROW.total }}'
  },
];


  zkmesPurchasemgmtPurchaseapproveFormParamsDone = function (params) {
	  layui.use(["admin", "form"], function () {
	      var $ = layui.$,
	        admin = layui.admin,
	        view = layui.view,
	        table = layui.table,
	        form = layui.form,
	        laydate = layui.laydate,
	        util = layui.util;

	      if (params.tax == null) {
	        params.tax = 1;
	      }
	        
	      form.val('zkmes-purchasemgmt-purchaseorder-form', {
	        "tax": params.tax == 0 ? true : false,
	      });
  
	    var title = params.tax == 0 ? title2 : title1;
	      
      var prefix = "zkmes/purchasemgmt/orderproduct";

      table.render({
        elem: "#zkmes-purchasemgmt-purchaseapprove-form-table",
        url: prefix + "/list1",
        toolbar: "#zkmes-purchasemgmt-purchaseapprove-form-toolbar-head",
        totalRow: true, // 开启合计行
        where: {
          orderId: $("#purchaseorderId").val() || '',
        },
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-400",
        cols: [title],
        parseData: function (res) { // res 即为原始返回的数据 

          res["totalRow"] = {};
          res["totalRow"]['total'] = 0.00;
          var total = 0.00;

          if ($("#tax").is(':checked')) {
            //未含税转含税
            res.data.forEach(function (item) {
              var tmpTaxrate = Number(item.rot);
              var tmpUnitPrice = Number(item.unitPrice);
              var tmpPurchaseQty = Number(item.purchaseQty);
              var tmpAmount = Number(item.amount);
              var tmpTaxAmount = Number(item.taxAmount);

              total += tmpAmount;
              total += tmpTaxAmount;

              var unitPrice = tmpUnitPrice * (100 + tmpTaxrate);
              var amount = unitPrice * item.purchaseQty
              var taxAmount = tmpUnitPrice * tmpTaxrate * item.purchaseQty

              item.unitPrice = Number(unitPrice / 10000.00).toFixed(2);
              item.amount = Number(amount / 10000.00).toFixed(2);
              item.taxAmount = Number(taxAmount / 10000.00).toFixed(2);

            });
            res["totalRow"]['total'] = Number(total / 100.0).toFixed(2);
          } else {
            //未含税 无需转换
            res.data.forEach(function (item) {
              var tmpTaxrate = Number(item.rot);
              var tmpUnitPrice = Number(item.unitPrice);
              var tmpPurchaseQty = Number(item.purchaseQty);
              var tmpAmount = Number(item.amount);
              var tmpTaxAmount = Number(item.taxAmount);

              total += tmpAmount;
              total += tmpTaxAmount;

              item.unitPrice = Number(tmpUnitPrice / 100.00).toFixed(2);
              item.amount = Number(tmpAmount / 100.00).toFixed(2);
              item.taxAmount = Number(tmpTaxAmount / 100.00).toFixed(2);


            });
            res["totalRow"]['total'] = Number(total / 100.0).toFixed(2);
          }

          return {
            "code": res.code, // 解析接口状态
            "msg": res.message, // 解析提示文本
            "count": res.data.length, // 解析数据长度
            "data": res.data, // 解析数据列表
            "totalRow": res.totalRow // 解析数据列表
          };
        },
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-purchasemgmt-purchaseapprove-form-table)", function (obj) {
        switch (obj.event) {
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-purchasemgmt-purchaseapprove-form-table"); //重载表格
            break;
        }
      });
 
      form.render(null);
    });
  };

  layui.use(["admin", "form", "common"], function () {
    var $ = layui.$,
      util = layui.util,
      admin = layui.admin,
      common = layui.common,
      view = layui.view,
      table = layui.table,
      form = layui.form;
    
    form.on('switch(tax-checkbox-filter)', function (data) {

   
      //0含税 1不含税
      var value = data.elem.checked ? 0 : 1;
 
      var j = {
        purchaseorderId: $("#purchaseorderId").val(), 
        tax: value
      };

      //提交 Ajax 成功后，关闭当前弹层并重载表格
      admin.req({
        url: "zkmes/purchasemgmt/purchaseorder",
        type: "put",
        async: false,
        contentType: "application/json;charset=UTF-8",
        data: JSON.stringify(j),
        done: function (res) {

        },
      });

      if (value == 0) {
        table.reload("zkmes-purchasemgmt-purchaseapprove-form-table", {
          cols: [title2]
        }); //重载表格   
      } else if (value == 1) {
        table.reload("zkmes-purchasemgmt-purchaseapprove-form-table", {
          cols: [title1]
        }); //重载表格   
      }
    });
    
  });
</script>
