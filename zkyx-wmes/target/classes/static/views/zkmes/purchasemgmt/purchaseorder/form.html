<div class="layui-form" lay-filter="zkmes-purchasemgmt-purchaseorder-form">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">采购单号<span class="required">*</span></label>
      <div class="layui-input-inline">
        <div style="display: flex">
          <script type="text/html" template>
          <input
            type="text"
            id="purchaseorderId"
            name="purchaseorderId" 
            placeholder="请输入"
            value="{{ d.params.purchaseorderId || '' }}" 
            autocomplete="off"
            class="layui-input" 
				    disabled
          />
					{{# if( d.params.purchaseorderId == null || d.params.purchaseorderId == ''){ }} 
			    <button type="button" class="layui-btn" lay-on="generate">生成</button>
					{{# } }}  
        </script>
        </div>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">签订日期</label>
      <div class="layui-input-inline">
        <input type="text" id="ID-laydate-signingdate" placeholder="请输入" name="signingdate" autocomplete="off"
          class="layui-input" />
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">交货日期</label>
      <div class="layui-input-inline">
        <input type="text" id="ID-laydate-deliverydate" placeholder="请输入" name="deliverydate" autocomplete="off"
          class="layui-input" />
      </div>
    </div>

    <div class="layui-inline">
      <label class="layui-form-label">供应商</label>
      <div class="layui-input-inline">
        <script type="text/html" template>
          <input
            type="text"
            lay-affix="search"
            lay-filter="searchSupplier" 
            placeholder="请选择"
            value="{{ d.params.supplierName || '' }}"
            name="supplierName"
            lay-options="{split: true}"
            class="layui-input"
 						readonly
          />
 					<input
            type="text"  
            readonly
            placeholder="请选择"
            value="{{ d.params.supplierId|| '' }}"
            name="supplierId" 
            class="layui-input layui-hide"
        	/> 
          </script>
      </div>
    </div> 
  </div>
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">是否含税</label>
      <div class="layui-input-inline">
        <input type="checkbox" id="tax" name="tax" lay-skin="switch" lay-filter="tax-checkbox-filter" title="含税|不含税">
      </div>
    </div> 
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">备注</label>
    <div class="layui-input-block">
      <script type="text/html" template>
        <textarea type="text" name="remark" autocomplete="off" class="layui-textarea">{{ d.params.remark || '' }}</textarea>
      </script>
    </div>
  </div>


  <div class="layui-form-item">
    <table id="zkmes-purchasemgmt-purchaseorder-form-table" lay-filter="zkmes-purchasemgmt-purchaseorder-form-table">
    </table>
  </div>


  <script type="text/html" id="zkmes-purchasemgmt-purchaseorder-form-toolbar-head">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
    <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>
  </div>
  </script>

  <script type="text/html" id="zkmes-purchasemgmt-purchaseorder-form-toolbar-row">
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">
   <i class="layui-icon layui-icon-delete"></i>删除</a>
  </script>

  <div class="layui-form-item">
    <label class="layui-form-label"></label>
    <div class="layui-input-inline">
    <script type="text/html" template> 
			{{# if(d.params.c_e != "detail"){ }}
 			<button type="submit" class="layui-btn" lay-submit
        lay-filter="zkmes-purchasemgmt-purchaseorder-form-submit">确认</button>
      <button type="submit" class="layui-btn layui-btn-primary" lay-submit
        lay-filter="zkmes-purchasemgmt-purchaseorder-form-close">关闭</button>
			{{# }else{ }}
     	<button type="submit" class="layui-btn layui-btn-primary" lay-submit
        lay-filter="zkmes-purchasemgmt-purchaseorder-form-close">关闭</button>
		  {{# } }}
 		 </script>
    </div>
  </div>
</div>

<script type="text/html" template lay-done="zkmesPurchasemgmtPurchaseorderFormParamsDone(d.params)"></script>

<script>

  var title1 = [

    { type: 'numbers', title: '序号' },
    { field: "productId", title: "产品编码", width: 100 },
    { field: "productName", title: "产品名称" },
    { field: "modelName", title: "型号" },
    {
      field: "purchaseQty", title: "数量",
      edit: function (d) {
        if (d.rot != null && d.rot != '') {
          return "text"; // 编辑模式
        }
      }
    },
    { field: "uomName", title: "单位" },
    {
      field: "rot", title: "税率",
      templet: function (res) {
        var html = "-";

        if (res.rot == null) {
          html = '<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="select">选择</a> ';
        } else {
          html = '<span id="rot" >' + res.rot + '%</span> '   +
          '<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="select">选择</a> ';  
        }
        return html;
      }
    },
    {
      field: "unitPrice", title: "单价(不含税)",
      templet: function (res) {
        return Number(res.unitPrice).toFixed(2)
      },
      edit: function (d) {
        if (d.rot != null && d.rot != '') {
          return "text"; // 编辑模式
        }
      }
    },
    {
      field: "amount", width: 255, title: "价格(不含税)", align: "center",
      totalRow: '合计(不含税)：{{= Number(d.TOTAL_NUMS).toFixed(2) }}'
    },
    {
      field: "taxAmount", width: 255, title: "税额", align: "center",
      totalRow: '税额：{{=  Number(d.TOTAL_NUMS).toFixed(2) }}'
    },
    {
      title: "操作",
      align: "center",
      width: 255, 
      fixed: "right",
      toolbar: "#zkmes-purchasemgmt-purchaseorder-form-toolbar-row",
      totalRow: '价税合计：{{=  d.TOTAL_ROW.total }}'
    },
  ];

  var title2 = [
    { type: 'numbers', title: '序号' },
    { field: "productId", title: "产品编码", width: 100 },
    { field: "productName", title: "产品名称" },
    { field: "modelName", title: "型号" },
    {
      field: "purchaseQty", title: "数量",
      edit: function (d) {
        if (d.rot != null && d.rot != '') {
          return "text"; // 编辑模式
        }
      }
    },
    { field: "uomName", title: "单位" },
    {
      field: "rot", title: "税率",
      templet: function (res) {
        var html = "-";

        if (res.rot == null) {
          html = '<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="select">选择</a> ';
        } else {
          html = '<span id="rot" >' + res.rot + '%</span> ';
        }
        return html;
      }
    },
    {
      field: "unitPrice", title: "单价(含税)",
      templet: function (res) {
        return parseFloat(res.unitPrice).toFixed(2)
      },
      edit: function (d) {
        if (d.rot != null && d.rot != '') {
          return "text"; // 编辑模式
        }
      }
    },
    {
      field: "amount", width: 255, title: "价格(含税)", align: "center",
      totalRow: '合计(含税)：{{= Number(d.TOTAL_NUMS).toFixed(2) }}'
    },
    {
      field: "taxAmount", width: 255, title: "税额", align: "center",
      totalRow: '税额：{{=  Number(d.TOTAL_NUMS).toFixed(2) }}'
    },
    {
      title: "操作",
      align: "center",
      width: 255, 
      fixed: "right",
      toolbar: "#zkmes-purchasemgmt-purchaseorder-form-toolbar-row",
      totalRow: '价税合计：{{=  d.TOTAL_ROW.total }}'
    },
  ];


  zkmesPurchasemgmtPurchaseorderFormParamsDone = function (params) {
    layui.use(["admin", "form", 'common'], function () {
      var $ = layui.$,
        admin = layui.admin,
        view = layui.view,
        table = layui.table,
        form = layui.form,
        laydate = layui.laydate,
        util = layui.util,
        common = layui.common;

      // 调用 common.js 模块 getPopupSize 函数，用 ES6 解构赋值获取返回的两个参数
      const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();

      if (params.tax == null) {
        params.tax = 1;
      }
        
      form.val('zkmes-purchasemgmt-purchaseorder-form', {
        "tax": params.tax == 0 ? true : false,
      });

      laydate.render({
        elem: "#ID-laydate-signingdate",
        type: "datetime",
        value: params.signingdate || '',
        fullPanel: true,
      });

      laydate.render({
        elem: "#ID-laydate-deliverydate",
        type: "datetime",
        value: params.deliverydate || '',
        fullPanel: true,
      });

      var title = params.tax == 0 ? title2 : title1;

      var prefix = "zkmes/purchasemgmt/orderproduct";

      table.render({
        elem: "#zkmes-purchasemgmt-purchaseorder-form-table",
        url: prefix + "/list1",
        totalRow: true, // 开启合计行
        where: {
          orderId: $("#purchaseorderId").val() || '',
        },
        toolbar: "#zkmes-purchasemgmt-purchaseorder-form-toolbar-head",
        defaultToolbar: [
          "filter",
          "print",
          "exports",
          {
            title: "提示",
            layEvent: "LAYTABLE_TIPS",
            icon: "layui-icon-tips",
          },
        ],
        height: "full-400",
        cols: [title],
        parseData: function (res) { // res 即为原始返回的数据 

          res["totalRow"] = {};
          res["totalRow"]['total'] = 0.00;
          var total = 0.00;

          if ($("#tax").is(':checked')) {
            //未含税转含税
            res.data.forEach(function (item) {
              var tmpTaxrate = Number(item.rot);
              var tmpUnitPrice = Number(item.unitPrice);
              var tmpPurchaseQty = Number(item.purchaseQty);
              var tmpAmount = Number(item.amount);
              var tmpTaxAmount = Number(item.taxAmount);

              total += tmpAmount;
              total += tmpTaxAmount;

              var unitPrice = tmpUnitPrice * (100 + tmpTaxrate);
              var amount = unitPrice * item.purchaseQty
              var taxAmount = tmpUnitPrice * tmpTaxrate * item.purchaseQty

              item.unitPrice = Number(unitPrice / 10000.00).toFixed(2);
              item.amount = Number(amount / 10000.00).toFixed(2);
              item.taxAmount = Number(taxAmount / 10000.00).toFixed(2);

            });
            res["totalRow"]['total'] = Number(total / 100.0).toFixed(2);
          } else {
            //未含税 无需转换
            res.data.forEach(function (item) {
              var tmpTaxrate = Number(item.rot);
              var tmpUnitPrice = Number(item.unitPrice);
              var tmpPurchaseQty = Number(item.purchaseQty);
              var tmpAmount = Number(item.amount);
              var tmpTaxAmount = Number(item.taxAmount);

              total += tmpAmount;
              total += tmpTaxAmount;

              item.unitPrice = Number(tmpUnitPrice / 100.00).toFixed(2);
              item.amount = Number(tmpAmount / 100.00).toFixed(2);
              item.taxAmount = Number(tmpTaxAmount / 100.00).toFixed(2);


            });
            res["totalRow"]['total'] = Number(total / 100.0).toFixed(2);
          }

          return {
            "code": res.code, // 解析接口状态
            "msg": res.message, // 解析提示文本
            "count": res.data.length, // 解析数据长度
            "data": res.data, // 解析数据列表
            "totalRow": res.totalRow // 解析数据列表
          };
        },
      });

      // 单元格编辑后的事件
      table.on("edit(zkmes-purchasemgmt-purchaseorder-form-table)", function (obj) {
        var data = obj.data; // 得到所在行所有键值 

        var unitPrice = 0; //需要处理成未含税单价 单位分
        var amount = 0;  //需要处理成未含税价格 单位分
        var taxAmount = 0; //需要计算出税额 单位分

        //需要统一处理成未含税价 存入数据库
        if ($("#tax").is(':checked')) {
          //当含税 作以下处理	
          //转换成分
          var tmpUnitPrice = data.unitPrice * 100;
          //转成未税单价
          unitPrice = tmpUnitPrice / (1 + data.rot / 100.0);
          amount = unitPrice * Number(data.purchaseQty);
          taxAmount = amount * ((data.rot) / 100.0);
        } else {
          //当不含税 作以下处理
          unitPrice = data.unitPrice * 100;
          amount = unitPrice * Number(data.purchaseQty);
          taxAmount = amount * ((data.rot) / 100.0);
        }

        var j = {
          orderproductId: data.orderproductId,
          purchaseQty: data.purchaseQty,
          unitPrice: unitPrice.toFixed(),
          amount: amount.toFixed(),
          taxAmount: taxAmount.toFixed()
        };


        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
          url: prefix,
          type: "put",
          contentType: "application/json;charset=UTF-8",
          data: JSON.stringify(j),
          done: function (res) {
            //执行重载
            table.reloadData("zkmes-purchasemgmt-purchaseorder-form-table");
          },
        });
      });

      //工具条
      table.on("tool(zkmes-purchasemgmt-purchaseorder-form-table)", function (obj) {
        var data = obj.data;

        switch (obj.event) {
          case "select":
            admin.popup({
              title: "选择税率信息",
              area: "1500px",
              offset: "110px",
              id: "popup-zkmes-purchasemgmt-purchaseorder-form-rot",
              success: function (layero, index) {
                view(this.id)
                  .render("zkmes/dialog/rotselect-form")
                  .done(function () {
                    form.render(null, "zkmes-dialog-rotselect-form");
                    //提交
                    form.on("submit(zkmes-dialog-rotselect-form-submit)", function (d) {
                      var field = d.field; //获取提交的字段 

 							 				var j = {}
                      
                      if ($("#tax").is(':checked')) {
                      	  j = {
                            orderproductId: data.orderproductId,
                            rotId: field.rotId
                          }
                      } else {
                      	 unitPrice = data.unitPrice * 100;
                         amount = unitPrice * Number(data.purchaseQty);
                         taxAmount = amount * ((field.rot) / 100.0);
                         
                         j = {
                             orderproductId: data.orderproductId,
                             rotId: field.rotId,
                             unitPrice: unitPrice,
                             amount: amount,
                             taxAmount: taxAmount 
                           } 
                      }
                        

                      //提交 Ajax 成功后，关闭当前弹层并重载表格
                      admin.req({
                        url: prefix,
                        type: "put",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(j),
                        done: function (res) {
                          layer.msg("选择成功");
                          layui.table.reload("zkmes-purchasemgmt-purchaseorder-form-table"); //重载表格
                          layer.close(index); //执行关闭
                        },
                      });
                    });
                  });
              },
            });
            break;
          case "del":
            layer.confirm("确定删除？", function (index) {
              admin.req({
                url: prefix + "/" + data.orderproductId,
                type: "delete",
                contentType: "application/json;charset=UTF-8",
                done: function (res) {
                  layer.msg("删除成功");
                  //执行重载
                  table.reloadData("zkmes-purchasemgmt-purchaseorder-form-table");
                  layer.close(index); //执行关闭
                },
              });
            });
            break;
        }
      });

      // 头部工具栏点击事件
      table.on("toolbar(zkmes-purchasemgmt-purchaseorder-form-table)", function (obj) {
        var data = obj.data;
        switch (obj.event) {
          case "add":
            orderId = $("#purchaseorderId").val()
            if (orderId == null || orderId == '') {
              layer.alert("请生成采购订单", { offset: "t" });
              return;
            }

            admin.popup({
              title: "添加采购产品信息",
              area: popupWidthHeight,
              offset: popupOffsetWidthHeight,
              id: "popup-zkmes-purchasemgmt-purchaseorder-form-add",
              success: function (layero, index) {
                view(this.id)
                  .render("zkmes/dialog/productselect-form")
                  .done(function () {
                    form.render(null, "zkmes-dialog-productselect-form");
                    //提交
                    form.on("submit(zkmes-dialog-productselect-form-submit)", function (data) {
                      var field = data.field; //获取提交的字段

                      field.orderId = $("#purchaseorderId").val();

                      //提交 Ajax 成功后，关闭当前弹层并重载表格
                      admin.req({
                        url: prefix,
                        type: "post",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(field),
                        done: function (res) {
                          layer.msg("新增成功");
                          //执行重载
                          table.reloadData("zkmes-purchasemgmt-purchaseorder-form-table");
                          layer.close(index); //执行关闭
                        },
                      });
                    });
                  });
              },
            });
            break;
          case "delete":
            layer.msg("删除");
            break;
          case "update":
            layer.msg("编辑");
            break;
          case "LAYTABLE_TIPS":
            layer.msg("提示");
            break;
          case "refresh":
            layui.table.reloadData("zkmes-purchasemgmt-purchaseorder-form-table"); //重载表格
            break;
        }
      });


      form.render(null);
    });
  };

  layui.use(["admin", "form", "common"], function () {
    var $ = layui.$,
      util = layui.util,
      admin = layui.admin,
      common = layui.common,
      view = layui.view,
      laydate = layui.laydate,
      table = layui.table,
      form = layui.form;
 
    
 // 调用 common.js 模块 getPopupSize 函数，用 ES6 解构赋值获取返回的两个参数
    const { popupWidthHeight, popupOffsetWidthHeight } = common.getPopupSize();
    
    // 普通事件
    util.on("lay-on", {
      // 生成订单号
      generate: function (othis) {
        //提交 Ajax 成功后，关闭当前弹层并重载表格
        admin.req({
          url: "zkmes/purchasemgmt/purchaseorder",
          type: "post",
          contentType: "application/json;charset=UTF-8",
          done: function (res) {
            form.val('zkmes-purchasemgmt-purchaseorder-form', res.data);
            table.reloadData("zkmes-purchasemgmt-purchaseorder-form-table");
            layer.msg("生成成功");
          },
        });
      },
    });

    form.on('switch(tax-checkbox-filter)', function (data) {

      //0含税 1不含税
      var value = data.elem.checked ? 0 : 1;

      var j = {
        purchaseorderId: $("#purchaseorderId").val(), 
        tax: value
      };

      //提交 Ajax 成功后，关闭当前弹层并重载表格
      admin.req({
        url: "zkmes/purchasemgmt/purchaseorder",
        type: "put",
        async: false,
        contentType: "application/json;charset=UTF-8",
        data: JSON.stringify(j),
        done: function (res) {

        },
      });

      if (value == 0) {
        table.reload("zkmes-purchasemgmt-purchaseorder-form-table", {
          cols: [title2]
        }); //重载表格   
      } else if (value == 1) {
        table.reload("zkmes-purchasemgmt-purchaseorder-form-table", {
          cols: [title1]
        }); //重载表格   
      }
    });
 
    form.on("input-affix(searchSupplier)", function (data) {
      admin.popup({
        title: "选择供应商",
        area: popupWidthHeight,
        offset: popupOffsetWidthHeight,
        id: "popup-zkmes-purchasemgmt-purchaseorder-form-supplier",
        success: function (layero, index) {
          view(this.id)
            .render("zkmes/dialog/supplierselect-form")
            .done(function () {
              form.render(null, "zkmes-dialog-supplierselect-form");
              //提交
              form.on(
                "submit(zkmes-dialog-supplierselect-form-submit)",
                function (data) {
                  var field = data.field; //获取提交的字段
                  form.val("zkmes-purchasemgmt-purchaseorder-form", field);
                  layer.msg("选择成功");
                  layer.close(index); //执行关闭
                }
              );
            });
        },
      });
    });
  });
</script>